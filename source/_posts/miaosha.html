<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="tags" content="">
<meta name="category" content="[项目流程]">
<meta name="date" content="2018-10-16 21:18:11"><style>body {
  max-width: 980px;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 45px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAABE0AA8AAAAAHWwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABWAAAADsAAABUIIslek9TLzIAAAGUAAAAQwAAAFY3d1HZY21hcAAAAdgAAACqAAACOvWLi0FjdnQgAAAChAAAABMAAAAgBtX/BGZwZ20AAAKYAAAFkAAAC3CKkZBZZ2FzcAAACCgAAAAIAAAACAAAABBnbHlmAAAIMAAABdQAAAjkYT9TNWhlYWQAAA4EAAAAMwAAADYQ6WvNaGhlYQAADjgAAAAfAAAAJAc6A1pobXR4AAAOWAAAACAAAAA0Kmz/7mxvY2EAAA54AAAAHAAAABwQPBJubWF4cAAADpQAAAAgAAAAIAEHC/NuYW1lAAAOtAAAAYQAAALxhQT4h3Bvc3QAABA4AAAAfgAAAMS3SYh9cHJlcAAAELgAAAB6AAAAhuVBK7x4nGNgZGBg4GIwYLBjYHJx8wlh4MtJLMljkGJgYYAAkDwymzEnMz2RgQPGA8qxgGkOIGaDiAIAJjsFSAB4nGNgZHZmnMDAysDAVMW0h4GBoQdCMz5gMGRkAooysDIzYAUBaa4pDA4Pwz+yMwf9z2KIYg5imAYUZgTJAQDcoQvQAHic7ZHNDYJAFIRnBXf94cDRIiyCKkCpwFCPJ092RcKNDoYKcN4+EmMPvpdvk539zQyAPYBCXEUJhBcCrJ5SQ9YLnLJe4qF5rdb+uWPDngNHTkta101pNyWa8lMhn6xx2dqUnW4q9YOIhAOOeueMSgsR/6ry+P7O5s6xVNg4chBsHUuFnWNJ8uZYwrw7chrsHXkODo7cB0dHOYCTY8kv0VE2WJKD6gOlWjsxAAB4nGNgQAMSEMgc9D8LhAESbAPdAHicrVZpd9NGFB15SZyELCULLWphxMRpsEYmbMGACUGyYyBdnK2VoIsUO+m+8Ynf4F/zZNpz6Dd+Wu8bLySQtOdwmpOjd+fN1czbZRJaktgL65GUmy/F1NYmjew8CemGTctRfCg7eyFlisnfBVEQrZbatx2HREQiULWusEQQ+x5ZmmR86FFGy7akV03KLT3pLlvjQb1V334aOsqxO6GkZjN0aD2yJVUYVaJIpj1S0qZlqPorSSu8v8LMV81QwohOImm8GcbQSN4bZ7TKaDW24yiKbLLcKFIkmuFBFHmU1RLn5IoJDMoHzZDyyqcR5cP8iKzYo5xWsEu20/y+L3mndzk/sV9vUbbkQB/Ijuzg7HQlX4RbW2HctJPtKFQRdtd3QmzZ7FT/Zo/ymkYDtysyvdCMYKl8hRArP6HM/iFZLZxP+ZJHo1qykRNB62VO7Es+gdbjiClxzRhZ0N3RCRHU/ZIzDPaYPh788d4plgsTAngcy3pHJZwIEylhczRJ2jByYCVliyqp9a6YOOV1WsRbwn7t2tGXzmjjUHdiPFsPHVs5UcnxaFKnmUyd2knNoykNopR0JnjMrwMoP6JJXm1jNYmVR9M4ZsaERCICLdxLU0EsO7GkKQTNoxm9uRumuXYtWqTJA/Xco/f05la4udNT2g70s0Z/VqdiOtgL0+lp5C/xadrlIkXp+ukZfkziQdYCMpEtNsOUgwdv/Q7Sy9eWHIXXBtju7fMrqH3WRPCkAfsb0B5P1SkJTIWYVYhWQGKta1mWydWsFqnI1HdDmla+rNMEinIcF8e+jHH9XzMzlpgSvt+J07MjLj1z7UsI0xx8m3U9mtepxXIBcWZ5TqdZlu/rNMfyA53mWZ7X6QhLW6ejLD/UaYHlRzodY3lBC5p038GQizDkAg6QMISlA0NYXoIhLBUMYbkIQ1gWYQjLJRjC8mMYwnIZhrC8rGXV1FNJ49qZWAZsQmBijh65zEXlaiq5VEK7aFRqQ54SbpVUFM+qf2WgXjzyhjmwFkiXyJpfMc6Vj0bl+NYVLW8aO1fAsepvH472OfFS1ouFPwX/1dZUJb1izcOTq/Abhp5sJ6o2qXh0TZfPVT26/l9UVFgL9BtIhVgoyrJscGcihI86nYZqoJVDzGzMPLTrdcuan8P9NzFCFlD9+DcUGgvcg05ZSVnt4KzV19uy3DuDcjgTLEkxN/P6VvgiI7PSfpFZyp6PfB5wBYxKZdhqA60VvNknMQ+Z3iTPBHFbUTZI2tjOBIkNHPOAefOdBCZh6qoN5E7hhg34BWFuwXknXKJ6oyyH7kXs8yik/Fun4kT2qGiMwLPZG2Gv70LKb3EMJDT5pX4MVBWhqRg1FdA0Um6oBl/G2bptQsYO9CMqdsOyrOLDxxb3lZJtGYR8pIjVo6Of1l6iTqrcfmYUl++dvgXBIDUxf3vfdHGQyrtayTJHbQNTtxqVU9eaQ+NVh+rmUfW94+wTOWuabronHnpf06rbwcVcLLD2bQ7SUiYX1PVhhQ2iy8WlUOplNEnvuAcYFhjQ71CKjf+r+th8nitVhdFxJN9O1LfR52AM/A/Yf0f1A9D3Y+hyDS7P95oTn2704WyZrqIX66foNzBrrblZugbc0HQD4iFHrY64yg18pwZxeqS5HOkh4GPdFeIBwCaAxeAT3bWM5lMAo/mMOT7A58xh0GQOgy3mMNhmzhrADnMY7DKHwR5zGHzBnHWAL5nDIGQOg4g5DJ4wJwB4yhwGXzGHwdfMYfANc+4DfMscBjFzGCTMYbCv6dYwzC1e0F2gtkFVoANTT1jcw+JQU2XI/o4Xhv29Qcz+wSCm/qjp9pD6Ey8M9WeDmPqLQUz9VdOdIfU3Xhjq7wYx9Q+DmPpMvxjLZQa/jHyXCgeUXWw+5++J9w/bxUC5AAEAAf//AA94nIVVX2hbZRQ/5/t7893s5ja9f7ouzdZ0TTqz3bRJmogbWya6bG6Cq0VbSV2ddIJjFtfIQHEig80Hda8yUN/0YQz8AyriiyD+xQd92R4HCnaCb3samnpumrpsCsLlfPf7zvedc37nL3CAtc/5W/wQZGA3tOBSY/g+TMjHmwzEoM1Q8+ZjRZY4oJhmBw5/YB6Za0yC5AkhlwA1A1yCBIBOwCII0Cj0U8BAMdUCzq05sKwkP7SlUY6fcJk4Fb/RyE79/6P5hjM/F4aZiXBoeMgzcqQ4Xi1hPqfDLG5FT+lchCVU3lYMyvuwhl1mqndQL0RsuloLywHtthLXI06OblTrhfWVnpSJ5+mwu/JdbtuN3IAnkW0LLMcRwaC7ktrlzridM6kVdyf9uO1UNBByI7JhwtG2sEwab07ORBeilWhqavJCqV0qzZTOl/7ZXQ5TbTcdcFelyGhhRDAQpdqp1FEX3w3cFTc1k9pJQkmm4ySCbSikxRP2QOfN+0tHS5MrpQuTU1Mk5nw0E5Xa0WvrOwDyGax9yB9ma6DAg82wHc43SAGTI4GjBWebOePAERFE8/AHaQpZASSTy8A4WwZiLQMQ82mFKATO0ILicRAoDm9p5P99E5b/fXG+kQYY3TYUuqmERWYoT0u/GNYL2q/4WB3LaVS+VynXsVYIcWw6DkCh3nX1D+VzlYN4LClF5yexSQos8exqZ3KVP+wtrC54u4Nznq6cq+xpMpUUnZ8FUYzE86ud0g28NOIv3Gj5/rmA3ABs7S/ywzFuQ4qyd6QxfNtiQIaEgp3w/entQg4Vcbqa16M5FfpeUB8t1+qeg7mI7cUyOe79wOk86gSxkVec4KPTX69++5x68Yubn5/F+w52z7u08sJX7fZXv8ekT/d2mILJxq6sn+SC6qEJknzLJCxyZEKwWVqYmAPBxBE/9DLeZiWHu7lcr/VytrCRuHojncNuTt9h46tmacmYisnSamdN2bZptcsmSysdVsy1PrOvOzF3xN64Rb937t/og9KHxYdcjIUqFAmIAHGHNzlns+RTPgeUYAQm9DwpNxfxbhhBHPaw3/gfTcXO2L+eJVIx5nsyGkvm9X4/f+bGkH45G0PaSjcMXTjcZyTvi3UdHoCDjQd3IDUVsgwYmUoJK/gp4JJxeRI0MKHZIkgynyIBqBTOUs6rOVCojvjZ4mCQz49ZMlMcp8QoYk6NoBfsxnJtsBohpa8iGJS+ZH7gU7NxME6cmF+t7cO9vB8d3jTWSct0ycW9ranXmolNDwmVkNnxe+8JtoztwS5rKJ0xWS95tQ/1zMYzg69MzUZnNtl1ofNbsml/OJm6f9wjRjpnu2o4MzHzn77IQkRd+1DjwMQ2pqSjGMMhyjrgTbBAKksuUm0iU7hI0aN2wOKOq7WYBSH0HGihj/jkiPxAfmwsEbfYrjMG+j3ij932Db/LV7I/xruNrhnroxjR9HRMb2nTvO0ZXOoHPk8H2ZhDPx93qcE/53sH5np/dkIP7zzhTVKdR/BAY/9ElkkR+A6lJGsqpJ4oQcTxpvBT3Kn58VkaJjgHyPEIws57xkaHh9KuVpDEpJZeMbZ5w/zBHi5NMQ4r5VphsFqID7TyB9eR4pX216c3AHxpdAwoqU9qg0ZJ6yVLKmMSz1iG2z27ifx18NkY0LPx1W/wCc2l5LrznrIsiKsqbmB78A9wIGx4tI8rjihVHJyY9pgMirenVq0yWg7Iw7eogG7ZgYM3qR9959A/fZkg6MnD/exlkmc+jWV4SB15XUR+eqC6l6ZmgPtN9z5JMfik05OV8ljylunJ4J+wA/FUaQSSKotsYsCWqaPBidBLcxkWx7XKFRIb45TGaEhjlF9uUVPqXOtcIwsXbBvfoZXIyRYFdkfnqjExH98xpnPczqzjX/uNdO1Y17Wpi5+6Ts8BXtjVFasp9KZ1mOiNbH65c5w6HgmyF2jFCZywM8mWjRc7T5Pmt0lRy7Y71+jYbpGyvwG4sH0XeJxjYGRgYADiwBB/53h+m68M3MwvgCIM1z5N/g6j///9v5H5BbMnkMvBwAQSBQCIcA9gAHicY2BkYGAO+p8FJF/8//v/F/MLBqAICuAFALYQB5kAeJxjfsHAwLwAiCNB+P9fbJjJmoGBMRUo/wKCAfO2EnQAAAAAANoBXgGcAgICVALaA1IDvAPkBAYEPARyAAEAAAANAF0ABAAAAAAAAgAUACQAcwAAAG4LcAAAAAB4nHWRzWrCQBSFT+pPqUIXLXTTzayKUohGKIibCoLuhbrrYtTRxCYZmYyKyz5Fd32HvlDfoO/QkziIFJtw9bvnnpl7ZwLgBt/wcHieGAf2UGd24Atcou+4RH3kuEweO66QXx1XyaHjGh6ROa7jFp/cwStfMVvhy7GHO+/e8QWuvcBxifqz4zL5xXGF/Oa4Sn53XMPE+3Bcx4P3M9DrvYmWoRWNQVN02kFXTPdCU4pSGQu5saE2meiLhU6timPtz3SSs9ypTCdqrJabWJoT5QQnymSRTkXgt0/UkUqVkVbN807ZdtmxdiEWRidi6HqItdErNbN+aO2612qd9sYAGmvsYRBhyUu0EGhQbfK/gzYCdElTOgSdB1eEFBIxFYkNV4RFJWPeZyyYpVQVHTHZx4y/yVGX2LGWFZri51TccUOn5B7nPefVCSPvGhVVwUl9znveO2KkhV8Wk82PZ8qwZf8OVcu1+fSmWCMw/HMOwXvKaysqM+p+cVuWag8tvv+c+xdd+4+teJxtjUEOwiAURJla24KliQfhUA2g/Sl+CKXx+loNrpzVezOLEY34Ron/0WhwQoszOvQYIKFwwQiNSbSBeO2SZ0tBP4j3zVjKNng32ZmtD1VVXCuOiw/pJ8S3WOU6l+K5UOTaDC4+2TjKMtN9KQf1ezLx/Sg/00FCvABHhjDjAAB4nGPw3sFwIihiIyNjX+QGxp0cDBwMyQUbGVidNjEwMmiBGJu5mBg5ICw+BjCLzWkX0wGgNCeQze60i8EBwmZmcNmowtgRGLHBoSNiI3OKy0Y1EG8XRwMDI4tDR3JIBEhJJBBs5mFi5NHawfi/dQNL70YmBhcADHYj9AAA) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headerlink {
  font: normal 400 16px fontawesome-mini;
  vertical-align: middle;
  margin-left: -16px;
  float: left;
  display: inline-block;
  text-decoration: none;
  opacity: 0;
  color: #333;
}

.markdown-body .headerlink:focus {
  outline: none;
}

.markdown-body h1 .headerlink {
  margin-top: 0.8rem;
}

.markdown-body h2 .headerlink,
.markdown-body h3 .headerlink {
  margin-top: 0.6rem;
}

.markdown-body h4 .headerlink {
  margin-top: 0.2rem;
}

.markdown-body h5 .headerlink,
.markdown-body h6 .headerlink {
  margin-top: 0;
}

.markdown-body .headerlink:hover,
.markdown-body h1:hover .headerlink,
.markdown-body h2:hover .headerlink,
.markdown-body h3:hover .headerlink,
.markdown-body h4:hover .headerlink,
.markdown-body h5:hover .headerlink,
.markdown-body h6:hover .headerlink {
  opacity: 1;
  text-decoration: none;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* MultiMarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px fontawesome-mini;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\e157';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><style>/*GitHub*/
.codehilite {background-color:#fff;color:#333333;}
.codehilite .hll {background-color:#ffffcc;}
.codehilite .c{color:#999988;font-style:italic}
.codehilite .err{color:#a61717;background-color:#e3d2d2}
.codehilite .k{font-weight:bold}
.codehilite .o{font-weight:bold}
.codehilite .cm{color:#999988;font-style:italic}
.codehilite .cp{color:#999999;font-weight:bold}
.codehilite .c1{color:#999988;font-style:italic}
.codehilite .cs{color:#999999;font-weight:bold;font-style:italic}
.codehilite .gd{color:#000000;background-color:#ffdddd}
.codehilite .ge{font-style:italic}
.codehilite .gr{color:#aa0000}
.codehilite .gh{color:#999999}
.codehilite .gi{color:#000000;background-color:#ddffdd}
.codehilite .go{color:#888888}
.codehilite .gp{color:#555555}
.codehilite .gs{font-weight:bold}
.codehilite .gu{color:#800080;font-weight:bold}
.codehilite .gt{color:#aa0000}
.codehilite .kc{font-weight:bold}
.codehilite .kd{font-weight:bold}
.codehilite .kn{font-weight:bold}
.codehilite .kp{font-weight:bold}
.codehilite .kr{font-weight:bold}
.codehilite .kt{color:#445588;font-weight:bold}
.codehilite .m{color:#009999}
.codehilite .s{color:#dd1144}
.codehilite .n{color:#333333}
.codehilite .na{color:teal}
.codehilite .nb{color:#0086b3}
.codehilite .nc{color:#445588;font-weight:bold}
.codehilite .no{color:teal}
.codehilite .ni{color:purple}
.codehilite .ne{color:#990000;font-weight:bold}
.codehilite .nf{color:#990000;font-weight:bold}
.codehilite .nn{color:#555555}
.codehilite .nt{color:navy}
.codehilite .nv{color:teal}
.codehilite .ow{font-weight:bold}
.codehilite .w{color:#bbbbbb}
.codehilite .mf{color:#009999}
.codehilite .mh{color:#009999}
.codehilite .mi{color:#009999}
.codehilite .mo{color:#009999}
.codehilite .sb{color:#dd1144}
.codehilite .sc{color:#dd1144}
.codehilite .sd{color:#dd1144}
.codehilite .s2{color:#dd1144}
.codehilite .se{color:#dd1144}
.codehilite .sh{color:#dd1144}
.codehilite .si{color:#dd1144}
.codehilite .sx{color:#dd1144}
.codehilite .sr{color:#009926}
.codehilite .s1{color:#dd1144}
.codehilite .ss{color:#990073}
.codehilite .bp{color:#999999}
.codehilite .vc{color:teal}
.codehilite .vg{color:teal}
.codehilite .vi{color:teal}
.codehilite .il{color:#009999}
.codehilite .gc{color:#999;background-color:#EAF2F5}
</style><title>java秒杀</title></head><body><article class="markdown-body"><h3 id="shedule">shedule定时关单写库存<a class="headerlink" href="#shedule" title="Permanent link"></a></h3>
<p>数据库查找创建时间在当前时间前1小时的所有订单
对每个订单的商品查找其库存，并且加锁。
新创建一个product，只赋值商品id和库存，更新数据库
``java</p>
<p><div class="codehilite"><pre>### 其他优化点
http://massivetechinterview.blogspot.com/2016/01/blog-post_48.html
数据库的分片，主从复制（可能会id冲突，要应用自己生成id）

### 1.前后台json格式
实现效果，在Controller调用静态方法：
    成功：`Result.success(data);` 成功时只返回数据
    异常：`Result.error(CodeMsg);` 包括code和msg
```java
class Result&lt;T&gt; {
    private int code;
    private String msg;
    private T data;
    /**
     * 成功时候的调用
     * */
    public static &lt;T&gt; Result&lt;T&gt; success(T data){
        return new  Result&lt;T&gt;(data);
    }

    /**
     * 失败时候的调用
     * */
    public static &lt;T&gt; Result&lt;T&gt; error(CodeMsg cm){
        return new  Result&lt;T&gt;(cm);
    }
    // 构造函数private 不被外部调用，外部只能使用2个静态方法
    // 失败构造
    private Result(CodeMsg cm) {
        if(cm  == null) {
            return;
        }
        this.code = cm.getCode();
        this.msg = cm.getMsg();
    }
    //成功构造
    private Result(T data) {
        this.code = 0;
        this.msg = &quot;success&quot;;
        this.data = data;
    }
}
</pre></div>
controller中测试：
<div class="codehilite"><pre><span class="nd">@Controller</span>
<span class="c1">//@RequestMapping(&quot;/demo&quot;)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">);</span>
       <span class="c1">// return new Result(0, &quot;success&quot;, &quot;hello&quot;);</span>
    <span class="o">}</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/helloError&quot;</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">helloError</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">);</span>
        <span class="c1">//return new Result(500102, &quot;XXX&quot;);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>封装错误信息类，用于生成各种各样的错误信息（枚举类？）
//后面很难改 不要用枚举
//外部只能调用静态变量
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CodeMsg</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">msg</span><span class="o">;</span>

    <span class="c1">//通用异常</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">SUCCESS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">&quot;success&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">SERVER_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500100</span><span class="o">,</span> <span class="s">&quot;服务端异常&quot;</span><span class="o">);</span>
    <span class="c1">//登录模块 5002XX</span>

    <span class="c1">//商品模块 5003XX</span>

    <span class="c1">//订单模块 5004XX</span>

    <span class="c1">//秒杀模块 5005XX</span>

    <span class="c1">//私有</span>
    <span class="kd">private</span> <span class="nf">CodeMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">code</span><span class="o">,</span> <span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p _="%" endfold="endfold">{% fold %}
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">enum</span>  <span class="n">CodeMsg</span> <span class="o">{</span>
    <span class="n">SUCCESS</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="s">&quot;success&quot;</span><span class="o">),</span>
    <span class="n">SERVER_ERROR</span><span class="o">(</span><span class="mi">500100</span><span class="o">,</span><span class="s">&quot;服务端异常&quot;</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">msg</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nf">CodeMsg</span><span class="o">(</span> <span class="kt">int</span> <span class="n">code</span><span class="o">,</span><span class="n">String</span> <span class="n">msg</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getMsg</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>测试：
访问<code>http://localhost:8080/hello</code>
<code>{"code":0,"msg":"success","data":"hello,imooc"}</code>
访问：<code>http://localhost:8080/helloError</code>
<code>{"code":500100,"msg":"服务端异常","data":null}</code></p>
<h3 id="2">2.添加页面模板 配置文件配置项<a class="headerlink" href="#2" title="Permanent link"></a></h3>
<p><a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#common-application-properties">https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#common-application-properties</a>
<code>/resources/aplication.properties</code>
<div class="codehilite"><pre>spring.thymeleaf.cache=false
spring.thymeleaf.content-type=text/html
spring.thymeleaf.enabled=true
spring.thymeleaf.encoding=UTF-8
spring.thymeleaf.mode=HTML5
spring.thymeleaf.prefix=classpath:/templates/
spring.thymeleaf.suffix=.html
</pre></div>
controller返回页面
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/hel&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span>  <span class="nf">thymeleaf</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//写入model的属性可以在页面中取到</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;名字&quot;</span><span class="o">);</span>
    <span class="c1">//找的是prefix+hello+sufix -&gt;/templates/hello.html</span>
    <span class="k">return</span> <span class="s">&quot;hello&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<code>/resources/templates/hello.html</code>
<div class="codehilite"><pre><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>hello<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;&#39;hello:&#39;+${name}&quot;</span> <span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></p>
<h3 id="3-mybatis">3. Mybatis<a class="headerlink" href="#3-mybatis" title="Permanent link"></a></h3>
<p><a href="http://www.mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/">http://www.mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/</a></p>
<p><div class="codehilite"><pre>mybatis.type-aliases-package=package.model
#下划线转驼峰
mybatis.configuration.map-underscore-to-camel-case=true
mybatis.configuration.default-fetch-size=100
mybatis.configuration.default-statement-timeout=3000
# 配置文件扫描 接口类和xml
mybatis.mapperLocations = classpath:package/dao/*.xml
</pre></div>
数据源druid
<div class="codehilite"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.3.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>druid<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.5<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
<div class="codehilite"><pre># druid
spring.datasource.url=jdbc:mysql://10.1.18.133:3306/maiosha?useUnicode=true&amp;characterEncoding=utf-8&amp;allowMultiQueries=true&amp;useSSL=false
spring.datasource.username=root
spring.datasource.password=root
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.type=com.alibaba.druid.pool.DruidDataSource
spring.datasource.filters=stat
spring.datasource.maxActive=2
spring.datasource.initialSize=1
spring.datasource.maxWait=60000
spring.datasource.minIdle=1
spring.datasource.timeBetweenEvictionRunsMillis=60000
spring.datasource.minEvictableIdleTimeMillis=300000
spring.datasource.validationQuery=select &#39;x&#39;
spring.datasource.testWhileIdle=true
spring.datasource.testOnBorrow=false
spring.datasource.testOnReturn=false
spring.datasource.poolPreparedStatements=true
spring.datasource.maxOpenPreparedStatements=20
</pre></div>
新建数据库并添加user表 
ID:int(11) name:varchar(255)
添加数据 1 小明
新建<code>/domain/User</code>对象
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">//get/set</span>
<span class="o">}</span>
</pre></div>
新建<code>/dao/UserDao</code>层interface UserDao
<div class="codehilite"><pre><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDao</span> <span class="o">{</span> 
    <span class="nd">@Select</span><span class="o">(</span><span class="s">&quot;select * from user where id = #{id}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span><span class="kt">int</span> <span class="n">id</span>  <span class="o">);</span>
<span class="o">}</span>
</pre></div>
写service
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>  
    <span class="nd">@Autowired</span>
    <span class="n">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getById</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
添加到controller
<div class="codehilite"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/demo&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/db/get&quot;</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">dbGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
访问： <a href="http://localhost:8080/demo/db/get">http://localhost:8080/demo/db/get</a>
返回： {&ldquo;code&rdquo;:0,&rdquo;msg&rdquo;:&rdquo;success&rdquo;,&rdquo;data&rdquo;:{&ldquo;id&rdquo;:1,&rdquo;name&rdquo;:&rdquo;小明&rdquo;}}</p>
<p>测试事务：数据库中已经有id=1的数据，连插入id=2，id=1的数据，如果能回滚就行
dao:
<div class="codehilite"><pre><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDao</span> <span class="o">{</span>

    <span class="nd">@Select</span><span class="o">(</span><span class="s">&quot;select * from user where id = #{id}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
    <span class="c1">//添加Insert方法</span>
    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&quot;insert into user(id, name)values(#{id}, #{name})&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
service:
<div class="codehilite"><pre><span class="c1">//注解注释掉 报错但插入了id=2</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tx</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//整体在一块（一个事务）</span>
    <span class="n">User</span> <span class="n">u1</span><span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
    <span class="n">u1</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="n">u1</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;2222&quot;</span><span class="o">);</span>
    <span class="n">userDao</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">u1</span><span class="o">);</span>
    <span class="c1">// 这条失败上面也不会插入</span>
    <span class="n">User</span> <span class="n">u2</span><span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
    <span class="n">u2</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">u2</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;11111&quot;</span><span class="o">);</span>
    <span class="n">userDao</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">u2</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
controller:
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/db/tx&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="nf">dbTx</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">userService</span><span class="o">.</span><span class="na">tx</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
测试：
访问：<code>http://localhost:8080/demo/db/tx</code>
数据完整性错误，但是2没有被插入
<div class="codehilite"><pre>Whitelabel Error Page
This application has no explicit mapping for /error, so you are seeing this as a fallback.

Tue Oct 16 22:27:57 CST 2018
There was an unexpected error (type=Internal Server Error, status=500).
### Error updating database. Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException: Duplicate entry &#39;1&#39; for key &#39;PRIMARY&#39; ### The error may involve com.cloud.miaosha.dao.UserDao.insert-Inline ### The error occurred while setting parameters ### SQL: insert into user(id, name)values(?, ?) ### Cause: com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException: Duplicate entry &#39;1&#39; for key &#39;PRIMARY&#39; ; SQL []; Duplicate entry &#39;1&#39; for key &#39;PRIMARY&#39;; nested exception is com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException: Duplicate entry &#39;1&#39; for key &#39;PRIMARY&#39;
</pre></div></p>
<h3 id="4redis">4.集成Redis<a class="headerlink" href="#4redis" title="Permanent link"></a></h3>
<p><a href="https://github.com/xetorthio/jedis">https://github.com/xetorthio/jedis</a>
<div class="codehilite"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.2.38<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
配置：
<div class="codehilite"><pre>redis.host=10.1.18.133
redis.port=6379
redis.timeout=3
redis.password=123456
redis.poolMaxTotal=10
redis.poolMaxIdle=10
spring.redis.pool.max-wait=3
</pre></div>
新建redis包
配置类<code>RedisConfig</code>
<div class="codehilite"><pre><span class="nd">@Component</span>
<span class="c1">//获取配置文件 配置里的前缀 </span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&quot;redis&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfig</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">host</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">timeout</span><span class="o">;</span><span class="c1">//秒</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">poolMaxTotal</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">poolMaxIdle</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">poolMaxWait</span><span class="o">;</span><span class="c1">//秒</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="service">Service<a class="headerlink" href="#service" title="Permanent link"></a></h4>
<p>通过service提供Redis的get/set
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisService</span><span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">JedisPool</span> <span class="n">jedisPool</span><span class="o">;</span>
    <span class="kd">public</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">){</span>
        <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Autowired</span>
    <span class="n">RedisConfig</span> <span class="n">redisConfig</span><span class="o">;</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">JedisPool</span> <span class="nf">JedisFactory</span><span class="o">(){</span>
        <span class="n">JedisPoolConfig</span> <span class="n">poolConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPoolConfig</span><span class="o">();</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxIdle</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxIdle</span><span class="o">());</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxTotal</span><span class="o">());</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxWait</span><span class="o">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="c1">//redis默认16个库，从0库开始</span>
        <span class="n">JedisPool</span> <span class="n">jp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPool</span><span class="o">(</span><span class="n">poolConfig</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">()*</span><span class="mi">1000</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">jp</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p _="%" endfold="endfold">查看源码找JedisPool中的timeout是什么单位
redis 默认6个库从0开始
<div class="codehilite"><pre><span class="n">JedisPool</span> <span class="n">jp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPool</span><span class="o">(</span><span class="n">poolConfig</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">()*</span><span class="mi">1000</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
<span class="c1">//JedisPool.java</span>
<span class="kd">public</span> <span class="nf">JedisPool</span><span class="o">(</span><span class="kd">final</span> <span class="n">GenericObjectPoolConfig</span> <span class="n">poolConfig</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span><span class="kt">int</span> <span class="n">timeout</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">database</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">poolConfig</span><span class="o">,</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">database</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//this</span>
<span class="kd">public</span> <span class="nf">JedisPool</span><span class="o">(</span><span class="kd">final</span> <span class="n">GenericObjectPoolConfig</span> <span class="n">poolConfig</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">connectionTimeout</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">soTimeout</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">database</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">String</span> <span class="n">clientName</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="kd">final</span> <span class="n">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
<span class="kd">super</span><span class="o">(</span><span class="n">poolConfig</span><span class="o">,</span> <span class="k">new</span> <span class="n">JedisFactory</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">connectionTimeout</span><span class="o">,</span> <span class="n">soTimeout</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span>
    <span class="n">database</span><span class="o">,</span> <span class="n">clientName</span><span class="o">,</span> <span class="n">ssl</span><span class="o">,</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="n">hostnameVerifier</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
JedisFactory
<div class="codehilite"><pre><span class="kd">public</span> <span class="nf">JedisFactory</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">connectionTimeout</span><span class="o">,</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">soTimeout</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">password</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">database</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">clientName</span><span class="o">,</span>
  <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
<span class="k">this</span><span class="o">.</span><span class="na">hostAndPort</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="n">HostAndPort</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
<span class="c1">//找用到connect time的地方</span>
<span class="k">this</span><span class="o">.</span><span class="na">connectionTimeout</span> <span class="o">=</span> <span class="n">connectionTimeout</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">soTimeout</span> <span class="o">=</span> <span class="n">soTimeout</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">database</span> <span class="o">=</span> <span class="n">database</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">clientName</span> <span class="o">=</span> <span class="n">clientName</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">ssl</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">sslSocketFactory</span> <span class="o">=</span> <span class="n">sslSocketFactory</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">sslParameters</span> <span class="o">=</span> <span class="n">sslParameters</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">hostnameVerifier</span> <span class="o">=</span> <span class="n">hostnameVerifier</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//connectionTimeout用的地方PooledObject类</span>
<span class="kd">final</span> <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jedis</span><span class="o">(</span><span class="n">hostAndPort</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">hostAndPort</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span> <span class="n">connectionTimeout</span><span class="o">,</span>
        <span class="n">soTimeout</span><span class="o">,</span> <span class="n">ssl</span><span class="o">,</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="n">hostnameVerifier</span><span class="o">);</span>
<span class="c1">//Jedis.java</span>
<span class="kd">public</span> <span class="nf">Jedis</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">connectionTimeout</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">soTimeout</span><span class="o">,</span>
  <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
<span class="kd">super</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">connectionTimeout</span><span class="o">,</span> <span class="n">soTimeout</span><span class="o">,</span> <span class="n">ssl</span><span class="o">,</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">sslParameters</span><span class="o">,</span>
    <span class="n">hostnameVerifier</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//super BinaryJedis.java</span>
<span class="kd">public</span> <span class="nf">BinaryJedis</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">connectionTimeout</span><span class="o">,</span>
  <span class="kd">final</span> <span class="kt">int</span> <span class="n">soTimeout</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="kd">final</span> <span class="n">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
<span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Client</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">ssl</span><span class="o">,</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="n">hostnameVerifier</span><span class="o">);</span>
<span class="c1">//timeout的地方是Client</span>
<span class="n">client</span><span class="o">.</span><span class="na">setConnectionTimeout</span><span class="o">(</span><span class="n">connectionTimeout</span><span class="o">);</span>
<span class="n">client</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="n">soTimeout</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//Connection.java</span>
<span class="n">socket</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">),</span> <span class="n">connectionTimeout</span><span class="o">);</span>
<span class="n">socket</span><span class="o">.</span><span class="na">setSoTimeout</span><span class="o">(</span><span class="n">soTimeout</span><span class="o">);</span>
<span class="c1">//Socket.java</span>
<span class="c1">//!!!毫秒</span>
<span class="nd">@param</span> <span class="n">timeout</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">in</span> <span class="n">milliseconds</span><span class="o">.</span>
<span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">setSoTimeout</span><span class="o">(</span><span class="kt">int</span> <span class="n">timeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SocketException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isClosed</span><span class="o">())</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">SocketException</span><span class="o">(</span><span class="s">&quot;Socket is closed&quot;</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;timeout can&#39;t be negative&quot;</span><span class="o">);</span>

    <span class="n">getImpl</span><span class="o">().</span><span class="na">setOption</span><span class="o">(</span><span class="n">SocketOptions</span><span class="o">.</span><span class="na">SO_TIMEOUT</span><span class="o">,</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="n">timeout</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
所以回到最开始<code>redis.timeout=3</code>是秒
<div class="codehilite"><pre><span class="n">JedisPool</span> <span class="n">jp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPool</span><span class="o">(</span><span class="n">poolConfig</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">()*</span><span class="mi">1000</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
</pre></div>
//Client.java 
{% fold %}
<div class="codehilite"><pre><span class="c1">//Client.java</span>
<span class="kd">public</span> <span class="nf">Client</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
<span class="kd">super</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">ssl</span><span class="o">,</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="n">hostnameVerifier</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//super-&gt;BinaryClient.java</span>
<span class="kd">public</span> <span class="nf">BinaryClient</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="kd">final</span> <span class="n">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span>
  <span class="kd">final</span> <span class="n">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
<span class="kd">super</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">ssl</span><span class="o">,</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">sslParameters</span><span class="o">,</span> <span class="n">hostnameVerifier</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//super-&gt;Connection.java</span>
<span class="kd">public</span> <span class="nf">Connection</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">ssl</span><span class="o">,</span>
  <span class="n">SSLSocketFactory</span> <span class="n">sslSocketFactory</span><span class="o">,</span> <span class="n">SSLParameters</span> <span class="n">sslParameters</span><span class="o">,</span>
  <span class="n">HostnameVerifier</span> <span class="n">hostnameVerifier</span><span class="o">)</span> <span class="o">{</span>
<span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">ssl</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">sslSocketFactory</span> <span class="o">=</span> <span class="n">sslSocketFactory</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">sslParameters</span> <span class="o">=</span> <span class="n">sslParameters</span><span class="o">;</span>
<span class="k">this</span><span class="o">.</span><span class="na">hostnameVerifier</span> <span class="o">=</span> <span class="n">hostnameVerifier</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>修改上面Service 加上释放连接池的代码
查看Jedis的close方法源码
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
<span class="k">if</span> <span class="o">(</span><span class="n">dataSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">isBroken</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">//不关掉 返回到连接池</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span><span class="o">.</span><span class="na">returnBrokenResource</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dataSource</span><span class="o">.</span><span class="na">returnResource</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="n">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<h5 id="setbeantostrnig">set方法BeanToStrnig<a class="headerlink" href="#setbeantostrnig" title="Permanent link"></a></h5>
<p>用fastjson将bean对象变成string
<div class="codehilite"><pre><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">T</span> <span class="n">value</span><span class="o">){</span>
    <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">beanToString</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">str</span> <span class="o">==</span> <span class="kc">null</span><span class="o">||</span><span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">()&lt;=</span><span class="mi">0</span><span class="o">)</span><span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">str</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="n">returnToPool</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
        <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="c1">//任意类型转化成字符串</span>
<span class="kn">import</span> <span class="nn">com.alibaba.fastjson.JSON</span><span class="o">;</span>
<span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">String</span> <span class="nf">beanToString</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">){</span>
    <span class="c1">//2. 添加空判断</span>
    <span class="k">if</span><span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span><span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">//3. 如果是数字，字符串，Long</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">value</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">value</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">value</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="get-stringtobean">get方法 StringToBean<a class="headerlink" href="#get-stringtobean" title="Permanent link"></a></h4>
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisService</span><span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">JedisPool</span> <span class="n">jedisPool</span><span class="o">;</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span><span class="c1">//屏蔽警告</span>
    <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">stringToBean</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">,</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">){</span>
        <span class="c1">//1. 参数校验</span>
        <span class="k">if</span><span class="o">(</span><span class="n">str</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//2 如果是int，string，Long</span>
        <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">str</span><span class="o">;</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span>  <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="c1">//fastJson 只支持了bean类型 其他List类型要再写</span>
            <span class="k">return</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJavaObject</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">str</span><span class="o">),</span> <span class="n">clazz</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
    <span class="kd">public</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">){</span>
        <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
        <span class="n">jdeis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="c1">//2.get的逻辑：get是String类型，需要的是T类型</span>
        <span class="n">String</span> <span class="n">value</span> <span class="o">=</span>  <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="n">T</span> <span class="n">t</span> <span class="o">=</span> <span class="n">stringToBean</span><span class="o">(</span><span class="n">value</span><span class="o">,</span><span class="n">clazz</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
        <span class="c1">//1. 添加关闭代码</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="n">returnToPool</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">returnToPool</span><span class="o">(</span><span class="n">Jedis</span> <span class="n">jedis</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">jedis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
         <span class="o">}</span>
    <span class="o">}</span>
    <span class="nd">@Autowired</span>
    <span class="n">RedisConfig</span> <span class="n">redisConfig</span><span class="o">;</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">JedisPool</span> <span class="nf">JedisFactory</span><span class="o">(){</span>
        <span class="n">JedisPoolConfig</span> <span class="n">poolConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPoolConfig</span><span class="o">();</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxIdle</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxIdle</span><span class="o">());</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxTotal</span><span class="o">());</span>
        <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxWait</span><span class="o">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="c1">//redis默认16个库，从0库开始</span>
        <span class="n">JedisPool</span> <span class="n">jp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPool</span><span class="o">(</span><span class="n">poolConfig</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">()*</span><span class="mi">1000</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">jp</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h4 id="controller-get">controller get测试:<a class="headerlink" href="#controller-get" title="Permanent link"></a></h4>
<p>127.0.0.1:6379&gt; auth 123456
OK
127.0.0.1:6379&gt; set key1 1
OK
<div class="codehilite"><pre><span class="nd">@Autowired</span>
<span class="n">RedisService</span> <span class="n">redisService</span><span class="o">;</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/redis/get&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">redisGet</span><span class="o">()</span> <span class="o">{</span>

    <span class="n">String</span>  <span class="n">name</span>  <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;key1&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
报错：jedispoll循环引用 空指针</p>
<blockquote>
<p>[redis.clients.jedis.JedisPool]: Circular reference involving containing bean &lsquo;redisService&rsquo; - consider declaring the factory method as static for independence from its containing instance. Factory method &lsquo;JedisFactory&rsquo; threw exception; nested exception is java.lang.NullPointerException</p>
</blockquote>
<p>因为Service里注入了pool
<div class="codehilite"><pre><span class="nd">@Autowired</span>
<span class="n">JedisPool</span> <span class="n">jedisPool</span><span class="o">;</span>
</pre></div>
但是 JedisPool是实例方法 创建这个Bean需要RedisSevice
<div class="codehilite"><pre><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">JedisPool</span> <span class="nf">JedisFactory</span><span class="o">()</span>
</pre></div></p>
<p>所以独立出<code>JedisPool</code>
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisPoolFactory</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">RedisConfig</span> <span class="n">redisConfig</span><span class="o">;</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">JedisPool</span> <span class="nf">JedisFactory</span><span class="o">(){</span>
    <span class="n">JedisPoolConfig</span> <span class="n">poolConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPoolConfig</span><span class="o">();</span>
    <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxIdle</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxIdle</span><span class="o">());</span>
    <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxTotal</span><span class="o">());</span>
    <span class="n">poolConfig</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getPoolMaxWait</span><span class="o">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
    <span class="c1">//redis默认16个库，从0库开始</span>
    <span class="n">JedisPool</span> <span class="n">jp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPool</span><span class="o">(</span><span class="n">poolConfig</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getHost</span><span class="o">(),</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPort</span><span class="o">(),</span><span class="n">redisConfig</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">()*</span><span class="mi">1000</span><span class="o">,</span> <span class="n">redisConfig</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">jp</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="controller-set">controller set测试:<a class="headerlink" href="#controller-set" title="Permanent link"></a></h4>
<p><div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/redis/set&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="nf">redisSet</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">User</span> <span class="n">user</span>  <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;1111&quot;</span><span class="o">);</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;key3&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span><span class="c1">//UserKey:id1</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
127.0.0.1:6379&gt; get key3
&ldquo;{"id":1,"name":"1111"}&rdquo;</p>
<h4 id="-key">模板模式<code>[接口&lt;-抽象类&lt;-实现类]</code>：封装缓存key，加上前缀<a class="headerlink" href="#-key" title="Permanent link"></a></h4>
<h5 id="_1">模板方法模式：算法骨架，允许子类为一个或多个步骤提供实现<a class="headerlink" href="#_1" title="Permanent link"></a></h5>
<p>子类不改变算法结构的情况下，重定义算法的某些步骤。
1）一次性实现算法不变的部分，并将可变的留给子类实现。
2）子类中的公共行为提取到一个公共父类，避免代码重复。
可以实现钩子方法。
例子：<code>AbstractList</code>、<code>HttpServlet</code>子类重写部分的<code>doGet/Post</code>等方法
Mybatis：<code>BaseExecutor</code>中的<code>doUpdate</code>方法 有各种实现（batchExecutor等)类覆盖</p>
<p>优化：将key加上Prefix，按业务模块区分缓存的key
<code>KeyPrefix</code> 接口 <code>BasePrefix</code> 抽象类 <code>UserKey</code> <code>OrderKey</code>等模块实现类
效果：在不同的controllor模块调用service时传入模块ID
controller使用:classname+prefix+key
redis效果：<code>7) "UserKey:id1"</code>
<code>UserKey.getById</code>
<div class="codehilite"><pre> <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/redis/get&quot;</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">redisGet</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">User</span>  <span class="n">user</span>  <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">UserKey</span><span class="o">.</span><span class="na">getById</span><span class="o">,</span> <span class="s">&quot;1&quot;</span><span class="o">,</span> <span class="n">User</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/redis/set&quot;</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="nf">redisSet</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span>  <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&quot;1111&quot;</span><span class="o">);</span>
        <span class="c1">//UserKey:id1</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">UserKey</span><span class="o">.</span><span class="na">getById</span><span class="o">,</span><span class="s">&quot;1&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
接口：
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nf">KeyPrefix</span><span class="o">(){</span>
    <span class="c1">//有效期</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">expireSeconds</span><span class="o">();</span>
    <span class="c1">//前缀</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPrefix</span><span class="o">();</span> 
<span class="o">}</span>
</pre></div>
实现的<code>抽象类</code> 防止被创建
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BasePrefix</span> <span class="kd">implements</span> <span class="n">KeyPrefix</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">prefix</span><span class="o">;</span>
    <span class="c1">//0表示永不过期</span>
    <span class="kd">public</span> <span class="nf">BasePrefix</span><span class="o">(</span><span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span><span class="c1">//0代表永不过期</span>
        <span class="k">this</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">expireSeconds</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">expireSeconds</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//用类名当前缀</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPrefix</span><span class="o">(){</span>
        <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">className</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="n">perfix</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>实现类：用户key
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span><span class="o">{</span>
    <span class="c1">//私有 防实例化</span>
    <span class="kd">private</span> <span class="nf">UserKey</span><span class="o">(</span><span class="n">String</span> <span class="n">prefix</span><span class="o">){</span><span class="kd">super</span><span class="o">(</span><span class="n">prefix</span><span class="o">);}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">UserKey</span> <span class="n">getById</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserKey</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">UserKey</span> <span class="n">getByName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserKey</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
实现类：订单key
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span>
</pre></div></p>
<p>修改Service中的get和set</p>
<p><div class="codehilite"><pre><span class="cm">/**</span>
<span class="cm"> * 获取单个对象</span>
<span class="cm"> */</span>
<span class="kd">public</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">get</span><span class="o">(</span><span class="n">Prefix</span> <span class="n">prefix</span><span class="o">,</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">){</span>
    <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="c1">//真正写到数据库的key</span>
        <span class="n">String</span> <span class="n">prefixKey</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="na">getPrefix</span><span class="o">()+</span><span class="n">key</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">value</span> <span class="o">=</span>  <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">prefixKey</span><span class="o">);</span>
        <span class="n">T</span> <span class="n">t</span> <span class="o">=</span> <span class="n">stringToBean</span><span class="o">(</span><span class="n">value</span><span class="o">,</span><span class="n">clazz</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
    <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
        <span class="n">returnToPool</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
添加失效时间
127.0.0.1:6379&gt; expire key1 3
(integer) 1
<div class="codehilite"><pre><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">set</span><span class="o">(</span><span class="n">KeyPrefix</span> <span class="n">prefix</span><span class="o">,</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">T</span> <span class="n">value</span><span class="o">){</span>
    <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">beanToString</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">str</span> <span class="o">==</span> <span class="kc">null</span><span class="o">||</span><span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">()&lt;=</span><span class="mi">0</span><span class="o">)</span><span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">prefixKey</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="na">getPrefix</span><span class="o">()+</span><span class="n">key</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">expire</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="na">expireSeconds</span><span class="o">();</span>
        <span class="c1">//永不过期</span>
        <span class="k">if</span><span class="o">(</span><span class="n">expire</span><span class="o">&lt;=</span><span class="mi">0</span><span class="o">){</span>
            <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">prefixKey</span><span class="o">,</span><span class="n">str</span><span class="o">);</span>

        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="n">jedis</span><span class="o">.</span><span class="na">setex</span><span class="o">(</span><span class="n">prefixKey</span><span class="o">,</span><span class="n">expire</span><span class="o">,</span><span class="n">str</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
        <span class="n">returnToPool</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
setex:
等于set+expire命令
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">String</span> <span class="nf">setex</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">seconds</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">checkIsInMultiOrPipeline</span><span class="o">();</span>
    <span class="n">client</span><span class="o">.</span><span class="na">setex</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">seconds</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="na">getStatusCodeReply</span><span class="o">();</span>
  <span class="o">}</span>
</pre></div></p>
<h4 id="api">添加其他API:<a class="headerlink" href="#api" title="Permanent link"></a></h4>
<p>127.0.0.1:6379&gt; exists key1
(integer) 1
<div class="codehilite"><pre><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="kt">boolean</span> <span class="nf">exists</span><span class="o">(</span><span class="n">KeyPrefix</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
 <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 <span class="k">try</span> <span class="o">{</span>
     <span class="n">jedis</span> <span class="o">=</span>  <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
     <span class="n">String</span> <span class="n">prefixKey</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="na">getPrefix</span><span class="o">()+</span><span class="n">key</span><span class="o">;</span>
    <span class="k">return</span>  <span class="n">jedis</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">prefixKey</span><span class="o">);</span>
 <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
      <span class="n">returnToPool</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
 <span class="o">}</span>
</pre></div>
127.0.0.1:6379&gt; incr key1
(integer) 2
127.0.0.1:6379&gt; incr key1
(integer) 3
127.0.0.1:6379&gt; set key222 fdafda
OK
127.0.0.1:6379&gt; incr key222
(error) ERR value is not an integer or out of range</p>
<p>incr
<div class="codehilite"><pre><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Long</span> <span class="nf">incr</span><span class="o">(</span><span class="n">KeyPrefix</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
     <span class="k">try</span> <span class="o">{</span>
         <span class="n">jedis</span> <span class="o">=</span>  <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="c1">//生成真正的key</span>
         <span class="n">String</span> <span class="n">realKey</span>  <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="na">getPrefix</span><span class="o">()</span> <span class="o">+</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">return</span>  <span class="n">jedis</span><span class="o">.</span><span class="na">incr</span><span class="o">(</span><span class="n">realKey</span><span class="o">);</span>
     <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
          <span class="n">returnToPool</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
     <span class="o">}</span>
<span class="o">}</span>
</pre></div>
127.0.0.1:6379&gt; incr key1
(integer) 5
127.0.0.1:6379&gt; decr key1
(integer) 4</p>
<p>decr
<div class="codehilite"><pre><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Long</span> <span class="nf">decr</span><span class="o">(</span><span class="n">KeyPrefix</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
     <span class="k">try</span> <span class="o">{</span>
         <span class="n">jedis</span> <span class="o">=</span>  <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="c1">//生成真正的key</span>
         <span class="n">String</span> <span class="n">realKey</span>  <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="na">getPrefix</span><span class="o">()</span> <span class="o">+</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">return</span>  <span class="n">jedis</span><span class="o">.</span><span class="na">decr</span><span class="o">(</span><span class="n">realKey</span><span class="o">);</span>
     <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
          <span class="n">returnToPool</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
     <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<h3 id="5-2md5-jsr303-session">5.实现登陆 数据库设计 2次MD5 JSR303参数校验 全局异常 分布式session<a class="headerlink" href="#5-2md5-jsr303-session" title="Permanent link"></a></h3>
<p>数据库设计
<div class="codehilite"><pre><span class="k">create</span> <span class="k">table</span> <span class="o">`</span><span class="n">miaosha_user</span><span class="o">`</span><span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;用户ID，手机号&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">nickname</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="o">`</span><span class="n">password</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;MD5(md5+salt)+salt&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">salt</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span><span class="p">,</span>
  <span class="o">`</span><span class="n">head</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;头像&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">register_date</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;注册时间&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">last_login_date</span><span class="o">`</span> <span class="n">datetime</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;上次登录时间&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">login_count</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">default</span> <span class="s1">&#39;0&#39;</span> <span class="k">comment</span> <span class="s1">&#39;登陆次数&#39;</span><span class="p">,</span>
  <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</pre></div></p>
<p>用户端先MD5(明文+固定salt)
服务端存再一次md5(明文+随机salt)
<div class="codehilite"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>commons-codec<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>commons-codec<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>commons-lang3<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
新建util包使用apacheMD5加密
前端第一次salt是可以看到的 隐藏只能activeX控件之类的
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.apache.commons.codec.digest.DigestUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">md5</span><span class="o">(</span><span class="n">String</span> <span class="n">src</span><span class="o">){</span>
    <span class="k">return</span> <span class="n">DigestUtils</span><span class="o">.</span><span class="na">md5Hex</span><span class="o">(</span><span class="n">src</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//添加一个salt</span>
<span class="c1">//前端form表单提交上来的密码</span>
<span class="c1">//一次加密&quot;123456&quot;-&gt; 26718c17fe0b7862a27dd7dc1b532f29</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">inputPassFormPass</span><span class="o">(</span><span class="n">String</span> <span class="n">inputPass</span><span class="o">){</span>
    <span class="n">String</span> <span class="n">passsalt</span> <span class="o">=</span> <span class="n">salt</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)+</span><span class="n">salt</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">2</span><span class="o">)+</span><span class="n">inputPass</span><span class="o">+</span><span class="n">salt</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">md5</span><span class="o">(</span><span class="n">passsalt</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//第二次加密，放入数据库</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">formPassToDBPass</span><span class="o">(</span><span class="n">String</span> <span class="n">formPass</span><span class="o">,</span> <span class="n">String</span> <span class="n">salt</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">toDB</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">salt</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)+</span><span class="n">salt</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">+</span> <span class="n">formPass</span> <span class="o">+</span><span class="n">salt</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">+</span> <span class="n">salt</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">md5</span><span class="o">(</span><span class="n">toDB</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//两次合并成1次</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">inputPassToDbPass</span><span class="o">(</span><span class="n">String</span> <span class="n">inputPass</span><span class="o">,</span> <span class="n">String</span> <span class="n">saltDB</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">formPass</span> <span class="o">=</span> <span class="n">inputPassToFormPass</span><span class="o">(</span><span class="n">inputPass</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">dbPass</span> <span class="o">=</span> <span class="n">formPassToDBPass</span><span class="o">(</span><span class="n">formPass</span><span class="o">,</span> <span class="n">saltDB</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">dbPass</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//c996054adec06904c675b89aa68de2ec</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">inputPassToFormPass</span><span class="o">(</span><span class="s">&quot;123456&quot;</span><span class="o">));</span>
    <span class="c1">//bef054e9b1abb70963943f32b41a3f6d</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">formPassToDBPass</span><span class="o">(</span><span class="n">inputPassToFormPass</span><span class="o">(</span><span class="s">&quot;123456&quot;</span><span class="o">),</span> <span class="s">&quot;secondsalt&quot;</span><span class="o">));</span>
</pre></div></p>
<p>在controller添加path
<div class="codehilite"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/login&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">LoginController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/login&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toLogin</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="bootstrapcssjqlayermd5">登陆页面 用bootstrap的css，jq的表单验证，layer的弹窗，md5加密<a class="headerlink" href="#bootstrapcssjqlayermd5" title="Permanent link"></a></h4>
<p>登陆html页面引入：
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>登录<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="p">/&gt;</span>
    <span class="c">&lt;!-- jquery --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/js/jquery.min.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- bootstrap --&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;@{/bootstrap/css/bootstrap.min.css}&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/bootstrap/js/bootstrap.min.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- jquery-validator --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/jquery-validation/jquery.validate.min.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/jquery-validation/localization/messages_zh.min.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- layer --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/layer/layer.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- md5.js --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/js/md5.min.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="c">&lt;!-- common.js --&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{/js/common.js}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</pre></div>
bootstrap+jquery验证:
{% fold %}
<div class="codehilite"><pre><span class="c">&lt;!-- 50%宽度 居中 margin: 0 auto --&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;loginForm&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;loginForm&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span>  <span class="na">style</span><span class="o">=</span><span class="s">&quot;width:50%; margin:0 auto&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h2</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;text-align:center; margin-bottom: 20px&quot;</span><span class="p">&gt;</span>用户登录<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span> 
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-label col-md-4&quot;</span><span class="p">&gt;</span>请输入手机号码<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-5&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;mobile&quot;</span> <span class="na">name </span><span class="o">=</span> <span class="s">&quot;mobile&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;手机号码&quot;</span> <span class="na">required</span><span class="o">=</span><span class="s">&quot;true&quot;</span>  <span class="na">minlength</span><span class="o">=</span><span class="s">&quot;11&quot;</span> <span class="na">maxlength</span><span class="o">=</span><span class="s">&quot;11&quot;</span> <span class="p">/&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-1&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-label col-md-4&quot;</span><span class="p">&gt;</span>请输入密码<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-5&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span>  <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;密码&quot;</span> <span class="na">required</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="na">minlength</span><span class="o">=</span><span class="s">&quot;6&quot;</span> <span class="na">maxlength</span><span class="o">=</span><span class="s">&quot;16&quot;</span> <span class="p">/&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-5&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;reset&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;reset()&quot;</span><span class="p">&gt;</span>重置<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-5&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;login()&quot;</span><span class="p">&gt;</span>登录<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
     <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
{% endfold %}
jquery validate:
<a href="http://www.runoob.com/jquery/jquery-plugin-validate.html">http://www.runoob.com/jquery/jquery-plugin-validate.html</a>
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">login</span><span class="p">(){</span>
    <span class="c1">// 在键盘按下并释放及提交后验证提交表单</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#loginForm&quot;</span><span class="p">).</span><span class="nx">validate</span><span class="p">({</span>
        <span class="nx">submitHandler</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">form</span><span class="p">){</span>
            <span class="c1">//如果成功 异步提交表单</span>
            <span class="nx">doLogin</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">})</span>
</pre></div>
使用ajax异步提交
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">doLogin</span><span class="p">(){</span>
    <span class="c1">//每次提交loading框</span>
    <span class="nx">g_showLoading</span><span class="p">()</span>
    <span class="c1">//md5加密密码 与后台规则一样</span>
    <span class="kd">var</span> <span class="nx">inputpwd</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#password&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
    <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="nx">salt</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="nx">salt</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="nx">inputpwd</span><span class="o">+</span><span class="nx">salt</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="c1">//123456-&gt;c996054adec06904c675b89aa68de2ec</span>
    <span class="kd">var</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">md5</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span><span class="s2">&quot;/login/do_login&quot;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span><span class="p">{</span>
            <span class="nx">mobile</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#mobile&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
            <span class="nx">password</span><span class="o">:</span><span class="nx">password</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="c1">//无论成功失败都关闭框</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">closeAll</span><span class="p">();</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span>
 <span class="cm">/* {code: 0, msg: null, data: &quot;登录成功&quot;} */</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;成功&quot;</span><span class="p">)</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;打印后端返回的错误信息&quot;</span><span class="p">)</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">closeAll</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>
layer.js弹窗
<a href="http://layer.layui.com/">http://layer.layui.com/</a>
common.js
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">g_showLoading</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s1">&#39;处理中...&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">icon</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span><span class="nx">shade</span><span class="o">:</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;#f5f5f5&#39;</span><span class="p">],</span><span class="nx">scrollbar</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span><span class="nx">offset</span><span class="o">:</span> <span class="s1">&#39;0px&#39;</span><span class="p">,</span> <span class="nx">time</span><span class="o">:</span><span class="mi">100000</span><span class="p">})</span> <span class="p">;</span>  
    <span class="k">return</span> <span class="nx">idx</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
在js中设置salt
<div class="codehilite"><pre><span class="kd">var</span> <span class="nx">g_passsword_salt</span><span class="o">=</span><span class="s2">&quot;abcd1234&quot;</span>
</pre></div></p>
<h4 id="_2">参数校验<a class="headerlink" href="#_2" title="Permanent link"></a></h4>
<p>在controller 验证手机号之后
再调用Service 用手机号查询dao数据库里面的密码，与前端传的密码做比较。
页面参数用vo封装。</p>
<p>后台添加vo接收前端数据的类：
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginVo</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">mobile</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
添加controller：
添加errormessage
CodeMsg.java
<div class="codehilite"><pre><span class="c1">//登录模块 5002XX</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">SESSION_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500210</span><span class="o">,</span><span class="s">&quot;Session不存在或者已经失效&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">PASSWORD_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500211</span><span class="o">,</span><span class="s">&quot;登陆密码不能为空&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MOBILE_EMPTY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500212</span><span class="o">,</span><span class="s">&quot;手机号不能为空&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">SESSION_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500210</span><span class="o">,</span><span class="s">&quot;Session不存在或者已经失效&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">PASSWORD_EMPTY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500211</span><span class="o">,</span><span class="s">&quot;登陆密码不能为空&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MOBILE_EMPTY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500212</span><span class="o">,</span><span class="s">&quot;手机号不能为空&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MOBILE_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500213</span><span class="o">,</span><span class="s">&quot;手机号格式错误&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MOBILE_NOT_EXIST</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500214</span><span class="o">,</span><span class="s">&quot;手机号不存在&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">PASSWORD_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500215</span><span class="o">,</span><span class="s">&quot;密码错误&quot;</span><span class="o">);</span>
</pre></div></p>
<p><div class="codehilite"><pre><span class="c1">//添加log 可以查看前端传过来的form数据是什么</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">LoginController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/do_login&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="nf">doLogin</span><span class="o">(</span><span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">loginVo</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="c1">//参数校验</span>
    <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">loginVo</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">mobile</span> <span class="o">=</span> <span class="n">loginVo</span><span class="o">.</span><span class="na">getMobile</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">mobile</span><span class="o">)){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MOBILE_EMPTY</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">password</span><span class="o">)){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">PASSWORD_EMPTY</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">ValidatorUtil</span><span class="o">.</span><span class="na">isMobile</span><span class="o">(</span><span class="n">mobile</span><span class="o">))</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MOBILE_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
正则手机号
手机号验证类ValidatorUtil.java
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">java.util.regex.Matcher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.Pattern</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.lang3.StringUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ValidatorUtil</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Pattern</span> <span class="n">mobile_pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">&quot;^(13[0-9]|14[579]|15[0-3,5-9]|16[6]|17[0135678]|18[0-9]|19[89])\\d{8}$&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isMobile</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">str</span><span class="o">)){</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Matcher</span> <span class="n">m</span> <span class="o">=</span> <span class="n">mobile_pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="na">matches</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//true</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">isMobile</span><span class="o">(</span><span class="s">&quot;18912341234&quot;</span><span class="o">));</span>
        <span class="c1">//false</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">isMobile</span><span class="o">(</span><span class="s">&quot;12345678900&quot;</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
新建与数据库关联的domain对象
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaUser</span> <span class="o">{</span>
    <span class="c1">//bigint</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nickname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">salt</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">head</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">registerDate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">lastLoginDate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">loginCount</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
新建dao,通过id找用户
<div class="codehilite"><pre><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MiaoshaUserDao</span><span class="o">{</span>
    <span class="nd">@Select</span><span class="err">（</span><span class="s">&quot;select * from miaosha user where id = #{id}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">MiaoshaUser</span> <span class="nf">getById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">);</span>
    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&quot;insert into user(id, name)values(#{id}, #{name})&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="n">User</span> <span class="n">user</span><span class="o">);</span>

<span class="o">}</span>
</pre></div></p>
<p>service获取用户及登陆:
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaUserService</span><span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">MiaoshaUserDao</span> <span class="n">miaoshaUserDao</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">MiaoshaUser</span> <span class="nf">getById</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">miaoshaUserDao</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">CodeMsg</span> <span class="nf">login</span><span class="o">(</span><span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">loginVo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">mobile</span> <span class="o">=</span> <span class="n">loginVo</span><span class="o">.</span><span class="na">getMobile</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">formPass</span> <span class="o">=</span> <span class="n">loginVo</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
        <span class="c1">//数据库查询手机号</span>
        <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">getById</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">mobile</span><span class="o">));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//用户/手机号不存在</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">MOBILE_NOT_EXIST</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//数据库中的密码,salt</span>
        <span class="n">String</span> <span class="n">dbPass</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">saltDB</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">();</span>
        <span class="c1">//用前端密码+数据库salt是否等于数据库密码</span>
        <span class="n">String</span> <span class="n">gassDBpass</span> <span class="o">=</span> <span class="n">MD5Util</span><span class="o">.</span><span class="na">formPassToDBPass</span><span class="o">(</span><span class="n">formPass</span><span class="o">,</span> <span class="n">saltDB</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">calcPass</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">dbPass</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">PASSWORD_ERROR</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">SUCCESS</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
在controller中注入
<div class="codehilite"><pre><span class="nd">@Autowired</span>
<span class="n">MiaoshaUserService</span> <span class="n">userService</span><span class="o">;</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/do_login&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">doLogin</span><span class="o">(</span><span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//..参数校验</span>
    <span class="c1">//登录</span>
    <span class="n">CodeMsg</span> <span class="n">code</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">loginVo</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">getCode</span><span class="o">()==</span><span class="mi">0</span><span class="o">)</span><span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;登录成功&quot;</span><span class="o">);</span>
    <span class="k">else</span> <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
</pre></div></p>
<h3 id="6jsr303">6.JSR303参数校验+全局异常<a class="headerlink" href="#6jsr303" title="Permanent link"></a></h3>
<p>不是每个controller的方法里都要写参数校验，而是把参数校验放到vo类上，在controller只要打注解</p>
<div class="codehilite"><pre><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-validation<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>

<p>在controller要校验的实体前打<code>@Valid</code>
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">doLogin</span><span class="o">(</span><span class="nd">@Valid</span>  <span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">)</span>
</pre></div>
在实体类加注解
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginVo</span> <span class="o">{</span>
<span class="nd">@NotNull</span>
<span class="nd">@Length</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">32</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
</pre></div></p>
<h4 id="_3">自定义注解<a class="headerlink" href="#_3" title="Permanent link"></a></h4>
<p>对手机号添加自定义验证注解
新建<code>validator</code>包,新建<code>IsMobile.java</code>
参考<code>java.validation.constrains</code>里的<code>NotNull</code>,
必须的，添加
来自<code>Constraint.java</code>的注释：
<div class="codehilite"><pre><span class="n">Each</span> <span class="n">constraint</span> <span class="n">annotation</span> <span class="n">must</span> <span class="n">host</span> <span class="n">the</span> <span class="n">following</span> <span class="n">attributes</span><span class="o">:</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="o">[...];</span> <span class="n">which</span> <span class="n">should</span> <span class="k">default</span> <span class="n">to</span> <span class="n">an</span> <span class="n">error</span> <span class="n">message</span> <span class="n">key</span> <span class="n">made</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fully</span><span class="o">-</span><span class="n">qualified</span> <span class="kd">class</span> <span class="nc">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">constraint</span> <span class="n">followed</span> <span class="n">by</span> <span class="o">.</span><span class="na">message</span><span class="o">.</span> <span class="n">For</span> <span class="n">example</span> <span class="s">&quot;{com.acme.constraints.NotSafe.message}&quot;</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span> <span class="k">for</span> <span class="n">user</span> <span class="n">to</span> <span class="n">customize</span> <span class="n">the</span> <span class="n">targeted</span> <span class="n">groups</span>
    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span> <span class="k">for</span> <span class="n">extensibility</span> <span class="n">purposes</span>
</pre></div></p>
<div class="codehilite"><pre><span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">,</span> <span class="n">CONSTRUCTOR</span><span class="o">,</span> <span class="n">PARAMETER</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="c1">// 注解实现类</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span><span class="n">IsMobileValidator</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">IsMobile</span><span class="o">{</span>
    <span class="c1">//不能为空</span>
    <span class="kt">boolean</span> <span class="nf">required</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>
    <span class="c1">//默认信息</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">&quot;手机号码格式错误&quot;</span><span class="o">;</span>

    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>

    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>
<span class="o">}</span>
</pre></div>

<h4 id="_4">注解实现类<a class="headerlink" href="#_4" title="Permanent link"></a></h4>
<p>新建类<code>IsMobileValidator</code>并在<code>@interface</code>里添加<code>@Constraint(validatedBy = {IsMobileValidator.class})</code></p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Constraint</span> <span class="o">{</span>
    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">ConstraintValidator</span><span class="o">&lt;?,</span> <span class="o">?&gt;&gt;[]</span> <span class="n">validatedBy</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>

<p>创建类&lt;注解,检测的类型&gt;，用上之前创建的ValidatorUtil
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MobileValidator</span> <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">IsMobile</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">//成员变量，接收注解定义</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">IsMobile</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//初始化方法里可以获取注解对象</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">required</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">required</span><span class="o">){</span>
            <span class="c1">//初始化获取注解 传的值 如果是必须的，判断是否合法</span>
            <span class="k">return</span> <span class="n">ValidatorUtil</span><span class="o">.</span><span class="na">isMobile</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="c1">//如果不是必须的</span>
            <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">value</span><span class="o">)){</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>

        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="k">return</span> <span class="n">ValidatorUtil</span><span class="o">.</span><span class="na">isMobile</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
            <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
在LoginVo上加上
<div class="codehilite"><pre><span class="nd">@NotNull</span>
<span class="nd">@Mobile</span><span class="o">(</span><span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">message</span> <span class="o">=</span> <span class="s">&quot;手机号错&quot;</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">mobile</span><span class="o">;</span>
</pre></div>
返回controller的doLogin可以删掉之前的非空检验参数校验
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/do_login&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">doLogin</span><span class="o">(</span><span class="nd">@Valid</span>  <span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">loginVo</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="c1">// 登录</span>
    <span class="n">CodeMsg</span> <span class="n">code</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">loginVo</span><span class="o">);</span>
    <span class="c1">// 如果有异常会给异常controller处理</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;登录成功&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
可以得到完整错误信息 绑定异常
<img alt="errormsg.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/errormsg.jpg" /></p>
<h4 id="_5">异常处理<a class="headerlink" href="#_5" title="Permanent link"></a></h4>
<p>错误处理新建exception包
添加<code>@ControllerAdvice</code> 和controller是一样的 
<div class="codehilite"><pre><span class="nd">@ControllerAdvice</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BindExceptionHandler</span> <span class="o">{</span>
    <span class="c1">// 拦截所有异常</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">bindexp</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="c1">// 刚刚手机号错报的绑定异常</span>
        <span class="k">if</span><span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">BindException</span><span class="o">){</span>
            <span class="n">BindException</span> <span class="n">ex</span> <span class="o">=</span> <span class="o">(</span><span class="n">BindException</span><span class="o">)</span> <span class="n">e</span><span class="o">;</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">ObjectError</span><span class="o">&gt;</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getAllErrors</span><span class="o">();</span>
            <span class="n">ObjectError</span> <span class="n">objectError</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">defaultMessage</span> <span class="o">=</span> <span class="n">objectError</span><span class="o">.</span><span class="na">getDefaultMessage</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">BIND_ERROR</span><span class="o">.</span><span class="na">fillArgs</span><span class="o">(</span><span class="n">defaultMessage</span><span class="o">));</span>

        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="c1">//通用异常</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="_6">定义传参的错误信息<a class="headerlink" href="#_6" title="Permanent link"></a></h4>
<p>可传递参数的错误信息，原来定义的枚举类不能new 所以不用枚举了
<code>CodeMsg.BIND_ERROR.fillArgs(msg)</code>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span>  <span class="nc">CodeMsg</span> <span class="o">{</span>
    <span class="kd">private</span>  <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">String</span> <span class="n">msg</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nf">CodeMsg</span><span class="o">(</span> <span class="kt">int</span> <span class="n">code</span><span class="o">,</span><span class="n">String</span> <span class="n">msg</span> <span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//通用的错误码</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">SUCCESS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">&quot;success&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">SERVER_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500100</span><span class="o">,</span> <span class="s">&quot;服务端异常&quot;</span><span class="o">);</span>
    <span class="c1">// 绑定异常</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">BIND_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500101</span><span class="o">,</span> <span class="s">&quot;参数校验异常：%s&quot;</span><span class="o">);</span>
    <span class="c1">//登录模块 5002XX</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">SESSION_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500210</span><span class="o">,</span> <span class="s">&quot;Session不存在或者已经失效&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">PASSWORD_EMPTY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500211</span><span class="o">,</span> <span class="s">&quot;登录密码不能为空&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MOBILE_EMPTY</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500212</span><span class="o">,</span> <span class="s">&quot;手机号不能为空&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MOBILE_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500213</span><span class="o">,</span> <span class="s">&quot;手机号格式错误&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MOBILE_NOT_EXIST</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500214</span><span class="o">,</span> <span class="s">&quot;手机号不存在&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">PASSWORD_ERROR</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500215</span><span class="o">,</span> <span class="s">&quot;密码错误&quot;</span><span class="o">);</span>
    <span class="c1">//参数校验异常：%s</span>
    <span class="kd">public</span> <span class="n">CodeMsg</span> <span class="nf">fillArgs</span><span class="o">(</span><span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">code</span><span class="o">;</span>
        <span class="c1">// this 关键</span>
        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">msg</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="n">code</span><span class="o">,</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
测试：200返回<code>{"code":500101,"msg":"参数校验异常：手机号错","data":null}</code></p>
<h5 id="_7">定义系统全局异常<a class="headerlink" href="#_7" title="Permanent link"></a></h5>
<p>业务模块<code>MiaoshaUserService</code>中的<code>public CodeMsg login(LoginVo loginVo)</code>方法，不应该返回CodeMsg，应该定义系统全局异常(业务异常)
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlobalException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span><span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">CodeMsg</span> <span class="n">cm</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GlobalException</span><span class="o">(</span><span class="n">CodeMsg</span> <span class="n">cm</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">cm</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">;</span>
    <span class="o">}</span><span class="c1">//get</span>
<span class="o">}</span>
</pre></div>
<code>MiaoshaUserService.java</code>
修改业务代码直接抛异常而不是返回CodeMsg
<div class="codehilite"><pre><span class="c1">// 返回业务含义的 登陆 true false</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">login</span><span class="o">(</span><span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">loginVo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">GlobalException</span><span class="o">(</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">mobile</span> <span class="o">=</span> <span class="n">loginVo</span><span class="o">.</span><span class="na">getMobile</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">formPass</span> <span class="o">=</span> <span class="n">loginVo</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
    <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">getById</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">mobile</span><span class="o">));</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//用户/手机号不存在</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">GlobalException</span><span class="o">(</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">MOBILE_NOT_EXIST</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//数据库中的密码,salt</span>
    <span class="n">String</span> <span class="n">dbPass</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">saltDB</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">();</span>
<span class="c1">//      用前端密码+数据库salt是否等于数据库密码</span>
    <span class="n">String</span> <span class="n">calcPass</span> <span class="o">=</span> <span class="n">MD5Util</span><span class="o">.</span><span class="na">formPassToDBPass</span><span class="o">(</span><span class="n">formPass</span><span class="o">,</span> <span class="n">saltDB</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">calcPass</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">dbPass</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">calcPass</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">dbPass</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">GlobalException</span><span class="o">(</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">PASSWORD_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
添加全局异常处理,注意合并成一个异常处理，不要覆盖
// todo 应该先小异常还是先大异常
<div class="codehilite"><pre><span class="nd">@ControllerAdvice</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GlobalExceptionHandler</span> <span class="o">{</span>
    <span class="nd">@ExceptionHandler</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="n">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">exceptionHandler</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">GlobalException</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">GlobalException</span> <span class="n">ex</span> <span class="o">=</span> <span class="o">(</span><span class="n">GlobalException</span><span class="o">)</span><span class="n">e</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">ex</span><span class="o">.</span><span class="na">getCm</span><span class="o">());</span>
        <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">BindException</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">BindException</span> <span class="n">ex</span> <span class="o">=</span> <span class="o">(</span><span class="n">BindException</span><span class="o">)</span><span class="n">e</span><span class="o">;</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">ObjectError</span><span class="o">&gt;</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">getAllErrors</span><span class="o">();</span>
            <span class="n">ObjectError</span> <span class="n">error</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="na">getDefaultMessage</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">BIND_ERROR</span><span class="o">.</span><span class="na">fillArgs</span><span class="o">(</span><span class="n">msg</span><span class="o">));</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
修改controllor中service的返回值，异常已经处理了，不用返回值
<div class="codehilite"><pre><span class="n">userService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">loginVo</span><span class="o">);</span>
<span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;登录成功&quot;</span><span class="o">);</span>
</pre></div></p>
<h3 id="7session">7.分布式Session<a class="headerlink" href="#7session" title="Permanent link"></a></h3>
<p>1.容器session同步 比较复杂
2.登陆成功后生成token(sessionID)写到cookie传递给客户端，客户端每次访问上传cookie,服务器根据token找到user对象</p>
<p>新建生成ID的类
用uuid，原生UUID带‘-’，去掉
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UUIDUtil</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">uuid</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;-&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
service中login比对密码正确后，生成token，并写到<code>redis</code>中</p>
<p>在service中引入<code>redisService</code>，设置cookie中的token name
<div class="codehilite"><pre><span class="c1">// cookie key</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">COOKI_NAME_TOKEN</span> <span class="o">=</span> <span class="s">&quot;token&quot;</span><span class="o">;</span>
<span class="nd">@Autowired</span>
<span class="n">RedisService</span> <span class="n">redisService</span><span class="o">;</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">login</span><span class="o">(</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span><span class="nd">@Valid</span> <span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">loginVo</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;loginvonull&quot;</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">GlobalException</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SERVER_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">mobile</span> <span class="o">=</span> <span class="n">loginVo</span><span class="o">.</span><span class="na">getMobile</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">formPass</span> <span class="o">=</span> <span class="n">loginVo</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
    <span class="c1">//判断手机号是否存在</span>

    <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">getById</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">mobile</span><span class="o">));</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">GlobalException</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MOBILE_NOT_EXIST</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//验证密码</span>
    <span class="n">String</span> <span class="n">dbPass</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">saltDB</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">();</span>
    <span class="n">String</span> <span class="n">calcPass</span> <span class="o">=</span> <span class="n">MD5Util</span><span class="o">.</span><span class="na">formPassToDBPass</span><span class="o">(</span><span class="n">formPass</span><span class="o">,</span> <span class="n">saltDB</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">calcPass</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">dbPass</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">GlobalException</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">PASSWORD_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//生成cookie</span>
    <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">UUIDUtil</span><span class="o">.</span><span class="na">uuid</span><span class="o">();</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="n">COOKI_NAME_TOKEN</span><span class="o">,</span><span class="n">token</span><span class="o">);</span>
    <span class="c1">// 有效期 与redis中session有效期保持一致</span>
    <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">token</span><span class="o">.</span><span class="na">expireSeconds</span><span class="o">());</span>
    <span class="c1">// 网站根目录 注意不是 ./</span>
    <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">);</span>
     <span class="c1">//写到response要HttpResponse</span>
    <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>在<code>\redis\</code>新建<code>MiaoshaUserKey</code>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaUserKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span><span class="o">{</span>
    <span class="kd">public</span> <span class="nf">MiaoshaUserKey</span><span class="o">(</span><span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">tokenKey</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">tokenKey</span><span class="o">(</span><span class="s">&quot;tk&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>修改login controller 里也要添加<code>HttpServletResponse response</code>
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/do_login&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">doLogin</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span><span class="nd">@Valid</span>  <span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">loginVo</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
     <span class="n">userService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">response</span><span class="o">,</span><span class="n">loginVo</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;登录成功&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="_8">登录成功跳转页<a class="headerlink" href="#_8" title="Permanent link"></a></h4>
<p>注意语法
<div class="codehilite"><pre><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>商品列表<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;&#39;hello:&#39;+${user.nickname}&quot;</span> <span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
创建新的controller类
<div class="codehilite"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/goods&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsController</span> <span class="o">{</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/to_list&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;goods_list&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
login.html ajax成功后跳转
<div class="codehilite"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/login/do_login&quot;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">mobile</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#mobile&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="nx">password</span><span class="o">:</span> <span class="nx">password</span>
    <span class="p">},</span>
    <span class="nx">success</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="nx">layer</span><span class="p">.</span><span class="nx">closeAll</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;成功&quot;</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/goods/to_list&quot;</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">error</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">layer</span><span class="p">.</span><span class="nx">closeAll</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div></p>
<p>测试：登录后可以显示:hello:null
查看do_login的response
<code>Set-Cookie: token=1701f466f2904a568aa364d6992828eb; Max-Age=0; Expires=Thu, 01-Jan-1970 00:00:10 GMT; Path=./</code></p>
<p>因为<code>Max-Age=0</code>所以to_list没有上传cookie
给cookie设置默认有效期
<code>MiaoshaUserKey.java</code></p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaUserKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TOKEN_EXPIRE</span> <span class="o">=</span> <span class="mi">3600</span><span class="o">*</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>

    <span class="c1">// 构造函数里加上过期时间</span>
    <span class="kd">public</span> <span class="nf">MiaoshaUserKey</span><span class="o">(</span><span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">,</span><span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span><span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 调用构造函数</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MiaoshaUserKey</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaUserKey</span><span class="o">(</span><span class="n">TOKEN_EXPIRE</span><span class="o">,</span><span class="s">&quot;tk&quot;</span><span class="o">);</span>
</pre></div>

<p>测试：do login的response
<code>Set-Cookie: token=38407e1482e246519727d0041bbd781c; Max-Age=172800; Expires=Tue, 23-Oct-2018 11:07:50 GMT; Path=/</code>
tolist 里会带着
<code>Cookie: token=38407e1482e246519727d0041bbd781c</code></p>
<p>public方法一定要做参数校验</p>
<p>实现用token从redis中得到MiaoshaUser
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">MiaoshaUser</span> <span class="nf">getByToken</span><span class="o">(</span> <span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">MiaoshaUser</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div></p>
<p>controller：
有的手机端会放到参数里传不在cookie里。设置优先级
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/to_list&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">toLogin</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span>
                      <span class="nd">@CookieValue</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">MiaoshaUserService</span><span class="o">.</span><span class="na">COOKI_NAME_TOKEN</span><span class="o">,</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span><span class="n">String</span> <span class="n">cookieToken</span><span class="o">,</span>
                      <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">MiaoshaUserService</span><span class="o">.</span><span class="na">COOKI_NAME_TOKEN</span><span class="o">,</span><span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span><span class="n">String</span> <span class="n">paramToken</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">cookieToken</span><span class="o">)&amp;&amp;</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">paramToken</span><span class="o">)){</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;没获取到&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">paramToken</span><span class="o">)?</span><span class="n">cookieToken</span><span class="o">:</span><span class="n">paramToken</span><span class="o">;</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;获取到了token&quot;</span><span class="o">);</span>
    <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">getByToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;获取到了用户&quot;</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;goods_list&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="session">session内登陆时延长有效期<a class="headerlink" href="#session" title="Permanent link"></a></h4>
<p>每次response里都有set-cookie</p>
<p>把生成cookie的代码独立成一个方法：
<div class="codehilite"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addCookie</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="n">COOKI_NAME_TOKEN</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
    <span class="n">cookie</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">token</span><span class="o">.</span><span class="na">expireSeconds</span><span class="o">());</span>
    <span class="n">cookie</span><span class="o">.</span><span class="na">setPath</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">);</span>
    <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>每次token-&gt;User的时候重新对response更新cookie </p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">MiaoshaUser</span> <span class="nf">getByToken</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">String</span> <span class="n">token</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">MiaoshaUser</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">//      延长有效期</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addCookie</span><span class="o">(</span><span class="n">response</span><span class="o">,</span><span class="n">token</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

<p>在controller加response</p>
<h4 id="session_1">判断登陆session的代码独立出来<a class="headerlink" href="#session_1" title="Permanent link"></a></h4>
<p>实现效果：每个Controller不用验证登陆，只需要注入一个User。
相当于实现一个ArgumentResolver
新建包config 
<code>WebConfig.java</code>
参数通过框架回调<code>WebMvcConfigurerAdapter</code>的<code>addArgumentResolvers</code> </p>
<p>addArgumentResolvers 是spring MVC里controller中可以带很多参数，都是框架回调这个方法给controller赋值的。
所以只需要遍历方法的参数，如果有User这个参数，就赋值。</p>
<p>添加一个Resolver</p>
<p>赋值
<div class="codehilite"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfig</span>  <span class="kd">extends</span> <span class="n">WebMvcConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserArgumentResolver</span> <span class="n">userArgumentResolver</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addArgumentResolvers</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">HandlerMethodArgumentResolver</span><span class="o">&gt;</span> <span class="n">argumentResolvers</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">argumentResolvers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userArgumentResolver</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserArgumentResolver</span> <span class="kd">implements</span> <span class="n">HandlerMethodArgumentResolver</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">MiaoshaUserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supportsParameter</span><span class="o">(</span><span class="n">MethodParameter</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 获取参数类型 是User类型才会做resolveArgument</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="na">getParameterType</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">clazz</span><span class="o">==</span><span class="n">MiaoshaUser</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">resolveArgument</span><span class="o">(</span><span class="n">MethodParameter</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">ModelAndViewContainer</span> <span class="n">mavContainer</span><span class="o">,</span>
        <span class="n">NativeWebRequest</span> <span class="n">webRequest</span><span class="o">,</span> 
        <span class="n">WebDataBinderFactory</span> <span class="n">binderFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 1. request 和 response</span>
        <span class="n">HttpServletRequest</span> <span class="n">request</span> <span class="o">=</span> <span class="n">webRequest</span><span class="o">.</span><span class="na">getNativeRequest</span><span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">HttpServletResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">webRequest</span><span class="o">.</span><span class="na">getNativeResponse</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// 2. 浏览器不同 token可能在cookie里也可能在参数里</span>
        <span class="n">String</span> <span class="n">paramToken</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">MiaoshaUserService</span><span class="o">.</span><span class="na">COOKI_NAME_TOKEN</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">cookieToken</span> <span class="o">=</span> <span class="n">getCookieValue</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">MiaoshaUserService</span><span class="o">.</span><span class="na">COOKI_NAME_TOKEN</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">cookieToken</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">paramToken</span><span class="o">)){</span><span class="k">return</span> <span class="kc">null</span><span class="o">;}</span>
        <span class="c1">// 3. 根据客户端token获取user</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">paramToken</span><span class="o">)?</span><span class="n">cookieToken</span><span class="o">:</span><span class="n">paramToken</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getByToken</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**</span>
<span class="cm">     * 遍历request里的所有cookie 找到对应那个的value</span>
<span class="cm">     * @param request</span>
<span class="cm">     * @param cookiName</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getCookieValue</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">cookiName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Cookie</span><span class="o">[]</span>  <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">cookiName</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h5 id="webmvcconfigureradapter-5">WebMvcConfigurerAdapter 已经被5弃用了（？）<a class="headerlink" href="#webmvcconfigureradapter-5" title="Permanent link"></a></h5>
<p><code>public void configureContentNegotiation(ContentNegotiationConfigurer configurer)</code>内容协商：对象-&gt;Json
<code>public void addInterceptors(InterceptorRegistry registry)</code> 拦截器
<code>public void addResourceHandlers(ResourceHandlerRegistry registry)</code> 资源处理器
<code>public void addCorsMappings(CorsRegistry registry)</code> 跨域</p>
<p>可以删掉controller里检测登陆的代码：
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/to_list&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">toLogin</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;goods_list&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>完成分布式session</p>
<hr />
<h3 id="8">8.商品列表详情页 秒杀功能<a class="headerlink" href="#8" title="Permanent link"></a></h3>
<p>秒杀商品表、秒杀订单表 要独立，因为变化大
新建数据库
<div class="codehilite"><pre><span class="k">create</span> <span class="k">table</span> <span class="o">`</span><span class="n">goods</span><span class="o">`</span><span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="n">AUTO_INCREMENT</span> <span class="k">comment</span> <span class="s1">&#39;商品ID&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;商品名称&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_title</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;商品标题&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_img</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span><span class="s1">&#39;商品图片&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_detail</span><span class="o">`</span> <span class="n">longtext</span> <span class="k">comment</span> <span class="s1">&#39;商品详情介绍&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_price</span><span class="o">`</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">default</span> <span class="s1">&#39;0.00&#39;</span> <span class="k">comment</span> <span class="s1">&#39;商品单价&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_stock</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">default</span> <span class="s1">&#39;0&#39;</span> <span class="k">comment</span> <span class="s1">&#39;商品库存，-1表示没有限制&#39;</span><span class="p">,</span>

  <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="o">`</span><span class="n">miaosha_order</span><span class="o">`</span><span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="n">AUTO_INCREMENT</span> <span class="p">,</span>
  <span class="o">`</span><span class="n">user_id</span><span class="o">`</span> <span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;用户ID&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">order_id</span><span class="o">`</span> <span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;订单ID&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_id</span><span class="o">`</span> <span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span><span class="s1">&#39;商品ID&#39;</span><span class="p">,</span>

  <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>


<span class="k">create</span> <span class="k">table</span> <span class="o">`</span><span class="n">miaosha_goods</span><span class="o">`</span><span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="k">not</span> <span class="k">null</span> <span class="n">AUTO_INCREMENT</span> <span class="k">comment</span> <span class="s1">&#39;秒杀商品表&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_id</span><span class="o">`</span> <span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;商品id&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">miaosha_price</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">default</span> <span class="s1">&#39;0.00&#39;</span> <span class="k">comment</span> <span class="s1">&#39;秒杀&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">stock_count</span><span class="o">`</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span><span class="s1">&#39;库存数量&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">start_date</span><span class="o">`</span> <span class="n">DATETIME</span> <span class="k">DEFAULT</span>  <span class="k">NULL</span> <span class="k">comment</span> <span class="s1">&#39;秒杀开始时间&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">end_date</span><span class="o">`</span> <span class="n">DATETIME</span> <span class="k">DEFAULT</span>  <span class="k">NULL</span> <span class="k">comment</span> <span class="s1">&#39;秒杀结束时间&#39;</span><span class="p">,</span>

  <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>


<span class="k">create</span> <span class="k">table</span> <span class="o">`</span><span class="n">order_info</span><span class="o">`</span><span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="n">AUTO_INCREMENT</span> <span class="p">,</span>
  <span class="o">`</span><span class="n">user_id</span><span class="o">`</span> <span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;用户ID&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_id</span><span class="o">`</span> <span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span> <span class="s1">&#39;商品ID&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">delivery_addr_id</span><span class="o">`</span> <span class="nb">BIGINT</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span> <span class="k">comment</span><span class="s1">&#39;收获地址ID&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_name</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">DEFAULT</span>  <span class="k">NULL</span> <span class="k">comment</span> <span class="s1">&#39;冗余商品名称&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_count</span><span class="o">`</span> <span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span> <span class="k">comment</span> <span class="s1">&#39;商品数量&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">goods_price</span><span class="o">`</span> <span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0.00&#39;</span> <span class="k">comment</span> <span class="s1">&#39;商品单价&#39;</span><span class="p">,</span>

  <span class="o">`</span><span class="n">order_channel</span><span class="o">`</span> <span class="n">TINYINT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span> <span class="k">comment</span> <span class="s1">&#39;1pc,2android,3ios&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">status</span><span class="o">`</span> <span class="n">TINYINT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;0&#39;</span> <span class="k">comment</span> <span class="s1">&#39;订单状态，0新建未支付，1已支付，3已收货，4已退款，5已完成&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">create_date</span><span class="o">`</span> <span class="n">DATETIME</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">comment</span> <span class="s1">&#39;订单创建时间&#39;</span><span class="p">,</span>
  <span class="o">`</span><span class="n">pay_date</span><span class="o">`</span> <span class="n">DATETIME</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">comment</span> <span class="s1">&#39;支付时间&#39;</span><span class="p">,</span>

  <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span> <span class="o">=</span> <span class="mi">12</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</pre></div></p>
<p>建立对应的domain对象
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Goods</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">goodsName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">goodsTitle</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">goodsImg</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">goodsDetail</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Double</span> <span class="n">goodsPrice</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">goodsStock</span><span class="o">;</span>
    <span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaGoods</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">gooddsId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">stockCount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">startDate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">endDate</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderInfo</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">goodsId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">deliveryAddrId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">goodsName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">goodsCount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Double</span> <span class="n">goodsPrice</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">orderChannel</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">status</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createDate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">payDate</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaOrder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">orderId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">goodsId</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>创建<code>GoodsService.java</code>和对应的<code>GoodsDao</code></p>
<p>查找商品希望同时查找到miaosha_goods中的秒杀信息
建立vo
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodVo</span> <span class="kd">extends</span> <span class="n">Goods</span><span class="o">{</span>
    <span class="kd">private</span> <span class="n">Double</span> <span class="n">miaoshaPrice</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">stockCount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">startDate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Date</span> <span class="n">endDate</span><span class="o">;</span>
</pre></div>
dao
<div class="codehilite"><pre><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GoodsDao</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * 查找商品信息和秒杀信息(库存和秒杀时间)</span>
<span class="cm">     */</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">&quot;select g.*,mg.miaosha_price,mg.stock_count,mg.start_date,mg.end_date  from miaosha_goods mg left join goods g on mg.goods_id = g.id&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="nf">listGoodsVo</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
service: 显示商品列表
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">GoodsDao</span> <span class="n">goodsDao</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="nf">listGoodsVo</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">goodsDao</span><span class="o">.</span><span class="na">listGoodsVo</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>controller 中添加到页面
<div class="codehilite"><pre><span class="nd">@Autowired</span>
<span class="n">GoodsService</span> <span class="n">goodsService</span><span class="o">;</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/to_list&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">toLogin</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>

    <span class="c1">// 秒杀商品列表</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="n">goodVos</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">listGoodsVo</span><span class="o">();</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;goodsList&quot;</span><span class="o">,</span><span class="n">goodVos</span><span class="o">);</span>

    <span class="k">return</span> <span class="s">&quot;goods_list&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
在goods_list.html 添加遍历 在static下放img/iphoneX.png 数据库img存img/iphoneX.png
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel panel-default&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel-heading&quot;</span><span class="p">&gt;</span>秒杀商品列表<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodslist&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品名称<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品图片<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品原价<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>秒杀价<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>库存数量<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">td</span><span class="p">&gt;</span>详情<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span>  <span class="na">th:each</span><span class="o">=</span><span class="s">&quot;goods,goodsStat : ${goodsList}&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.goodsName}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{${goods.goodsImg}}&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;100&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;100&quot;</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.goodsPrice}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.miaoshaPrice}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.stockCount}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">th:href</span><span class="o">=</span><span class="s">&quot;&#39;/goods/to_detail/&#39;+${goods.id}&quot;</span><span class="p">&gt;</span>详情<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></p>
<p>测试：<a href="http://localhost:8080/goods/to_list">http://localhost:8080/goods/to_list</a> 可以看到表格</p>
<h4 id="_9">商品详情页 倒计时<a class="headerlink" href="#_9" title="Permanent link"></a></h4>
<p>为了防止数据库中id连号被遍历，一般使用<code>snowflake</code>算法</p>
<p>html里<code>/goods/to_detail/'+${goods.id}</code></p>
<p>根据商品ID查询单个goodVO信息 并显示当前时间和秒杀时间的倒计时 （为什么不返回未来时间而要返回剩余时间？）
controller:
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/to_detail/{goodsId}&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">detail</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                     <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>

    <span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;goods&quot;</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>

    <span class="kt">long</span> <span class="n">startAt</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getStartDate</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">endAt</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getEndDate</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="c1">// 0：没开始 2：结束 1：进行中</span>
    <span class="kt">int</span> <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// 倒计时</span>
    <span class="kt">int</span> <span class="n">remainSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">startAt</span> <span class="o">)</span> <span class="o">{</span><span class="c1">//秒杀还没开始，倒计时</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)((</span><span class="n">startAt</span> <span class="o">-</span> <span class="n">now</span> <span class="o">)/</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span><span class="k">else</span>  <span class="k">if</span><span class="o">(</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">endAt</span><span class="o">){</span><span class="c1">//秒杀已经结束</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="o">{</span><span class="c1">//秒杀进行中</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;miaoshaStatus&quot;</span><span class="o">,</span> <span class="n">miaoshaStatus</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;remainSeconds&quot;</span><span class="o">,</span> <span class="n">remainSeconds</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">&quot;goods_detail&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>service 和dao 显示商品详情
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">GoodVo</span> <span class="nf">getGoodsVoByGoodsId</span><span class="o">(</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">goodsDao</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="nd">@Select</span><span class="o">(</span><span class="s">&quot;select g.*,mg.miaosha_price,mg.stock_count,mg.start_date,mg.end_date  from miaosha_goods mg left join goods g on mg.goods_id = g.id where g.id = #{goodId}&quot;</span> <span class="o">)</span>
<span class="n">GoodVo</span> <span class="nf">getGoodsVoByGoodsId</span><span class="o">(</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">);</span>
</pre></div>
商品详情html：
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel panel-default&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel-heading&quot;</span><span class="p">&gt;</span>秒杀商品详情<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel-body&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${user eq null}&quot;</span><span class="p">&gt;</span> 您还没有登录，请登陆后再操作<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span>没有收货地址的提示。。。<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodslist&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品名称<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.goodsName}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span> 
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>  
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品图片<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{${goods.goodsImg}}&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>秒杀开始时间<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${#dates.format(goods.startDate, &#39;yyyy-MM-dd HH:mm:ss&#39;)}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;miaoshaTip&quot;</span><span class="p">&gt;</span>    
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;remainSeconds&quot;</span> <span class="na">th:value</span><span class="o">=</span><span class="s">&quot;${remainSeconds}&quot;</span> <span class="p">/&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${miaoshaStatus eq 0}&quot;</span><span class="p">&gt;</span>秒杀倒计时：<span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;countDown&quot;</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${remainSeconds}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>秒<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${miaoshaStatus eq 1}&quot;</span><span class="p">&gt;</span>秒杀进行中<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${miaoshaStatus eq 2}&quot;</span><span class="p">&gt;</span>秒杀已结束<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;miaoshaForm&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/miaosha/do_miaosha&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;buyButton&quot;</span><span class="p">&gt;</span>立即秒杀<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;goodsId&quot;</span> <span class="na">th:value</span><span class="o">=</span><span class="s">&quot;${goods.id}&quot;</span> <span class="p">/&gt;</span>
            <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品原价<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.goodsPrice}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>秒杀价<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.miaoshaPrice}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>库存数量<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.stockCount}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></p>
<p>倒计时：<code>&lt;span id="countDown" th:text="${remainSeconds}"&gt;&lt;/span&gt;秒&lt;/span&gt;</code>
设置隐藏域保留<code>remainSeconds</code>(controller添加的) 这样<code>miaoshaStatus</code>是1或者2 js也能取到时间
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;remainSeconds&quot;</span> <span class="na">th:value</span><span class="o">=</span><span class="s">&quot;${remainSeconds}&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${miaoshaStatus eq 0}&quot;</span><span class="p">&gt;</span>秒杀倒计时：<span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;countDown&quot;</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${remainSeconds}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>秒<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</pre></div></p>
<p>js判断remainSeconds 三种情况，设置标签颜色和倒计时
<div class="codehilite"><pre><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">countDown</span><span class="p">();</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">countDown</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">remainSeconds</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#remainSeconds&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">timeout</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">remainSeconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span><span class="c1">//秒杀还没开始，倒计时</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#buyButton&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#countDown&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">remainSeconds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#remainSeconds&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">remainSeconds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nx">countDown</span><span class="p">();</span>
        <span class="p">},</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">remainSeconds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span><span class="c1">//秒杀进行中</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#buyButton&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">timeout</span><span class="p">){</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#miaoshaTip&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;秒杀进行中&quot;</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="c1">//秒杀已经结束</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#buyButton&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#miaoshaTip&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;秒杀已经结束&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></p>
<p>测试：<a href="http://localhost:8080/goods/to_detail/1">http://localhost:8080/goods/to_detail/1</a></p>
<h4 id="_10">秒杀功能<a class="headerlink" href="#_10" title="Permanent link"></a></h4>
<p>用表单提交 传递的参数是商品id
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;miaoshaForm&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/miaosha/do_miaosha&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;buyButton&quot;</span><span class="p">&gt;</span>立即秒杀<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;goodsId&quot;</span> <span class="na">th:value</span><span class="o">=</span><span class="s">&quot;${goods.id}&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div></p>
<p>添加秒杀模块的Error Message
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MIAO_SHA_OVER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500500</span><span class="o">,</span> <span class="s">&quot;无库存&quot;</span><span class="o">);</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">REPEATE_MIAOSHA</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500501</span><span class="o">,</span> <span class="s">&quot;不能重复秒杀&quot;</span><span class="o">);</span>
</pre></div>
业务逻辑：
1. 判断登陆 -&gt; 登陆页面
2. 判断商品库存 -&gt; 秒杀失败
3. 判断用户是否已经秒杀过该商品 -&gt;秒杀失败 //todo 如果可以买好几件？
4. 事务：减库存 下单 加入秒杀订单 -&gt; 订单详情页
定义<code>OrderService</code> 用于查询用户订单是否已经买过这个商品</p>
<p>添加秒杀失败页面：
<div class="codehilite"><pre><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&quot;http://www.thymeleaf.org&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>秒杀失败<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
秒杀失败：<span class="p">&lt;</span><span class="nt">p</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${errmsg}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div></p>
<p>新建<code>MiaoshaController</code>
<div class="codehilite"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/miaosha&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">GoodsService</span> <span class="n">goodsService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">OrderService</span> <span class="n">orderService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">MiaoshaService</span> <span class="n">miaoshaService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/do_miaosha&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">list</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span> <span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                       <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="c1">// 没登陆</span>
        <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&quot;login&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//判断库存</span>
        <span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getStockCount</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">stock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;errmsg&quot;</span><span class="o">,</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">MIAO_SHA_OVER</span><span class="o">.</span><span class="na">getMsg</span><span class="o">());</span>
            <span class="k">return</span> <span class="s">&quot;miaosha_fail&quot;</span><span class="o">;</span>
        <span class="o">}</span>
<span class="c1">//      从用户订单查询是否已经对这个物品下过单了</span>
        <span class="n">MiaoshaOrder</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">goodsId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">order</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;errmsg&quot;</span><span class="o">,</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">REPEATE_MIAOSHA</span><span class="o">.</span><span class="na">getMsg</span><span class="o">());</span>
            <span class="k">return</span> <span class="s">&quot;miaosha_fail&quot;</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//1.减库存 2.下订单 3.写入秒杀订单 这三步是一个是事务</span>
        <span class="n">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">miaosha</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;orderInfo&quot;</span><span class="o">,</span> <span class="n">orderInfo</span><span class="o">);</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;goods&quot;</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&quot;order_detail&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>查订单 查询用户是否已经秒杀过该商品
dao: 用 用户id和商品id 查询对应的订单
<div class="codehilite"><pre><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderDao</span> <span class="o">{</span>

    <span class="nd">@Select</span><span class="o">(</span><span class="s">&quot;select * from miaosha_order where user_id=#{userId} and goods_id=#{goodsId}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">MiaoshaOrder</span> <span class="nf">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;userId&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div></p>
<p>OrderService: controller 里判断是不是非null
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">OrderDao</span> <span class="n">orderDao</span><span class="o">;</span>
    <span class="c1">// 根据用户ID和商品ID查找相应订单</span>
    <span class="kd">public</span> <span class="n">MiaoshaOrder</span> <span class="nf">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">orderDao</span><span class="o">.</span><span class="na">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>定义<code>MiaoshaService</code> 用于对1.减库存 2.下单 3.加入秒杀订单 包装成事务
MiaoshaService的miaosha方法减库存update如果失败，后面补应该继续写入订单
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">GoodsService</span> <span class="n">goodsService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">OrderService</span> <span class="n">orderService</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="n">OrderInfo</span> <span class="nf">miaosha</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span> <span class="n">GoodVo</span> <span class="n">goods</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">//减库存 下订单 写入秒杀订单</span>
        <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">reduceStock</span><span class="o">(</span><span class="n">goods</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">success</span><span class="o">){</span>
            <span class="c1">//order_info maiosha_order</span>
            <span class="k">return</span> <span class="n">orderService</span><span class="o">.</span><span class="na">createOrder</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>
        <span class="o">}</span>
       <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<ol>
<li>减少库存：查找miaosha商品ID并更新数据库：</li>
</ol>
<p>更新：通过GoodVo更新goods信息
要通过GoodsDao更新数据库，一般不引入其他Service，所以引入<code>GoodsService</code>
同理写订单不是调用OrderDao 而是 OrderService</p>
<p>减少库存的sql
<div class="codehilite"><pre><span class="nd">@Update</span><span class="o">(</span><span class="s">&quot;update miaosha_goods set stock_count = stock_count - 1 where goods_id = #{goodsId}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">reduceStock</span><span class="o">(</span><span class="n">MiaoshaGoods</span> <span class="n">g</span><span class="o">);</span>
</pre></div>
GoodsService:
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">GoodsDao</span> <span class="n">goodsDao</span><span class="o">;</span>

    <span class="c1">// 商品列表</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="nf">listGoodsVo</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">goodsDao</span><span class="o">.</span><span class="na">listGoodsVo</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// 商品详情</span>
    <span class="kd">public</span> <span class="n">GoodVo</span> <span class="nf">getGoodsVoByGoodsId</span><span class="o">(</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">goodsDao</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 减库存</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">reduceStock</span><span class="o">(</span><span class="n">GoodVo</span> <span class="n">goods</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">MiaoshaGoods</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaGoods</span><span class="o">();</span>
        <span class="n">g</span><span class="o">.</span><span class="na">setGooddsId</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="kt">int</span> <span class="n">rst</span> <span class="o">=</span> <span class="n">goodsDao</span><span class="o">.</span><span class="na">reduceStock</span><span class="o">(</span><span class="n">g</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">rst</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<ol>
<li>下单（生成订单）：生成订单Info
<code>OrderServece</code>
根据User，GoodVo 拼成OrderInfo
<div class="codehilite"><pre><span class="n">Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">OrderDao</span> <span class="n">orderDao</span><span class="o">;</span>

    <span class="c1">// 根据用户ID和商品ID查找相应订单</span>
    <span class="kd">public</span> <span class="n">MiaoshaOrder</span> <span class="nf">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">orderDao</span><span class="o">.</span><span class="na">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 根据用户和商品信息创建订单信息</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="n">OrderInfo</span> <span class="nf">createOrder</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span> <span class="n">GoodVo</span> <span class="n">goods</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderInfo</span><span class="o">();</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setCreateDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setDeliveryAddrId</span><span class="o">(</span><span class="mi">0L</span><span class="o">);</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setGoodsCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setGoodsId</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setGoodsName</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getGoodsName</span><span class="o">());</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setGoodsPrice</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getMiaoshaPrice</span><span class="o">());</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setOrderChannel</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">orderInfo</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="c1">// 数据库insert order表 mybatis成功之后会把id加到对象中</span>
        <span class="n">orderDao</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">);</span>
        <span class="n">MiaoshaOrder</span> <span class="n">miaoshaOrder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaOrder</span><span class="o">();</span>
        <span class="n">miaoshaOrder</span><span class="o">.</span><span class="na">setGoodsId</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">miaoshaOrder</span><span class="o">.</span><span class="na">setOrderId</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">miaoshaOrder</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="c1">// 数据库 miaoshaOrder表</span>
        <span class="n">orderDao</span><span class="o">.</span><span class="na">insertMiaoshaOrder</span><span class="o">(</span><span class="n">miaoshaOrder</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">orderInfo</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
Dao 插入两个订单并且有返回值
<div class="codehilite"><pre><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderDao</span> <span class="o">{</span>
    <span class="c1">// 用户id+商品id查找miaosha表订单信息</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">&quot;select * from miaosha_order where user_id=#{userId} and goods_id=#{goodsId}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">MiaoshaOrder</span> <span class="nf">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;userId&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="c1">// 创建订单</span>
    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&quot;insert into order_info(user_id, goods_id, goods_name, goods_count, goods_price, order_channel, status, create_date)values(&quot;</span>
            <span class="o">+</span> <span class="s">&quot;#{userId}, #{goodsId}, #{goodsName}, #{goodsCount}, #{goodsPrice}, #{orderChannel},#{status},#{createDate} )&quot;</span><span class="o">)</span>
    <span class="nd">@SelectKey</span><span class="o">(</span><span class="n">keyColumn</span><span class="o">=</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">keyProperty</span><span class="o">=</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">resultType</span><span class="o">=</span><span class="kt">long</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">before</span><span class="o">=</span><span class="kc">false</span><span class="o">,</span> <span class="n">statement</span><span class="o">=</span><span class="s">&quot;select last_insert_id()&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">insert</span><span class="o">(</span><span class="n">OrderInfo</span> <span class="n">orderInfo</span><span class="o">);</span>
    <span class="c1">// 创建秒杀订单</span>
    <span class="nd">@Insert</span><span class="o">(</span><span class="s">&quot;insert into miaosha_order (user_id, goods_id, order_id)values(#{userId}, #{goodsId}, #{orderId})&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insertMiaoshaOrder</span><span class="o">(</span><span class="n">MiaoshaOrder</span> <span class="n">miaoshaOrder</span><span class="o">);</span>

<span class="o">}</span>
</pre></div></li>
</ol>
<p>新建订单详情页：
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel panel-default&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel-heading&quot;</span><span class="p">&gt;</span>秒杀订单详情<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${orderInfo.getId()}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodslist&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品名称<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${goods.goodsName}&quot;</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span> 
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>  
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品图片<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">&gt;&lt;</span><span class="nt">img</span> <span class="na">th:src</span><span class="o">=</span><span class="s">&quot;@{${goods.goodsImg}}&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>订单价格<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${orderInfo.goodsPrice}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>下单时间<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&quot;${#dates.format(orderInfo.createDate, &#39;yyyy-MM-dd HH:mm:ss&#39;)}&quot;</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>订单状态<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${orderInfo.status eq 0}&quot;</span><span class="p">&gt;</span>未支付<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${orderInfo.status eq 1}&quot;</span><span class="p">&gt;</span>待发货<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${orderInfo.status eq 2}&quot;</span><span class="p">&gt;</span>已发货<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${orderInfo.status eq 3}&quot;</span><span class="p">&gt;</span>已收货<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${orderInfo.status eq 4}&quot;</span><span class="p">&gt;</span>已退款<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">th:if</span><span class="o">=</span><span class="s">&quot;${orderInfo.status eq 5}&quot;</span><span class="p">&gt;</span>已完成<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;payButton&quot;</span><span class="p">&gt;</span>立即支付<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>收货人<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">&gt;</span>XXX  18812341234<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>收货地址<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">&gt;</span>北京市昌平区回龙观龙博一区<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></p>
<p>访问：<a href="http://localhost:8080/goods/to_detail/1">http://localhost:8080/goods/to_detail/1</a> 会发送post带着goodId token里有用户
<a href="http://localhost:8080/miaosha/do_miaosha">http://localhost:8080/miaosha/do_miaosha</a> 完成秒杀</p>
<h3 id="10jmeterqps-wartomcat">10.JMeter测试QPS压测 打成war包放到tomcat服务器上<a class="headerlink" href="#10jmeterqps-wartomcat" title="Permanent link"></a></h3>
<p><a href="https://jmeter.apache.org/">https://jmeter.apache.org/</a>
1 压测商品列表页 
QPS说法：并发在1000的时候网站的QPS是1000或者500
TPS 每秒钟完成了20笔订单
<code>D:\apache-jmeter-5.0\bin\jmeter.bat</code>
TestPlan-右键-ADD-thread group
Number of Thread ： 10  线程数
Ramp-Up Period ： 10 用10秒把10个线程都启动起来</p>
<p>默认配置
对线程组右键-add-Config Element -Http request default
添加http和IP和端口</p>
<p>对线程组右键-add-sample-http请求
不用填 http ip 端口
方法get，path：/goods/to_list</p>
<p>对线程组右键-add-Listener-Aggregate Report
也可以添加 Graph Results</p>
<p><img alt="jmetermiaosha.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/jmetermiaosha.jpg" />
Average 平均花费时间 10ms
Throughput 可以当作qps 表示一秒能处理11.5个请求
添加监听器 View Results in Table
先把监听器都右键清空
<img alt="Jmetertable.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/Jmetertable.jpg" />
报错空指针 修改位置：
<code>UserArgumentResolver.java</code>
<div class="codehilite"><pre><span class="kd">private</span> <span class="n">String</span> <span class="nf">getCookieValue</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">cookiName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Cookie</span><span class="o">[]</span>  <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
        <span class="c1">// 添加空指针判断</span>
        <span class="k">if</span><span class="o">(</span><span class="n">cookies</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">cookies</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">cookiName</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</pre></div>
线程数1000的情况下 只有 35每秒qps
<img alt="onekjmeter.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/onekjmeter.jpg" />
打开数据库服务器的top
10000个线程 大概因为虚拟机所以压榨主机需要的更多 照理说应该load average会超过1
多核cpu负载超过表示很多进程在等待</p>
<p>压测用户对象
新建http request
path：/user/info
添加参数：token：ca5be550941349b7bb336f9451a41748</p>
<p>新建controller
<div class="codehilite"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/user&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">GoodsController</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/info&quot;</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">MiaoshaUser</span><span class="o">&gt;</span> <span class="nf">info</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
<img alt="userinfoqps.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/userinfoqps.jpg" />
报错消息：<code>JedisException: Could not get a resource from the pool</code>
redis获取不到连接
修改配置
<div class="codehilite"><pre><span class="c1"># redis</span>
redis.timeout<span class="o">=</span>10
redis.password<span class="o">=</span>123456
redis.poolMaxTotal<span class="o">=</span>1000
redis.poolMaxIdle<span class="o">=</span>500
spring.redis.pool.max-wait<span class="o">=</span>500
<span class="c1"># jdbc</span>
spring.datasource.maxActive<span class="o">=</span>1000
spring.datasource.initialSize<span class="o">=</span>100
spring.datasource.maxWait<span class="o">=</span>60000
spring.datasource.minIdle<span class="o">=</span>500
</pre></div>
不报错了
<img alt="userinfomax.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/userinfomax.jpg" /></p>
<p>比商品列表的qps高很多，因为redis在内存</p>
<p>多用户token测试
在Jmeter中添加CSV data set config 
在http请求里的参数是<code>${userToken}</code></p>
<p>在服务器上测试jmeter
1.在windows上录好jmx
2.运行<code>jmeter.sh -n -t xxx.jmx -l result.jtl</code>
3.把result.jtl导入jmeter</p>
<p>redis压测：
100个并发 100000个请求
<code>redis-benchmark -h 127.0.0.1 -p 6379 -c 100 -n 100000</code>
<div class="codehilite"><pre><span class="o">======</span> <span class="nv">GET</span> <span class="o">======</span>
  <span class="m">100000</span> requests completed in 2.55 seconds
  <span class="m">100</span> parallel clients
  <span class="m">3</span> bytes payload
  keep alive: 1

7.87% &lt;<span class="o">=</span> <span class="m">1</span> milliseconds
72.82% &lt;<span class="o">=</span> <span class="m">2</span> milliseconds
94.64% &lt;<span class="o">=</span> <span class="m">3</span> milliseconds
97.13% &lt;<span class="o">=</span> <span class="m">4</span> milliseconds
98.74% &lt;<span class="o">=</span> <span class="m">5</span> milliseconds
99.65% &lt;<span class="o">=</span> <span class="m">6</span> milliseconds
99.98% &lt;<span class="o">=</span> <span class="m">7</span> milliseconds
100.00% &lt;<span class="o">=</span> <span class="m">7</span> milliseconds
39277.30 requests per second
</pre></div>
1秒能4w get
<div class="codehilite"><pre><span class="o">[</span>root@localhost ~<span class="o">]</span><span class="c1"># redis-benchmark -h 127.0.0.1 -p 6379 -q -d 100</span>
PING_INLINE: 41806.02 requests per second
PING_BULK: 41858.52 requests per second
SET: 39184.95 requests per second
GET: 41736.23 requests per second
INCR: 41876.05 requests per second
</pre></div></p>
<h3 id="war">打war包<a class="headerlink" href="#war" title="Permanent link"></a></h3>
<div class="codehilite"><pre><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span class="nt">&lt;/artifactId&gt;</span>
  <span class="c">&lt;!--编译时需要 运行时不需要--&gt;</span>
  <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>


 <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;finalName&gt;</span>${project.artifactId}<span class="nt">&lt;/finalName&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-war-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;configuration&gt;</span>
          <span class="nt">&lt;failOnMissingWebXml&gt;</span>false<span class="nt">&lt;/failOnMissingWebXml&gt;</span>
        <span class="nt">&lt;/configuration&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
</pre></div>

<p>修改启动类
<div class="codehilite"><pre><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainApplication</span> <span class="kd">extends</span> <span class="n">SpringBootServletInitializer</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">MainApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="n">SpringApplicationBuilder</span> <span class="nf">configure</span><span class="o">(</span><span class="n">SpringApplicationBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">sources</span><span class="o">(</span><span class="n">MainApplication</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>命令行<code>mvn clean package</code>
把war放到tomcat里<code>D:\apache-tomcat-8.5.31\webapps</code> 启动<code>startup.bat</code>
访问<code>http://localhost:8080/miaoshaLearn/login/to_login</code>
真实部署的时候放到ROOT下面就不需要tomcat路径了</p>
<p>为了方便还是打jar包
war包插件改jar包的 注释掉tomcat的依赖
<div class="codehilite"><pre><span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</pre></div>
启动类还原
<div class="codehilite"><pre><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainApplication</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">MainApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
命令行<code>mvn clean package</code>
打开jar包 <code>META-INF\META-INF</code>
<div class="codehilite"><pre><span class="n">Main</span><span class="o">-</span><span class="n">Class</span><span class="o">:</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">loader</span><span class="o">.</span><span class="na">JarLauncher</span>
<span class="n">Start</span><span class="o">-</span><span class="n">Class</span><span class="o">:</span> <span class="n">com</span><span class="o">.</span><span class="na">cloud</span><span class="o">.</span><span class="na">miaosha</span><span class="o">.</span><span class="na">MainApplication</span>
<span class="n">Spring</span><span class="o">-</span><span class="n">Boot</span><span class="o">-</span><span class="n">Classes</span><span class="o">:</span> <span class="n">BOOT</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">classes</span><span class="o">/</span>
<span class="n">Spring</span><span class="o">-</span><span class="n">Boot</span><span class="o">-</span><span class="n">Lib</span><span class="o">:</span> <span class="n">BOOT</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span>
</pre></div></p>
<p>上传jar包到linux
<code>nohup java -jar miaosha.jar &amp;</code>
访问：<code>http://10.1.18.133:8080/goods/to_list</code></p>
<p>上传jmeter和jmx文件到linux
<div class="codehilite"><pre>chmod <span class="m">777</span>  jmeter.sh
chmod <span class="m">777</span>  jmeter
</pre></div></p>
<p>生成测试用户：
用<code>HttpURLConnection</code> 发送post
<div class="codehilite"><pre><span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">urlString</span><span class="o">);</span>
<span class="n">HttpURLConnection</span> <span class="n">co</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span><span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
<span class="n">co</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">&quot;POST&quot;</span><span class="o">);</span>
<span class="n">co</span><span class="o">.</span><span class="na">setDoOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
<span class="n">String</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;mobile=&quot;</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span><span class="s">&quot;&amp;password=&quot;</span><span class="o">+</span><span class="n">MD5Util</span><span class="o">.</span><span class="na">inputPassToFormPass</span><span class="o">(</span><span class="s">&quot;123456&quot;</span><span class="o">);</span>
<span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
<span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
<span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
<span class="n">ByteArrayOutputStream</span> <span class="n">bout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
<span class="kt">byte</span> <span class="n">buff</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">while</span><span class="o">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buff</span><span class="o">)</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="o">)){</span>
    <span class="n">bout</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buff</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">len</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">bout</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">bout</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
<span class="c1">//fast json解析并获取token</span>
</pre></div></p>
<p>修改login返回token
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/do_login&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">doLogin</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span><span class="nd">@Valid</span>  <span class="n">LoginVo</span> <span class="n">loginVo</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">loginVo</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="c1">//        登录</span>
    <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">loginVo</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;登陆成功&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>dbutil
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DBUtil</span> <span class="o">{</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">Properties</span> <span class="n">props</span><span class="o">;</span>

<span class="kd">static</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">DBUtil</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;application.properties&quot;</span><span class="o">);</span>
        <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
        <span class="n">props</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="n">Connection</span> <span class="nf">getConn</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
    <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;spring.datasource.url&quot;</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;spring.datasource.username&quot;</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;spring.datasource.password&quot;</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">driver</span> <span class="o">=</span> <span class="n">props</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;spring.datasource.driver-class-name&quot;</span><span class="o">);</span>
    <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">driver</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">}</span>
</pre></div>
删除数据库
<div class="codehilite"><pre><span class="k">delete</span> <span class="k">from</span> <span class="n">miaosha_user</span> <span class="k">where</span> <span class="n">nickname</span> <span class="k">like</span> <span class="s1">&#39;user%&#39;</span><span class="p">;</span>
</pre></div></p>
<p>userutil
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserUtil</span> <span class="o">{</span>  
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">MiaoshaUser</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">MiaoshaUser</span><span class="o">&gt;(</span><span class="n">count</span><span class="o">);</span>
        <span class="c1">//生成用户</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">count</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaUser</span><span class="o">();</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">13000000000L</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setLoginCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setNickname</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setRegisterDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setSalt</span><span class="o">(</span><span class="s">&quot;1a2b3c&quot;</span><span class="o">);</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">MD5Util</span><span class="o">.</span><span class="na">inputPassToDbPass</span><span class="o">(</span><span class="s">&quot;123456&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">()));</span>
            <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;create user&quot;</span><span class="o">);</span>
<span class="c1">//      //插入数据库</span>
        <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">DBUtil</span><span class="o">.</span><span class="na">getConn</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;insert into miaosha_user(login_count, nickname, register_date, salt, password, id)values(?,?,?,?,?,?)&quot;</span><span class="o">;</span>
        <span class="n">PreparedStatement</span> <span class="n">pstmt</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">users</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getLoginCount</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getNickname</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setTimestamp</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="k">new</span> <span class="n">Timestamp</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getRegisterDate</span><span class="o">().</span><span class="na">getTime</span><span class="o">()));</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">setLong</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="n">pstmt</span><span class="o">.</span><span class="na">addBatch</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">pstmt</span><span class="o">.</span><span class="na">executeBatch</span><span class="o">();</span>
        <span class="n">pstmt</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;insert to db&quot;</span><span class="o">);</span>
        <span class="c1">//登录，生成token</span>
        <span class="n">String</span> <span class="n">urlString</span> <span class="o">=</span> <span class="s">&quot;http://localhost:8080/login/do_login&quot;</span><span class="o">;</span>
        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;D:/miaoshaLearn/tokens.txt&quot;</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">file</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">RandomAccessFile</span> <span class="n">raf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RandomAccessFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="s">&quot;rw&quot;</span><span class="o">);</span>
        <span class="n">file</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">users</span><span class="o">.</span><span class="na">size</span><span class="o">();</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">urlString</span><span class="o">);</span>
            <span class="n">HttpURLConnection</span> <span class="n">co</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">)</span><span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>
            <span class="n">co</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">&quot;POST&quot;</span><span class="o">);</span>
            <span class="n">co</span><span class="o">.</span><span class="na">setDoOutput</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">params</span> <span class="o">=</span> <span class="s">&quot;mobile=&quot;</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span><span class="s">&quot;&amp;password=&quot;</span><span class="o">+</span><span class="n">MD5Util</span><span class="o">.</span><span class="na">inputPassToFormPass</span><span class="o">(</span><span class="s">&quot;123456&quot;</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">params</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
            <span class="n">ByteArrayOutputStream</span> <span class="n">bout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="kt">byte</span> <span class="n">buff</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span><span class="o">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buff</span><span class="o">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">bout</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buff</span><span class="o">,</span> <span class="mi">0</span> <span class="o">,</span><span class="n">len</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">bout</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">bout</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
            <span class="n">JSONObject</span> <span class="n">jo</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">jo</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;data&quot;</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;create token : &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>

            <span class="n">String</span> <span class="n">row</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span><span class="s">&quot;,&quot;</span><span class="o">+</span><span class="n">token</span><span class="o">;</span>
            <span class="n">raf</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">raf</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
            <span class="n">raf</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="n">raf</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">&quot;\r\n&quot;</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;write to file : &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">raf</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;over&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span><span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">createUser</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
// 1300</p>
<h3 id="htmlredissb">页面缓存 商品列表页是把html直接存在redis里,SB渲染返回<a class="headerlink" href="#htmlredissb" title="Permanent link"></a></h3>
<p>页面静态化：前后端分离，通过ajax渲染页面
浏览器会把html缓存在客户端，页面数据不需要重复下载，只下载动态数据</p>
<p>Redis 页面缓存key 一般页面缓存比较短，不然看不到页面变化
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nf">GoodsKey</span><span class="o">(</span><span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">,</span> <span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span> <span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">GoodsKey</span> <span class="n">getGoodsList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GoodsKey</span><span class="o">(</span><span class="mi">60</span><span class="o">,</span> <span class="s">&quot;gl&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">GoodsKey</span> <span class="n">getGoodsDetail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GoodsKey</span><span class="o">(</span><span class="mi">60</span><span class="o">,</span> <span class="s">&quot;gd&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p><div class="codehilite"><pre><span class="nd">@Autowired</span>
<span class="n">ThymeleafViewResolver</span> <span class="n">thymeleafViewResolver</span><span class="o">;</span>

<span class="nd">@Autowired</span>
<span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>

<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/to_list&quot;</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="s">&quot;txt/html&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">toLogin</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Model</span> <span class="n">model</span><span class="o">,</span> <span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
    <span class="c1">// 取页面缓存</span>
    <span class="n">String</span> <span class="n">html</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getGoodsList</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">html</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">html</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 秒杀商品列表</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="n">goodVos</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">listGoodsVo</span><span class="o">();</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;goodsList&quot;</span><span class="o">,</span><span class="n">goodVos</span><span class="o">);</span>
    <span class="n">SpringWebContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringWebContext</span><span class="o">(</span><span class="n">request</span><span class="o">,</span><span class="n">response</span><span class="o">,</span>
            <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">(),</span><span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">(),</span> <span class="n">model</span><span class="o">.</span><span class="na">asMap</span><span class="o">(),</span> <span class="n">applicationContext</span> <span class="o">);</span>
    <span class="c1">//手动渲染</span>
    <span class="c1">// 模板名称 context</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">thymeleafViewResolver</span><span class="o">.</span><span class="na">getTemplateEngine</span><span class="o">().</span><span class="na">process</span><span class="o">(</span><span class="s">&quot;goods_list&quot;</span><span class="o">,</span> <span class="n">ctx</span><span class="o">);</span>

    <span class="c1">// 缓存起来</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">html</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getGoodsList</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span> <span class="n">html</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">&quot;goods_list&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<a href="http://localhost:8080/goods/to_list">http://localhost:8080/goods/to_list</a>
连上redis 查看keys GoodsKey:gl</p>
<h3 id="url">URL缓存 详情页缓存<a class="headerlink" href="#url" title="Permanent link"></a></h3>
<p>和页面缓存一样，通过整个html用sb渲染返回，每个页面缓存时间60s
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/to_detail/{goodsId}&quot;</span><span class="o">,</span><span class="n">produces</span><span class="o">=</span><span class="s">&quot;text/html&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">String</span> <span class="nf">detail</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span>
                     <span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                     <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="c1">//取缓存</span>
    <span class="n">String</span> <span class="n">html</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getGoodsDetail</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">goodsId</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">html</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">html</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 读数据库的 保证刷新还是读到真实的库存</span>
    <span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;goods&quot;</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>

    <span class="kt">long</span> <span class="n">startAt</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getStartDate</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">endAt</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getEndDate</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="c1">// 0：没开始 2：结束 1：进行中</span>
    <span class="kt">int</span> <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// 倒计时</span>
    <span class="kt">int</span> <span class="n">remainSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">startAt</span> <span class="o">)</span> <span class="o">{</span><span class="c1">//秒杀还没开始，倒计时</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)((</span><span class="n">startAt</span> <span class="o">-</span> <span class="n">now</span> <span class="o">)/</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span><span class="k">else</span>  <span class="k">if</span><span class="o">(</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">endAt</span><span class="o">){</span><span class="c1">//秒杀已经结束</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="o">{</span><span class="c1">//秒杀进行中</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;miaoshaStatus&quot;</span><span class="o">,</span> <span class="n">miaoshaStatus</span><span class="o">);</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;remainSeconds&quot;</span><span class="o">,</span> <span class="n">remainSeconds</span><span class="o">);</span>
<span class="c1">//        return &quot;goods_detail&quot;;</span>
    <span class="n">SpringWebContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringWebContext</span><span class="o">(</span><span class="n">request</span><span class="o">,</span><span class="n">response</span><span class="o">,</span>
            <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">(),</span><span class="n">request</span><span class="o">.</span><span class="na">getLocale</span><span class="o">(),</span> <span class="n">model</span><span class="o">.</span><span class="na">asMap</span><span class="o">(),</span> <span class="n">applicationContext</span> <span class="o">);</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">thymeleafViewResolver</span><span class="o">.</span><span class="na">getTemplateEngine</span><span class="o">().</span><span class="na">process</span><span class="o">(</span><span class="s">&quot;goods_detail&quot;</span><span class="o">,</span> <span class="n">ctx</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">html</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getGoodsDetail</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">goodsId</span><span class="o">,</span> <span class="n">html</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<h3 id="_11">对象缓存<a class="headerlink" href="#_11" title="Permanent link"></a></h3>
<p>分布式session根据token从redis中拿User对象
添加redis 用户id key
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaUserKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TOKEN_EXPIRE</span> <span class="o">=</span> <span class="mi">3600</span><span class="o">*</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nf">MiaoshaUserKey</span><span class="o">(</span><span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">,</span> <span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span> <span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MiaoshaUserKey</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaUserKey</span><span class="o">(</span><span class="n">TOKEN_EXPIRE</span><span class="o">,</span> <span class="s">&quot;tk&quot;</span><span class="o">);</span>
    <span class="c1">//永久有效</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MiaoshaUserKey</span> <span class="n">getById</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaUserKey</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">&quot;id&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
登陆验证的时候不是从mysql按id取 而是从redis取
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">MiaoshaUser</span> <span class="nf">getById</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//取缓存</span>
    <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">getById</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">id</span><span class="o">,</span> <span class="n">MiaoshaUser</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//取数据库</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">miaoshaUserDao</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">getById</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">id</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>修改密码： 更新数据库，再让缓存失效
如果先删除缓存，数据库还没更新，又放了旧的数据在缓存里。</p>
<p>Cache Aside Pattern
<img alt="cachepattern.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/cachepattern.jpg" /></p>
<p>更新缓存的的Design Pattern有四种：Cache aside, Read through, Write through, Write behind caching.</p>
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">updatePassword</span><span class="o">(</span><span class="n">String</span> <span class="n">token</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">formPass</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//取user</span>
    <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">getById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">GlobalException</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MOBILE_NOT_EXIST</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//更新数据库</span>
    <span class="n">MiaoshaUser</span> <span class="n">toBeUpdate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaUser</span><span class="o">();</span>
    <span class="n">toBeUpdate</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">toBeUpdate</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">MD5Util</span><span class="o">.</span><span class="na">formPassToDBPass</span><span class="o">(</span><span class="n">formPass</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getSalt</span><span class="o">()));</span>
    <span class="n">miaoshaUserDao</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">toBeUpdate</span><span class="o">);</span>
    <span class="c1">//以前的用户根据id取的缓存直接删掉</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">getById</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">id</span><span class="o">);</span>
    <span class="n">user</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="n">toBeUpdate</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
    <span class="c1">// 为了登陆不掉，更新token，还是之前那个token</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">MiaoshaUserKey</span><span class="o">.</span><span class="na">token</span><span class="o">,</span> <span class="n">token</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

<p>user对象缓存应该删除。token缓存应该更新。</p>
<p>redisService 添加delete方法
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">delete</span><span class="o">(</span><span class="n">KeyPrefix</span> <span class="n">prefix</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">jedis</span> <span class="o">=</span>  <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="c1">//生成真正的key</span>
        <span class="n">String</span> <span class="n">realKey</span>  <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="na">getPrefix</span><span class="o">()</span> <span class="o">+</span> <span class="n">key</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span>  <span class="n">jedis</span><span class="o">.</span><span class="na">del</span><span class="o">(</span><span class="n">realKey</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
        <span class="n">returnToPool</span><span class="o">(</span><span class="n">jedis</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>在dao层添加update
<div class="codehilite"><pre><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MiaoshaUserDao</span> <span class="o">{</span>

    <span class="nd">@Select</span><span class="o">(</span><span class="s">&quot;select * from miaosha_user where id = #{id}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">MiaoshaUser</span> <span class="nf">getById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">id</span><span class="o">);</span>

    <span class="nd">@Update</span><span class="o">(</span><span class="s">&quot;update miaosha_user set password = #{password} where id = #{id}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">toBeUpdate</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
// to_list 接口qps 1267-&gt;2884  load 15-&gt;5</p>
<h3 id="_12">页面静态化(前后端分离)<a class="headerlink" href="#_12" title="Permanent link"></a></h3>
<p>不用<code>thymeleaf</code>
页面只有html，动态数据通过接口获取。</p>
<h4 id="_13">详情页<a class="headerlink" href="#_13" title="Permanent link"></a></h4>
<p>将商品详情页包装成vo
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsDetailVo</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">remainSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">GoodsVo</span> <span class="n">goods</span> <span class="o">;</span>
    <span class="kd">private</span> <span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>静态页面xhr获取后台数据
<code>&lt;a th:href="'/goods_detail.htm?goodsId='+${goods.id}"&gt;</code>
<div class="codehilite"><pre><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="c1">//countDown();</span>
    <span class="nx">getDetail</span><span class="p">();</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getDetail</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">goodsId</span> <span class="o">=</span> <span class="nx">g_getQueryString</span><span class="p">(</span><span class="s2">&quot;goodsId&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span><span class="s2">&quot;/goods/detail/&quot;</span><span class="o">+</span><span class="nx">goodsId</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="nx">render</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;客户端请求有误&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div></p>
<p>js获取url后面的参数name的值
<div class="codehilite"><pre><span class="c1">// 获取url参数</span>
<span class="kd">function</span> <span class="nx">g_getQueryString</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">reg</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;(^|&amp;)&quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;=([^&amp;]*)(&amp;|$)&quot;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="nx">reg</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></p>
<p>成功之后的回调函数 渲染页面 
问题：时间不同步问题，应该定时和服务器同步一下，现在全靠自己刷新
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">detail</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">miaoshaStatus</span> <span class="o">=</span> <span class="nx">detail</span><span class="p">.</span><span class="nx">miaoshaStatus</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">remainSeconds</span> <span class="o">=</span> <span class="nx">detail</span><span class="p">.</span><span class="nx">remainSeconds</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">goods</span> <span class="o">=</span> <span class="nx">detail</span><span class="p">.</span><span class="nx">goods</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">detail</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">){</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#userTip&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsName&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">goods</span><span class="p">.</span><span class="nx">goodsName</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsImg&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">goodsImg</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#startTime&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">goods</span><span class="p">.</span><span class="nx">startDate</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;yyyy-MM-dd hh:mm:ss&quot;</span><span class="p">));</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#remainSeconds&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">remainSeconds</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">goods</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsPrice&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">goods</span><span class="p">.</span><span class="nx">goodsPrice</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#miaoshaPrice&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">goods</span><span class="p">.</span><span class="nx">miaoshaPrice</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#stockCount&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">goods</span><span class="p">.</span><span class="nx">stockCount</span><span class="p">);</span>
    <span class="nx">countDown</span><span class="p">();</span>
<span class="p">}</span>
</pre></div></p>
<p>日期格式化
<div class="codehilite"><pre><span class="c1">//设定时间格式化函数，使用new Date().format(&quot;yyyyMMddhhmmss&quot;);  </span>
<span class="nb">Date</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span>  
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">{</span>  
        <span class="s2">&quot;M+&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>  
        <span class="s2">&quot;d+&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getDate</span><span class="p">(),</span>  
        <span class="s2">&quot;h+&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span>  
        <span class="s2">&quot;m+&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span>  
        <span class="s2">&quot;s+&quot;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">(),</span>  
    <span class="p">};</span>  
    <span class="k">if</span> <span class="p">(</span><span class="sr">/(y+)/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">format</span><span class="p">))</span>  
        <span class="nx">format</span> <span class="o">=</span> <span class="nx">format</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span><span class="p">,</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">substr</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>  
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>  
        <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>  
        <span class="k">if</span> <span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">format</span><span class="p">))</span>  
            <span class="nx">format</span> <span class="o">=</span> <span class="nx">format</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span><span class="p">,</span> <span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="nx">n</span> <span class="o">:</span> <span class="p">(</span><span class="s2">&quot;00&quot;</span> <span class="o">+</span> <span class="nx">n</span><span class="p">).</span><span class="nx">substr</span><span class="p">((</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">n</span><span class="p">).</span><span class="nx">length</span><span class="p">));</span>  
    <span class="p">}</span>  
    <span class="k">return</span> <span class="nx">format</span><span class="p">;</span>  
<span class="p">};</span>  
</pre></div></p>
<p>页面：
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel panel-default&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel-heading&quot;</span><span class="p">&gt;</span>秒杀商品详情<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel-body&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;userTip&quot;</span><span class="p">&gt;</span> 您还没有登录，请登陆后再操作<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodslist&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品名称<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodsName&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品图片<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span><span class="p">&gt;&lt;</span><span class="nt">img</span>  <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodsImg&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>秒杀开始时间<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;startTime&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;remainSeconds&quot;</span> <span class="p">/&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;miaoshaTip&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="c">&lt;!--</span>
<span class="c">                    &lt;form id=&quot;miaoshaForm&quot; method=&quot;post&quot; action=&quot;/miaosha/do_miaosha&quot;&gt;</span>
<span class="c">                        &lt;button class=&quot;btn btn-primary btn-block&quot; type=&quot;submit&quot; id=&quot;buyButton&quot;&gt;立即秒杀&lt;/button&gt;</span>
<span class="c">                        &lt;input type=&quot;hidden&quot; name=&quot;goodsId&quot;  id=&quot;goodsId&quot; /&gt;</span>
<span class="c">                    &lt;/form&gt;--&gt;</span>
                <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;buyButton&quot;</span><span class="na">onclick</span><span class="o">=</span><span class="s">&quot;doMiaosha()&quot;</span><span class="p">&gt;</span>立即秒杀<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;goodsId&quot;</span>  <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodsId&quot;</span> <span class="p">/&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品原价<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodsPrice&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>秒杀价<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span>  <span class="na">id</span><span class="o">=</span><span class="s">&quot;miaoshaPrice&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>库存数量<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span>  <span class="na">id</span><span class="o">=</span><span class="s">&quot;stockCount&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div></p>
<p>controller
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/detail/{goodsId}&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">GoodsDetailVo</span><span class="o">&gt;</span> <span class="nf">detail</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
    <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>

    <span class="kt">long</span> <span class="n">startAt</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getStartDate</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">endAt</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getEndDate</span><span class="o">().</span><span class="na">getTime</span><span class="o">();</span>
    <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="c1">// 0：没开始 2：结束 1：进行中</span>
    <span class="kt">int</span> <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// 倒计时</span>
    <span class="kt">int</span> <span class="n">remainSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">startAt</span> <span class="o">)</span> <span class="o">{</span><span class="c1">//秒杀还没开始，倒计时</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)((</span><span class="n">startAt</span> <span class="o">-</span> <span class="n">now</span> <span class="o">)/</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span><span class="k">else</span>  <span class="k">if</span><span class="o">(</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">endAt</span><span class="o">){</span><span class="c1">//秒杀已经结束</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="o">{</span><span class="c1">//秒杀进行中</span>
        <span class="n">miaoshaStatus</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">remainSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
   <span class="n">GoodsDetailVo</span> <span class="n">vo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GoodsDetailVo</span><span class="o">();</span>
    <span class="n">vo</span><span class="o">.</span><span class="na">setGoods</span><span class="o">(</span><span class="n">goods</span><span class="o">);</span>
    <span class="n">vo</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="n">vo</span><span class="o">.</span><span class="na">setMiaoshaStatus</span><span class="o">(</span><span class="n">miaoshaStatus</span><span class="o">);</span>
    <span class="n">vo</span><span class="o">.</span><span class="na">setRemainSeconds</span><span class="o">(</span><span class="n">remainSeconds</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">vo</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="_14">秒杀按钮<a class="headerlink" href="#_14" title="Permanent link"></a></h4>
<p><code>&lt;button class="btn btn-primary btn-block" type="button" id="buyButton"onclick="doMiaosha()"&gt;立即秒杀&lt;/button&gt;</code></p>
<p>秒杀返回订单
对后台数据有影响的要用post，put不能用get。因为搜索引擎遍历，执行<code>/delete?</code>等链接</p>
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">doMiaosha</span><span class="p">(){</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span><span class="s2">&quot;/miaosha/do_miaosha&quot;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span><span class="p">{</span>
            <span class="nx">goodsId</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/order_detail.htm?orderId=&quot;</span><span class="o">+</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;客户端请求有误&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

<span class="p">}</span>
</pre></div>

<p>跳转到订单详情页
<div class="codehilite"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/order&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">MiaoshaUserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">RedisService</span> <span class="n">redisService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">OrderService</span> <span class="n">orderService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">GoodsService</span> <span class="n">goodsService</span><span class="o">;</span>

    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/detail&quot;</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">OrderDetailVo</span><span class="o">&gt;</span> <span class="nf">info</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span> <span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                                      <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;orderId&quot;</span><span class="o">)</span> <span class="kt">long</span> <span class="n">orderId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">OrderInfo</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getOrderById</span><span class="o">(</span><span class="n">orderId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">order</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">ORDER_NOT_EXIST</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 用订单的商品id 查商品信息</span>
        <span class="kt">long</span> <span class="n">goodsId</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">();</span>
        <span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
        <span class="n">OrderDetailVo</span> <span class="n">vo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderDetailVo</span><span class="o">();</span>
        <span class="n">vo</span><span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
        <span class="n">vo</span><span class="o">.</span><span class="na">setGoods</span><span class="o">(</span><span class="n">goods</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">vo</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div></p>
<p>新建订单VO
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderDetailVo</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">GoodVo</span> <span class="n">goods</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">OrderInfo</span> <span class="n">order</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
新建订单页controller
新的sql 用订单id查订单
<div class="codehilite"><pre><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderDao</span> <span class="o">{</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">&quot;select * from order_info where id = #{orderId}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">OrderInfo</span> <span class="nf">getOrderById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&quot;orderId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">orderId</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>新的错误对象
<div class="codehilite"><pre><span class="c1">//订单模块 5004XX</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">ORDER_NOT_EXIST</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500400</span><span class="o">,</span> <span class="s">&quot;订单不存在&quot;</span><span class="o">);</span>
</pre></div></p>
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel panel-default&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;panel-heading&quot;</span><span class="p">&gt;</span>秒杀订单详情<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;table&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodslist&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品名称<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;3&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodsName&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span> 
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>  
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>商品图片<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">&gt;&lt;</span><span class="nt">img</span>  <span class="na">id</span><span class="o">=</span><span class="s">&quot;goodsImg&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;200&quot;</span> <span class="p">/&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>订单价格<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span>  <span class="na">id</span><span class="o">=</span><span class="s">&quot;orderPrice&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>下单时间<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;createDate&quot;</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>订单状态<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;orderStatus&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;payButton&quot;</span><span class="p">&gt;</span>立即支付<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>收货人<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">&gt;</span>XXX  18812341234<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>收货地址<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="p">&gt;</span>北京市昌平区回龙观龙博一区<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>  
     <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">detail</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">goods</span> <span class="o">=</span> <span class="nx">detail</span><span class="p">.</span><span class="nx">goods</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">order</span> <span class="o">=</span> <span class="nx">detail</span><span class="p">.</span><span class="nx">order</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsName&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">goods</span><span class="p">.</span><span class="nx">goodsName</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsImg&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="nx">goods</span><span class="p">.</span><span class="nx">goodsImg</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#orderPrice&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">goodsPrice</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#createDate&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">createDate</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;yyyy-MM-dd hh:mm:ss&quot;</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
        <span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;未支付&quot;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">order</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
        <span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;待发货&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#orderStatus&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">getOrderDetail</span><span class="p">();</span>
<span class="p">})</span>

<span class="kd">function</span> <span class="nx">getOrderDetail</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">orderId</span> <span class="o">=</span> <span class="nx">g_getQueryString</span><span class="p">(</span><span class="s2">&quot;orderId&quot;</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span><span class="s2">&quot;/order/detail&quot;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span><span class="p">{</span>
            <span class="nx">orderId</span><span class="o">:</span><span class="nx">orderId</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="nx">render</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;客户端请求有误&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</pre></div>

<h4 id="_15">静态化配置<a class="headerlink" href="#_15" title="Permanent link"></a></h4>
<p>304是客户端（浏览器）向服务端自动加
<code>If-Modified-Since: Fri, 28 Dec 2018 11:48:23 GMT</code>
服务端会检查如果没发生变化就304.还是发生了一次交互。</p>
<p>让页面直接从浏览器取。
Spring resources handling
<div class="codehilite"><pre><span class="c1">#static</span>
spring.resources.add-mappings<span class="o">=</span><span class="nb">true</span>
spring.resources.cache-period<span class="o">=</span> 3600
spring.resources.chain.cache<span class="o">=</span><span class="nb">true </span>
spring.resources.chain.enabled<span class="o">=</span><span class="nb">true</span>
spring.resources.chain.gzipped<span class="o">=</span><span class="nb">true</span>
spring.resources.chain.html-application-cache<span class="o">=</span><span class="nb">true</span>
spring.resources.static-locations<span class="o">=</span>classpath:/static/
</pre></div>
response里200 （但其实是来自缓存）响应头里有，达到从浏览器读。
Pragma是1.0的
Expire带时区的（服务端）
<code>Cache-Control: max-age=3600</code> 秒</p>
<h3 id="bug10and-stock_count-0">bug1：秒杀并发库存到0以下<code>and stock_count &gt;0</code><a class="headerlink" href="#bug10and-stock_count-0" title="Permanent link"></a></h3>
<p>code review
1.判断库存2.判断用户订单3.秒杀
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/do_miaosha&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">OrderInfo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                   <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 没登陆</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//判断库存</span>
    <span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getStockCount</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">stock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MIAO_SHA_OVER</span><span class="o">);</span>
    <span class="o">}</span>
<span class="c1">//      从用户订单查询是否已经对这个物品下过单了</span>
    <span class="n">MiaoshaOrder</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">order</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">REPEATE_MIAOSHA</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//1.减库存 2.下订单 3.写入秒杀订单 这三步是一个是事务</span>
    <span class="n">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">miaosha</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>减库存的sql
<div class="codehilite"><pre><span class="nd">@Update</span><span class="o">(</span><span class="s">&quot;update miaosha_goods set stock_count = stock_count -1 where goods_id = #{gooddsId}&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">reduceStock</span><span class="o">(</span><span class="n">MiaoshaGoods</span> <span class="n">g</span><span class="o">);</span>
</pre></div>
如果库存有1，两个线程同时调用这个sql就负数了</p>
<p>修改：只有库存&gt;0才减
<div class="codehilite"><pre><span class="nd">@Update</span><span class="o">(</span><span class="s">&quot;update miaosha_goods set stock_count = stock_count -1 where goods_id = #{gooddsId} and stock_count &gt;0&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">reduceStock</span><span class="o">(</span><span class="n">MiaoshaGoods</span> <span class="n">g</span><span class="o">);</span>
</pre></div>
因为数据库会加锁 不会两个线程同时更新</p>
<h3 id="bug2">bug2：用户秒杀了多个商品:数据库唯一索引<a class="headerlink" href="#bug2" title="Permanent link"></a></h3>
<p>同一个用户多个请求，在没完成第一个订单之前都判断完了有库存，也没秒杀过。
结果：多个线程都到减库存，下订单，生成新的秒杀订单。</p>
<p>数据库唯一索引，让一个用户只能有一个秒杀订单
<img alt="uniqueindex.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/uniqueindex.jpg" /></p>
<p>优化：
查询用户是否买过这个商品不走数据库
建key
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">OrderKey</span><span class="o">(</span> <span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span> <span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">OrderKey</span> <span class="n">getMiaoshaOrderByUidGid</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OrderKey</span><span class="o">(</span><span class="s">&quot;moug&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<div class="codehilite"><pre><span class="c1">// 根据用户ID和商品ID查找相应订单</span>
<span class="kd">public</span>  <span class="n">MiaoshaOrder</span> <span class="nf">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="kt">long</span> <span class="n">userId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">OrderKey</span><span class="o">.</span><span class="na">getMiaoshaOrderByUidGid</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">userId</span><span class="o">+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">goodsId</span> <span class="o">,</span> <span class="n">MiaoshaOrder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="c1">//      return orderDao.getMiaoshaOrderByUserIdGoodsId(userId, goodsId);</span>
<span class="o">}</span>
</pre></div>

<p>生成订单之后要写缓存
<div class="codehilite"><pre><span class="c1">// 根据用户和商品信息创建订单信息</span>
<span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="n">OrderInfo</span> <span class="nf">createOrder</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span> <span class="n">GoodVo</span> <span class="n">goods</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//...</span>
    <span class="c1">// 数据库 miaoshaOrder表</span>
    <span class="n">orderDao</span><span class="o">.</span><span class="na">insertMiaoshaOrder</span><span class="o">(</span><span class="n">miaoshaOrder</span><span class="o">);</span>

    <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">OrderKey</span><span class="o">.</span><span class="na">getMiaoshaOrderByUidGid</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">miaoshaOrder</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">orderInfo</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<h3 id="_16">其他静态资源优化<a class="headerlink" href="#_16" title="Permanent link"></a></h3>
<p>1.js/css压缩
2.多个js/css组合成一个减少连接数
3.CDN</p>
<h3 id="_17">接口优化<a class="headerlink" href="#_17" title="Permanent link"></a></h3>
<p>1）redis预减库存减少数据库访问，减库存请求入消息队列，返回排队中。
2）服务端：请求出队，生成订单，减库存。
3）客户端轮询秒杀是否成功。</p>
<p>并发队列：
Java的并发包提供了三个常用的并发队列实现，分别是：ConcurrentLinkedQueue 、 LinkedBlockingQueue 和 ArrayBlockingQueue。
ArrayBlockingQueue是初始容量固定的阻塞队列，我们可以用来作为数据库模块成功竞拍的队列，比如有10个商品，那么我们就设定一个10大小的数组队列。
ConcurrentLinkedQueue使用的是CAS原语无锁队列实现，是一个异步队列，入队的速度很快，出队进行了加锁，性能稍慢。
LinkedBlockingQueue也是阻塞的队列，入队和出队都用了加锁，当队空的时候线程会暂时阻塞。
由于我们的系统入队需求要远大于出队需求，一般不会出现队空的情况，所以我们可以选择ConcurrentLinkedQueue来作为我们的请求队列实现</p>
<h3 id="rabitmq">安装 RabitMQ<a class="headerlink" href="#rabitmq" title="Permanent link"></a></h3>
<p>1.安装依赖<code>yum install ncurses-devel</code>
2.安装erlang<code>yum install erlang</code> 执行erl表示安装成功
3.安装rabbitmq 
解压<code>xz -d rabbitmq-server-generic-unix-3.7.9.tar.xz</code>
解压<code>tar xf rabbitmq-server-generic-unix-3.7.9.tar</code>
安装python
安装<code>yum install xmlto -y</code>
安装<code>yum install python-simplejson -y</code>
<div class="codehilite"><pre><span class="nb">cd </span>rabbitmq_server-3.7.9/
<span class="nb">cd </span>sbin
</pre></div>
启动然后报错
yum remove掉erlang*相关的
<div class="codehilite"><pre>tar -xf otp_src_21.0.tar.gz
./configure --prefix<span class="o">=</span>/usr/local/erlang20 --without-javac
make -j 8
make install
vim /etc/profile
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/erlang21/bin:<span class="nv">$PATH</span> 
<span class="nb">source</span> /etc/profile
</pre></div>
回到sbin启动<code>./rabbitmq-server</code>
可以看log 端口是5672
<div class="codehilite"><pre><span class="o">[</span>root@localhost sbin<span class="o">]</span><span class="c1"># netstat -nap |grep 5672</span>
tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:25672           0.0.0.0:*               LISTEN      14205/beam.smp      
tcp6       <span class="m">0</span>      <span class="m">0</span> :::5672                 :::*                    LISTEN      14205/beam.smp 
</pre></div>
关闭用<code>./rabbitmqctl stop</code>
<div class="codehilite"><pre><span class="o">[</span>root@localhost sbin<span class="o">]</span><span class="c1"># netstat -nap |grep 5672</span>
tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:43296         127.0.0.1:25672         TIME_WAIT   -
</pre></div></p>
<p>安装lsof
<div class="codehilite"><pre><span class="o">[</span>root@localhost ebin<span class="o">]</span><span class="c1"># lsof -i:5672</span>
COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
beam.smp <span class="m">17480</span> root   68u  IPv6 <span class="m">176892</span>      0t0  TCP *:amqp <span class="o">(</span>LISTEN<span class="o">)</span>
beam.smp <span class="m">17480</span> root   69u  IPv6 <span class="m">176909</span>      0t0  TCP localhost.localdomain:amqp-&gt;10.1.18.15:10893 <span class="o">(</span>ESTABLISHED<span class="o">)</span>
</pre></div></p>
<h3 id="springboot-rabbitmq">SpringBoot 集成RabbitMQ<a class="headerlink" href="#springboot-rabbitmq" title="Permanent link"></a></h3>
<p>erlang有原生socket一样的延迟
AMQP协议模型
生产者：1.投递到server，2投递到virtual host，3投递到exchange</p>
<p>RabbitMQ有一个消息确认机制来保证消息的不丢失：客户端从队列中取出消息之后，可能需要一段时间才能处理完成，如果在这个过程中，客户端出错了，异常退出了，而数据还没有处理完成，那么非常不幸，这段数据就丢失了，因为RabbitMQ默认会把此消息标记为已完成，然后从队列中移除，消息确认是客户端从RabbitMQ中取出消息，并处理完成之后，会发送一个ack告诉RabbitMQ，消息处理完成，当RabbitMQ收到客户端的获取消息请求之后，或标记为处理中，当再次收到ack之后，才会标记为已完成，然后从队列中删除。当RabbitMQ检测到客户端和自己断开链接之后，还没收到ack，则会重新将消息放回消息队列，交给下一个客户端处理，保证消息不丢失，也就是说，RabbitMQ给了客户端足够长的时间来做数据处理。</p>
<p>exchange 和 message queue 有绑定关系。
<img alt="amqp.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/amqp.jpg" /></p>
<p _="%" endnote="endnote">核心概念：
{% note %}
- Server：Broker。接受连接。
- Connection:应用与Broker的网络连接。
- Channel：网络信道，一个会话任务。一个客户端可以建立多个channel。
- Message：消息结构由Properties（优先级，延迟）和Body组成。
- Virtual host：逻辑隔离，消息路由，划分服务。一个host里可以有多个exchange和queue。同一个host不能有同名的exchange和queue。（相当于redis 16个db的逻辑概念）
- Exchange：交换机，接受消息，根据路由键转发消息到binding的队列。
- Binding：Exchange和Queue的虚拟连接，可以有routing key。
- Routing key：路由规则。host确定如何路由一个消息。
- Queue:保存并转发给消费者。</p>
<p>核心配置文件位置：
<code>vi /usr/local/rabbitmq_server-3.7.9/ebin/rabbit.app</code>
loopback_users也在里面 可以修改成<code>[guest]</code></p>
<p>rabbitMQ插件 可视化管理
<div class="codehilite"><pre>rabbitmq-plugins list
rabbitmq-plugins <span class="nb">enable </span>rabbitmq_management
</pre></div>
访问：<code>http://10.1.18.20:15672/</code></p>
<p>1 添加依赖
<div class="codehilite"><pre><span class="nt">&lt;dependency&gt;</span>  
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>  
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span class="nt">&lt;/artifactId&gt;</span>  
<span class="nt">&lt;/dependency&gt;</span> 
</pre></div>
2 添加配置
<div class="codehilite"><pre><span class="err">#</span><span class="n">rabbitmq</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">host</span><span class="o">=</span><span class="mf">10.1</span><span class="o">.</span><span class="mf">18.20</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">port</span><span class="o">=</span><span class="mi">5672</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">username</span><span class="o">=</span><span class="n">guest</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">password</span><span class="o">=</span><span class="n">guest</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">virtual</span><span class="o">-</span><span class="n">host</span><span class="o">=/</span>
<span class="err">#</span><span class="n">消费者数量</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">simple</span><span class="o">.</span><span class="na">concurrency</span><span class="o">=</span> <span class="mi">10</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">simple</span><span class="o">.</span><span class="na">max</span><span class="o">-</span><span class="n">concurrency</span><span class="o">=</span> <span class="mi">10</span>
<span class="err">#</span><span class="n">从队列里每次取几个</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">simple</span><span class="o">.</span><span class="na">prefetch</span><span class="o">=</span> <span class="mi">1</span>
<span class="err">#</span><span class="n">消费者默认自动启动</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">simple</span><span class="o">.</span><span class="na">auto</span><span class="o">-</span><span class="n">startup</span><span class="o">=</span><span class="kc">true</span>
<span class="err">#</span> <span class="n">消费失败会重新压入队列</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">listener</span><span class="o">.</span><span class="na">simple</span><span class="o">.</span><span class="na">default</span><span class="o">-</span><span class="n">requeue</span><span class="o">-</span><span class="n">rejected</span><span class="o">=</span> <span class="kc">true</span>
<span class="err">#</span><span class="n">生产者重试</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">template</span><span class="o">.</span><span class="na">retry</span><span class="o">.</span><span class="na">enabled</span><span class="o">=</span><span class="kc">true</span> 
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">template</span><span class="o">.</span><span class="na">retry</span><span class="o">.</span><span class="na">initial</span><span class="o">-</span><span class="n">interval</span><span class="o">=</span><span class="mi">1000</span> 
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">template</span><span class="o">.</span><span class="na">retry</span><span class="o">.</span><span class="na">max</span><span class="o">-</span><span class="n">attempts</span><span class="o">=</span><span class="mi">3</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">template</span><span class="o">.</span><span class="na">retry</span><span class="o">.</span><span class="na">max</span><span class="o">-</span><span class="n">interval</span><span class="o">=</span><span class="mi">10000</span>
<span class="n">spring</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">template</span><span class="o">.</span><span class="na">retry</span><span class="o">.</span><span class="na">multiplier</span><span class="o">=</span><span class="mf">1.0</span>
</pre></div></p>
<p>新建rabbitmq包，</p>
<p>交换机的4种模式</p>
<h3 id="direct">Direct 模式<a class="headerlink" href="#direct" title="Permanent link"></a></h3>
<p>配置类
<div class="codehilite"><pre><span class="kn">import</span> <span class="nn">org.springframework.amqp.core.Queue</span><span class="o">;</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MQConfig</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">QUEUE</span> <span class="o">=</span> <span class="s">&quot;queue&quot;</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">queue</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">QUEUE</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>新建发送者
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MQSender</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">AmqpTemplate</span> <span class="n">amqpTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">){</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">RedisService</span><span class="o">.</span><span class="na">beanToString</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="n">amqpTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">QUEUE</span><span class="o">,</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>重用redis中bean2String的方法
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span>  <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">String</span> <span class="nf">beanToString</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">){</span>
    <span class="c1">//2. 添加空判断</span>
    <span class="k">if</span><span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span><span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">//3. 如果是数字，字符串，Long</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">value</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span><span class="n">value</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">value</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
String2Bean
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">stringToBean</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">,</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">){</span>
    <span class="c1">//1. 参数校验</span>
    <span class="k">if</span><span class="o">(</span><span class="n">str</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//2 如果是int，string，Long</span>
    <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
    <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">str</span><span class="o">;</span>
    <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">clazz</span> <span class="o">==</span> <span class="kt">long</span><span class="o">.</span><span class="na">class</span> <span class="o">||</span> <span class="n">clazz</span> <span class="o">==</span> <span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span>  <span class="o">(</span><span class="n">T</span><span class="o">)</span><span class="n">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">str</span><span class="o">);</span>
    <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
        <span class="c1">//fastJson 其他List类型要再写</span>
        <span class="k">return</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJavaObject</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">str</span><span class="o">),</span> <span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>消费者监听轮询
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MQSender</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MQSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="n">AmqpTemplate</span> <span class="n">amqpTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">){</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">RedisService</span><span class="o">.</span><span class="na">beanToString</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;send message&quot;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
        <span class="n">amqpTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">QUEUE</span><span class="o">,</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>随便用一个controller测试一下
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/mq&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">mq</span><span class="o">(){</span>
    <span class="n">sender</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">&quot;rabbitMQ消息测试&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;rabbitMQ消息测试&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>报错：
<div class="codehilite"><pre><span class="n">rabbitmq</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">AuthenticationFailureException</span><span class="o">:</span> <span class="n">ACCESS_REFUSED</span> <span class="o">-</span> <span class="n">Login</span> <span class="n">was</span> <span class="n">refused</span> <span class="n">using</span> <span class="n">authentication</span> <span class="n">mechanism</span> <span class="n">PLAIN</span><span class="o">.</span> <span class="n">For</span> <span class="n">details</span> <span class="n">see</span> <span class="n">the</span> <span class="n">broker</span> <span class="n">logfile</span><span class="o">.</span>
</pre></div></p>
<p>因为guest用户默认不能远程连接 localhost是可以的
<a href="https://www.rabbitmq.com/access-control.html">https://www.rabbitmq.com/access-control.html</a>
it can only connect over a loopback interface (i.e. localhost).</p>
<p>用方法2
修改rabbitmq.config
在<code>/usr/local/rabbitmq_server-3.7.9/etc/rabbitmq</code>下创建<code>rabbitmq.config</code>
添加
<code>[{rabbit, [{loopback_users, []}]}].</code></p>
<p>重启
<div class="codehilite"><pre>rabbitmqctl stop
rabbitmq-server 
</pre></div></p>
<p>访问<code>http://localhost:8080/demo/mq</code> 可以看到log</p>
<h3 id="topic-queue">Topic模式 可以发给多个queue<a class="headerlink" href="#topic-queue" title="Permanent link"></a></h3>
<div class="codehilite"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MQConfig</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">QUEUE</span> <span class="o">=</span> <span class="s">&quot;queue&quot;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOPIC_QUEUE1</span> <span class="o">=</span> <span class="s">&quot;topic_queue1&quot;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOPIC_QUEUE2</span> <span class="o">=</span> <span class="s">&quot;topic_queue2&quot;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOPIC_EXCHANGE</span> <span class="o">=</span> <span class="s">&quot;topic_queue2&quot;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ROUTING_KEY1</span> <span class="o">=</span> <span class="s">&quot;topic.key1&quot;</span><span class="o">;</span>
    <span class="c1">//* 表示一个单词。 #表示0个或者多个单词</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ROUTING_KEY2</span> <span class="o">=</span> <span class="s">&quot;topic.#&quot;</span><span class="o">;</span>

    <span class="c1">// 直接模式</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">queue</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">QUEUE</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// topic模式</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">topicQueue1</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">TOPIC_QUEUE1</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">topicQueue2</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">TOPIC_QUEUE2</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">TopicExchange</span> <span class="nf">topicExchange</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">TopicExchange</span><span class="o">(</span><span class="n">TOPIC_EXCHANGE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Binding</span> <span class="nf">topicBinding1</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">topicQueue1</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">topicExchange</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="n">ROUTING_KEY1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Binding</span> <span class="nf">topicBinding2</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">topicQueue2</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">topicExchange</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="n">ROUTING_KEY2</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>发送：
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MQSender</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MQSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="n">AmqpTemplate</span> <span class="n">amqpTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">){</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">RedisService</span><span class="o">.</span><span class="na">beanToString</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;send message&quot;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
        <span class="n">amqpTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">QUEUE</span><span class="o">,</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendTopic</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">){</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">RedisService</span><span class="o">.</span><span class="na">beanToString</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;send topic message&quot;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
        <span class="c1">// queue1和2都能匹配上都能收到</span>
        <span class="n">amqpTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">TOPIC_EXCHANGE</span><span class="o">,</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">ROUTING_KEY1</span><span class="o">,</span><span class="n">msg</span><span class="o">+</span><span class="s">&quot;1&quot;</span><span class="o">);</span>
        <span class="c1">// 只有queue2能匹配上</span>
        <span class="n">amqpTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">TOPIC_EXCHANGE</span><span class="o">,</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">ROUTING_KEY2</span><span class="o">,</span><span class="n">msg</span><span class="o">+</span><span class="s">&quot;2&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>接收：
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MQReceiver</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MQSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="n">MQConfig</span><span class="o">.</span><span class="na">QUEUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">){</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;receive message:&quot;</span><span class="o">+</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="n">MQConfig</span><span class="o">.</span><span class="na">TOPIC_QUEUE1</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiveTopic1</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">){</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;receive q1 message:&quot;</span><span class="o">+</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="n">MQConfig</span><span class="o">.</span><span class="na">TOPIC_QUEUE2</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiveTopic2</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">){</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;receive q2 message:&quot;</span><span class="o">+</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/mq/topic&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">topic</span><span class="o">(){</span>
    <span class="c1">// 发两条消息</span>
    <span class="n">sender</span><span class="o">.</span><span class="na">sendTopic</span><span class="o">(</span><span class="s">&quot;topic消息测试&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;topic消息测试&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>

<p>结果
<img alt="topicmq.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/topicmq.jpg" /></p>
<h3 id="fanout-key">Fanout模式 广播模式 不需要绑定key<a class="headerlink" href="#fanout-key" title="Permanent link"></a></h3>
<p><img alt="mqfanout.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/mqfanout.jpg" /></p>
<div class="codehilite"><pre><span class="c1">// 广播模式 广播交换机</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">FanoutExchange</span> <span class="nf">fanoutExchange</span><span class="o">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">FanoutExchange</span><span class="o">(</span><span class="n">FANOUT_EXCHANGE</span><span class="o">);</span>
<span class="o">}</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">Binding</span> <span class="nf">FanoutBinding1</span><span class="o">(){</span>
    <span class="k">return</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">topicQueue1</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">fanoutExchange</span><span class="o">());</span>
<span class="o">}</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">Binding</span> <span class="nf">FanoutBinding2</span><span class="o">(){</span>
    <span class="k">return</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">topicQueue2</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">fanoutExchange</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>

<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendFanout</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">){</span>
    <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">RedisService</span><span class="o">.</span><span class="na">beanToString</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;send topic message&quot;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
    <span class="c1">// queue1和2都能都能收到</span>
    <span class="n">amqpTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">FANOUT_EXCHANGE</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">,</span><span class="n">msg</span><span class="o">+</span><span class="s">&quot;1&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>

<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/mq/fanout&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">fanout</span><span class="o">(){</span>
    <span class="n">sender</span><span class="o">.</span><span class="na">sendFanout</span><span class="o">(</span><span class="s">&quot;广播 消息测试&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;广播消息测试&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>

<h3 id="header">Header模式<a class="headerlink" href="#header" title="Permanent link"></a></h3>
<p>MQConfig
<div class="codehilite"><pre><span class="c1">// Header模式</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">HeadersExchange</span> <span class="nf">headersExchange</span><span class="o">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">HeadersExchange</span><span class="o">(</span><span class="n">HEADER_EXCHANGE</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">Queue</span> <span class="nf">headerQueue</span><span class="o">(){</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">HEADER_QUEUE</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="n">Binding</span> <span class="nf">headerBinding</span><span class="o">(){</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;();</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;header1&quot;</span><span class="o">,</span><span class="s">&quot;value1&quot;</span> <span class="o">);</span>
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;header2&quot;</span><span class="o">,</span><span class="s">&quot;value2&quot;</span> <span class="o">);</span>
    <span class="k">return</span> <span class="n">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">headerQueue</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">headersExchange</span><span class="o">()).</span><span class="na">whereAll</span><span class="o">(</span><span class="n">map</span><span class="o">).</span><span class="na">match</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
sender
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendHeader</span><span class="o">(</span><span class="n">Object</span> <span class="n">message</span><span class="o">){</span>
    <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">RedisService</span><span class="o">.</span><span class="na">beanToString</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;send header message&quot;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
    <span class="n">MessageProperties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageProperties</span><span class="o">();</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">&quot;header1&quot;</span><span class="o">,</span><span class="s">&quot;value1&quot;</span> <span class="o">);</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">&quot;header2&quot;</span><span class="o">,</span><span class="s">&quot;value2&quot;</span> <span class="o">);</span>
    <span class="n">Message</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Message</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span><span class="n">properties</span><span class="o">);</span>
    <span class="n">amqpTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">MQConfig</span><span class="o">.</span><span class="na">HEADER_EXCHANGE</span><span class="o">,</span><span class="n">obj</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>receiver
<div class="codehilite"><pre><span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="n">MQConfig</span><span class="o">.</span><span class="na">HEADER_QUEUE</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiveHeader</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">message</span><span class="o">){</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;receive q2 message:&quot;</span><span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">message</span><span class="o">));</span>
<span class="o">}</span>
</pre></div></p>
<p>controller测试
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/mq/header&quot;</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">header</span><span class="o">(){</span>
    <span class="n">sender</span><span class="o">.</span><span class="na">sendHeader</span><span class="o">(</span><span class="s">&quot;header 消息测试&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="s">&quot;header消息测试&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<h3 id="-">秒杀接口优化 同步下单-&gt;异步下单<a class="headerlink" href="#-" title="Permanent link"></a></h3>
<p>秒杀review：
<div class="codehilite"><pre><span class="nd">@Autowired</span>
<span class="n">MiaoshaService</span> <span class="n">miaoshaService</span><span class="o">;</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/do_miaosha&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">OrderInfo</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                   <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 没登陆</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//判断库存（读数据库）</span>
    <span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getStockCount</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">stock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MIAO_SHA_OVER</span><span class="o">);</span>
    <span class="o">}</span>
<span class="c1">//   （redis）   从用户订单查询是否已经对这个物品下过单了</span>
    <span class="n">MiaoshaOrder</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">order</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">REPEATE_MIAOSHA</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//1.减库存 update 2.下订单 insert 3.写入秒杀订单 insert 这三步是一个是事务</span>
    <span class="n">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">miaosha</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
判断库存要读数据库，下单减库存update生成订单两个insert，一共要3次数据库。
思路：
1)减少数据库访问，将系统初始化时，将库存数量加载到redis。
2)redis预减库存，如果redis里库存没有直接返回。
3)否则【异步下单】放到消息队列，返回排队中。
4)请求出队，生成订单，减少库存。
5)客户端轮询是否秒杀成功。</p>
<p>启动时将库存加载到redis：框架会回调，实现的方法。
<div class="codehilite"><pre><span class="nd">@Controller</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&quot;/miaosha&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaController</span> <span class="kd">implements</span> <span class="n">InitializingBean</span><span class="o">{</span>
<span class="c1">// 系统初始化 读数据库库存，写到redis</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 查询出所有商品数量</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="n">goodslist</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">listGoodsVo</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">goodslist</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">for</span><span class="o">(</span><span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">:</span> <span class="n">goodslist</span><span class="o">){</span>
                <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getMiaoshaGoodsStock</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">,</span><span class="n">goods</span><span class="o">.</span><span class="na">getStockCount</span><span class="o">()</span> <span class="o">);}}}}</span>
</pre></div></p>
<p>设置库存的rediskey
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nf">GoodsKey</span><span class="o">(</span><span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">,</span> <span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span> <span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">GoodsKey</span> <span class="n">getGoodsList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GoodsKey</span><span class="o">(</span><span class="mi">60</span><span class="o">,</span> <span class="s">&quot;gl&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">GoodsKey</span> <span class="n">getGoodsDetail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GoodsKey</span><span class="o">(</span><span class="mi">60</span><span class="o">,</span> <span class="s">&quot;gd&quot;</span><span class="o">);</span>
    <span class="c1">// 添加 预加载库存key</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">GoodsKey</span> <span class="n">getMiaoshaGoodsStock</span><span class="o">=</span> <span class="k">new</span> <span class="n">GoodsKey</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">&quot;gs&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>队列中的消息格式：（秒杀）用户，商品id
rabbitmq/MiaoshaMessage.java
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaMessage</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>新的秒杀controller流程：
<div class="codehilite"><pre><span class="nd">@Autowired</span>
<span class="n">RedisService</span> <span class="n">redisService</span><span class="o">;</span>

<span class="nd">@Autowired</span>
<span class="n">MiaoshaSender</span> <span class="n">sender</span><span class="o">;</span>
<span class="nd">@Autowired</span>
<span class="n">MiaoshaService</span> <span class="n">miaoshaService</span><span class="o">;</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/do_miaosha&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                   <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 没登陆</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// redis中预减库存</span>
    <span class="n">Long</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">decr</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getMiaoshaGoodsStock</span><span class="o">,</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">stock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MIAO_SHA_OVER</span><span class="o">);</span>
    <span class="o">}</span>
<span class="c1">//      从用户订单查询是否已经对这个物品下过单了</span>
    <span class="n">MiaoshaOrder</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">order</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">REPEATE_MIAOSHA</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 入队</span>
    <span class="n">MiaoshaMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaMessage</span><span class="o">();</span>
    <span class="n">msg</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="n">msg</span><span class="o">.</span><span class="na">setGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="n">sender</span><span class="o">.</span><span class="na">sendMiaoshaMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>config
<div class="codehilite"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaMQConfig</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">MIAOSHA_QUEUE</span> <span class="o">=</span> <span class="s">&quot;miaosha.queue&quot;</span><span class="o">;</span>

    <span class="c1">// 直接模式</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Queue</span> <span class="nf">miaoshaQueue</span><span class="o">(){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Queue</span><span class="o">(</span><span class="n">MIAOSHA_QUEUE</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>sender：
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaSender</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MQSender</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="n">AmqpTemplate</span> <span class="n">amqpTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMiaoshaMessage</span><span class="o">(</span><span class="n">MiaoshaMessage</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// direct模式</span>
        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">RedisService</span><span class="o">.</span><span class="na">beanToString</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;send message: &quot;</span><span class="o">+</span><span class="n">msg</span><span class="o">);</span>
        <span class="n">amqpTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">MiaoshaMQConfig</span><span class="o">.</span><span class="na">MIAOSHA_QUEUE</span><span class="o">,</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>reveicer ：减库存 创建订单
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaReceiver</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">GoodsService</span> <span class="n">goodsService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">OrderService</span> <span class="n">orderService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">MiaoshaService</span> <span class="n">miaoshaService</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">MiaoshaMQConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">queues</span> <span class="o">=</span> <span class="n">MQConfig</span><span class="o">.</span><span class="na">MIAOSHA_QUEUE</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">maishaReceive</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">){</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;receive message:&quot;</span><span class="o">+</span><span class="n">message</span><span class="o">);</span>
        <span class="n">MiaoshaMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">RedisService</span><span class="o">.</span><span class="na">stringToBean</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">MiaoshaMessage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">goodsId</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getGoodsId</span><span class="o">();</span>
        <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getUser</span><span class="o">();</span>
        <span class="c1">// 判断真的库存</span>
        <span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">getGoodsVoByGoodsId</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">goods</span><span class="o">.</span><span class="na">getStockCount</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">stock</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 判断秒杀过没有</span>
        <span class="n">MiaoshaOrder</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">goodsId</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">order</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//1.减库存 2.下订单 3.写入秒杀订单 这三步是一个是事务</span>
        <span class="n">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">miaosha</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<h4 id="_18">客户端轮询<a class="headerlink" href="#_18" title="Permanent link"></a></h4>
<h5 id="_19">后台添加轮询接口<a class="headerlink" href="#_19" title="Permanent link"></a></h5>
<p>MiaoshaController
<div class="codehilite"><pre><span class="c1">// 客户端轮询接口 判断是否秒杀到</span>
<span class="cm">/*</span>
<span class="cm"> orderID:成功</span>
<span class="cm"> -1：秒杀失败</span>
<span class="cm"> 0：排队中</span>
<span class="cm"> */</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/result&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">miaoshaResult</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kt">long</span> <span class="n">rst</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">getMiaoshaResult</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">rst</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>轮询方法：
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">GoodsService</span> <span class="n">goodsService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">OrderService</span> <span class="n">orderService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">RedisService</span> <span class="n">redisService</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="n">OrderInfo</span> <span class="nf">miaosha</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span> <span class="n">GoodVo</span> <span class="n">goods</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">//减库存 下订单 写入秒杀订单</span>
        <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">reduceStock</span><span class="o">(</span><span class="n">goods</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">success</span><span class="o">){</span>
            <span class="c1">//order_info maiosha_order</span>
            <span class="k">return</span> <span class="n">orderService</span><span class="o">.</span><span class="na">createOrder</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">goods</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="c1">// 如果失败  说明秒杀失败 做标记 防止一直轮询</span>
            <span class="n">setGoodsOver</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getMiaoshaResult</span><span class="o">(</span><span class="n">Long</span> <span class="n">userid</span><span class="o">,</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">MiaoshaOrder</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">getMiaoshaOrderByUserIdGoodsId</span><span class="o">(</span><span class="n">userid</span><span class="o">,</span> <span class="n">goodsId</span><span class="o">);</span>
        <span class="c1">// 订单不空，秒杀成功</span>
        <span class="k">if</span><span class="o">(</span><span class="n">order</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="na">getOrderId</span><span class="o">();</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="c1">// 判断是排队中还是失败了</span>
            <span class="kt">boolean</span> <span class="n">isOver</span> <span class="o">=</span> <span class="n">getGoodsOver</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">isOver</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setGoodsOver</span><span class="o">(</span><span class="n">Long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">MiaoshaKey</span><span class="o">.</span><span class="na">isGoodsOver</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">goodsId</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">getGoodsOver</span><span class="o">(</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">redisService</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">MiaoshaKey</span><span class="o">.</span><span class="na">isGoodsOver</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>用redis添加秒杀完库存的标记，防止一直轮询，判断是排队中还是秒杀完了。
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MiaoshaKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span><span class="o">{</span>

    <span class="kd">private</span> <span class="nf">MiaoshaKey</span><span class="o">(</span><span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MiaoshaKey</span> <span class="n">isGoodsOver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaKey</span><span class="o">(</span><span class="s">&quot;go&quot;</span><span class="o">);</span>
</pre></div></p>
<h5 id="_20">前端轮询：<a class="headerlink" href="#_20" title="Permanent link"></a></h5>
<p>goods_detail.htm详情页中的秒杀按钮
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;buyButton&quot;</span><span class="na">onclick</span><span class="o">=</span><span class="s">&quot;doMiaosha()&quot;</span><span class="p">&gt;</span>立即秒杀<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</pre></div></p>
<p>添加排队 并用get轮询
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">doMiaosha</span><span class="p">(){</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span><span class="s2">&quot;/miaosha/do_miaosha&quot;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span><span class="p">{</span>
            <span class="nx">goodsId</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="c1">// 成功 排队中 轮询</span>
                <span class="nx">getMiaoshaResult</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;客户端请求有误&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="p">}</span>
<span class="kd">function</span> <span class="nx">getMiaoshaResult</span><span class="p">(</span><span class="nx">goodsId</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 加载中的动画</span>
    <span class="nx">g_showLoading</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/miaosha/result&quot;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">goodsId</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//成功</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                <span class="c1">// -1失败</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;对不起，秒杀失败&quot;</span><span class="p">);</span>
                <span class="p">}</span> <span class="c1">//0排队继续轮询</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="nx">getMiaoshaResult</span><span class="p">(</span><span class="nx">goodsId</span><span class="p">);</span>
                    <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>
                <span class="p">}</span> <span class="c1">// 成功返回订单id</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">layer</span><span class="p">.</span><span class="nx">confirm</span><span class="p">(</span><span class="s2">&quot;恭喜你，秒杀成功！查看订单？&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">btn</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;确定&quot;</span><span class="p">,</span> <span class="s2">&quot;取消&quot;</span><span class="p">]},</span>
                        <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                            <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">&quot;/order_detail.htm?orderId=&quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">;</span>
                        <span class="p">},</span>
                        <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                            <span class="nx">layer</span><span class="p">.</span><span class="nx">closeAll</span><span class="p">();</span>
                        <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;客户端请求有误&quot;</span><span class="p">);}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div></p>
<p>清理redis
<div class="codehilite"><pre>redis-cli
flushdb
keys *
</pre></div></p>
<p>测试秒杀ok</p>
<h3 id="_21">优化点 减少预减库存<a class="headerlink" href="#_21" title="Permanent link"></a></h3>
<p>预减库存code review：
<div class="codehilite"><pre><span class="c1">// redis中预减库存</span>
<span class="n">Long</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">decr</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getMiaoshaGoodsStock</span><span class="o">,</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">goodsId</span><span class="o">);</span>
<span class="k">if</span><span class="o">(</span><span class="n">stock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MIAO_SHA_OVER</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
如果库存本来有10个，有13个请求，库存减少成负的的操作都没必要访问redis。</p>
<p>内存标记，减少redis访问
<div class="codehilite"><pre><span class="c1">// 结束标记 &lt;商品ID,是否秒杀结束&gt;</span>
<span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">localOverMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">&gt;();</span>

<span class="c1">// 系统初始化 读数据库库存，写到redis</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="n">goodslist</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">listGoodsVo</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">goodslist</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
        <span class="k">for</span><span class="o">(</span><span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">:</span> <span class="n">goodslist</span><span class="o">){</span>
            <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getMiaoshaGoodsStock</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">,</span><span class="n">goods</span><span class="o">.</span><span class="na">getStockCount</span><span class="o">()</span> <span class="o">);</span>
            <span class="c1">// 初始化所有商品都没结束</span>
            <span class="n">localOverMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span>  <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Autowired</span>
<span class="n">MiaoshaService</span> <span class="n">miaoshaService</span><span class="o">;</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/do_miaosha&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                   <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">//...</span>
    <span class="c1">// 判断商品结束标记</span>
    <span class="n">Boolean</span> <span class="n">over</span> <span class="o">=</span> <span class="n">localOverMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">over</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MIAO_SHA_OVER</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// redis中预减库存</span>
    <span class="n">Long</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">decr</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getMiaoshaGoodsStock</span><span class="o">,</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">stock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
        <span class="n">localOverMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">goodsId</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">MIAO_SHA_OVER</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//...</span>
<span class="o">}</span>
</pre></div></p>
<p>重置操作：
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;/reset&quot;</span><span class="o">,</span> <span class="n">method</span><span class="o">=</span><span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="nf">reset</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="n">goodsList</span> <span class="o">=</span> <span class="n">goodsService</span><span class="o">.</span><span class="na">listGoodsVo</span><span class="o">();</span>
    <span class="k">for</span><span class="o">(</span><span class="n">GoodVo</span> <span class="n">goods</span> <span class="o">:</span> <span class="n">goodsList</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 库存还原成10个</span>
        <span class="n">goods</span><span class="o">.</span><span class="na">setStockCount</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="c1">// redis中库存也变成10个</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">GoodsKey</span><span class="o">.</span><span class="na">getMiaoshaGoodsStock</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">+</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="mi">10</span><span class="o">);</span>
        <span class="c1">// 内存变量 所有商品重置成没结束</span>
        <span class="n">localOverMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">goods</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 删除用户订单和秒杀标记缓存</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">OrderKey</span><span class="o">.</span><span class="na">getMiaoshaOrderByUidGid</span><span class="o">);</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">MiaoshaKey</span><span class="o">.</span><span class="na">isGoodsOver</span><span class="o">);</span>
    <span class="n">miaoshaService</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">goodsList</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
根据前缀删除redis
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">delete</span><span class="o">(</span><span class="n">KeyPrefix</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">scanKeys</span><span class="o">(</span><span class="n">prefix</span><span class="o">.</span><span class="na">getPrefix</span><span class="o">());</span>
    <span class="k">if</span><span class="o">(</span><span class="n">keys</span><span class="o">==</span><span class="kc">null</span> <span class="o">||</span> <span class="n">keys</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="n">jedis</span><span class="o">.</span><span class="na">del</span><span class="o">(</span><span class="n">keys</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">jedis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">scanKeys</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="n">String</span> <span class="n">cursor</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="o">;</span>
        <span class="n">ScanParams</span> <span class="n">sp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScanParams</span><span class="o">();</span>
        <span class="n">sp</span><span class="o">.</span><span class="na">match</span><span class="o">(</span><span class="s">&quot;*&quot;</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="s">&quot;*&quot;</span><span class="o">);</span>
        <span class="n">sp</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="k">do</span><span class="o">{</span>
            <span class="n">ScanResult</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="n">cursor</span><span class="o">,</span> <span class="n">sp</span><span class="o">);</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="na">getResult</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">result</span><span class="o">!=</span><span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">result</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
                <span class="n">keys</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">//再处理cursor</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="na">getStringCursor</span><span class="o">();</span>
        <span class="o">}</span><span class="k">while</span><span class="o">(!</span><span class="n">cursor</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;0&quot;</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">keys</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">jedis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>mysql数据库中删除订单
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">reset</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">GoodVo</span><span class="o">&gt;</span> <span class="n">goodsList</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">goodsService</span><span class="o">.</span><span class="na">resetStock</span><span class="o">(</span><span class="n">goodsList</span><span class="o">);</span>
    <span class="n">orderService</span><span class="o">.</span><span class="na">deleteOrders</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
dao：
<div class="codehilite"><pre><span class="nd">@Delete</span><span class="o">(</span><span class="s">&quot;delete from order_info&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteOrders</span><span class="o">();</span>

<span class="nd">@Delete</span><span class="o">(</span><span class="s">&quot;delete from miaosha_order&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteMiaoshaOrders</span><span class="o">();</span>
</pre></div>
对<code>/miaosha/do_miaosha</code>压测5000个线程10次 一共5w个请求
在服务器上测试jmeter
1.在windows上录好jmx&hellip;
2.运行<code>jmeter.sh -n -t xxx.jmx -l result.jtl</code>
3.把result.jtl导入jmeter</p>
<p>压测QPS-&gt;2000</p>
<p>nginx 横向扩展（反向代理proxy_pass)配置多台服务器
负载均衡 weight
<img alt="nginx.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/nginx.jpg" />
nginx 缓存
<a href="https://linux.cn/article-5945-1.html">https://linux.cn/article-5945-1.html</a>
<div class="codehilite"><pre>proxy_cache_path /usr/local/nginx/proxy_cache <span class="nv">levels</span><span class="o">=</span>1:2 <span class="nv">keys_zone</span><span class="o">=</span>my_cache:200m <span class="nv">inactive</span><span class="o">=</span>1d <span class="nv">max_size</span><span class="o">=</span>20g<span class="p">;</span>
proxy_ignore_headers x-Accel-Expires Expires Cache-Control<span class="p">;</span>
proxy_hide_header Cache-Control<span class="p">;</span>
proxy_hide_header Pragma<span class="p">;</span>
</pre></div>
LVS负载均衡 已经在linux内核里了
浏览器-LVS-n个nginx-nn个tomcat</p>
<h3 id="_22">安全优化<a class="headerlink" href="#_22" title="Permanent link"></a></h3>
<h4 id="_23">秒杀接口地址隐藏<a class="headerlink" href="#_23" title="Permanent link"></a></h4>
<p>请求服务端秒杀地址，动态生成的
方法：
秒杀接口带上<code>PathVariable</code>，<code>@RequestMapping(value = "/{path}/do_miaosha"</code></p>
<p>前端秒杀按钮获取地址
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary btn-block&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;buyButton&quot;</span><span class="na">onclick</span><span class="o">=</span><span class="s">&quot;getmiaoshaPath()&quot;</span><span class="p">&gt;</span>立即秒杀<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</pre></div></p>
<p>后台path接口：
新建redis key保存随机path，并且设置有效期
<div class="codehilite"><pre><span class="kd">private</span> <span class="nf">MiaoshaKey</span><span class="o">(</span> <span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">,</span> <span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span> <span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MiaoshaKey</span> <span class="n">isGoodsOver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaKey</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="s">&quot;go&quot;</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MiaoshaKey</span> <span class="n">getMiaoshaPath</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaKey</span><span class="o">(</span><span class="mi">60</span><span class="o">,</span> <span class="s">&quot;mp&quot;</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>随机生成path，每个用户，每个商品地址不一样 保存到redis
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/path&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getMiaoShaPath</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span>  <span class="n">miaoshaService</span><span class="o">.</span><span class="na">createMiaoshaPath</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
path生成service方法
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">String</span> <span class="nf">createMiaoshaPath</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">MD5Util</span><span class="o">.</span><span class="na">md5</span><span class="o">(</span><span class="n">UUIDUtil</span><span class="o">.</span><span class="na">uuid</span><span class="o">()+</span><span class="s">&quot;123456&quot;</span><span class="o">);</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">MiaoshaKey</span><span class="o">.</span><span class="na">getMiaoshaPath</span><span class="o">,</span><span class="s">&quot;&quot;</span> <span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span><span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">goodsId</span><span class="o">,</span><span class="n">str</span> <span class="o">);</span>
    <span class="k">return</span> <span class="n">str</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>秒杀接口添加path变量
添加非法请求key result/CodeMsg.java
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">REQUEST_ILLEGAL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500102</span><span class="o">,</span> <span class="s">&quot;请求非法&quot;</span><span class="o">);</span>
</pre></div></p>
<div class="codehilite"><pre><span class="nd">@Autowired</span>
<span class="n">MiaoshaService</span> <span class="n">miaoshaService</span><span class="o">;</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/{path}/do_miaosha&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">list</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                            <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">,</span>
                            <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&quot;path&quot;</span><span class="o">)</span><span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// 没登陆</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//验证path</span>
    <span class="kt">boolean</span> <span class="n">check</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">checkPath</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">,</span><span class="n">path</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">check</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">REQUEST_ILLEGAL</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>

<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkPath</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">path</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">pathRec</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">MiaoshaKey</span><span class="o">.</span><span class="na">getMiaoshaPath</span><span class="o">,</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">goodsId</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span><span class="n">ath</span>
    <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">pathRec</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>

<p>前端的获取path的xhr方法，并且拼接后继续xhr doMiaosha()
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">getMiaoshaPath</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">goodsId</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="c1">// 加载中的动画</span>
    <span class="nx">g_showLoading</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/miaosha/path&quot;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">goodsId</span><span class="o">:</span> <span class="nx">goodsId</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                <span class="nx">doMiaosha</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
            <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;客户端请求有误&quot;</span><span class="p">);}</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">doMiaosha</span><span class="p">(</span><span class="nx">path</span><span class="p">){</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span><span class="s2">&quot;/miaosha/&quot;</span><span class="o">+</span><span class="nx">path</span><span class="o">+</span><span class="s2">&quot;/do_miaosha&quot;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span><span class="p">{</span>
            <span class="nx">goodsId</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="c1">// 成功 排队中 轮询</span>
                <span class="nx">getMiaoshaResult</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;客户端请求有误&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div></p>
<p>完成动态获取秒杀path再秒杀</p>
<h4 id="_24">数学公式验证码<a class="headerlink" href="#_24" title="Permanent link"></a></h4>
<p>点击秒杀之前先输入验证码
<code>ScriptEngine</code> java中可以使用js v8</p>
<p>前端验证码：
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-inline&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">img</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;verifyCodeImg&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;80&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;32&quot;</span>  <span class="na">style</span><span class="o">=</span><span class="s">&quot;display:none&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;refreshVerifyCode()&quot;</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;verifyCode&quot;</span>  <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-control&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display:none&quot;</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;button&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;buyButton&quot;</span><span class="na">onclick</span><span class="o">=</span><span class="s">&quot;getMiaoshaPath()&quot;</span><span class="p">&gt;</span>立即秒杀<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div></p>
<p>页面初始化渲染render完页面后，在countDown方法里，生成验证码
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">countDown</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">remainSeconds</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#remainSeconds&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">timeout</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">remainSeconds</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span><span class="c1">//秒杀还没开始，倒计时</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#buyButton&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#miaoshaTip&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;秒杀倒计时：&quot;</span><span class="o">+</span><span class="nx">remainSeconds</span><span class="o">+</span><span class="s2">&quot;秒&quot;</span><span class="p">);</span>
        <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#countDown&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">remainSeconds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#remainSeconds&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">remainSeconds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nx">countDown</span><span class="p">();</span>
        <span class="p">},</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">remainSeconds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span><span class="c1">//秒杀进行中</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#buyButton&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">timeout</span><span class="p">){</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#miaoshaTip&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;秒杀进行中&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#verifyCodeImg&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span><span class="s2">&quot;/miaosha/verifyCode?goodsId=&quot;</span><span class="o">+</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#verifyCodeImg&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#verifyCode&quot;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="c1">//秒杀已经结束</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#buyButton&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;disabled&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#miaoshaTip&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;秒杀已经结束&quot;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#verifyCodeImg&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#verifyCode&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></p>
<p>后台验证码接口</p>
<p>生成验证码
后台验证码redis key
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">MiaoshaKey</span> <span class="n">getMiaoshaVerifyCode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MiaoshaKey</span><span class="o">(</span><span class="mi">300</span><span class="o">,</span> <span class="s">&quot;vc&quot;</span><span class="o">);</span>
</pre></div>
添加秒杀失败msg
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">MIAOSHA_FAIL</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500502</span><span class="o">,</span> <span class="s">&quot;秒杀失败&quot;</span><span class="o">);</span>
</pre></div></p>
<p>验证码接口 直接写到output上
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/verifyCode&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getVerifyCode</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span> <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">BufferedImage</span> <span class="n">image</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">createVerifyCode</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="n">ImageIO</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">image</span><span class="o">,</span> <span class="s">&quot;JPEG&quot;</span><span class="o">,</span> <span class="n">out</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>service：用Graphics生成图片
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">BufferedImage</span> <span class="nf">createVerifyCode</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">goodsId</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="o">){</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">80</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">32</span><span class="o">;</span>
    <span class="c1">//create the image</span>
    <span class="n">BufferedImage</span> <span class="n">image</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedImage</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">,</span> <span class="n">BufferedImage</span><span class="o">.</span><span class="na">TYPE_INT_RGB</span><span class="o">);</span>
    <span class="n">Graphics</span> <span class="n">g</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="na">getGraphics</span><span class="o">();</span>
    <span class="c1">// set the background color</span>
    <span class="n">g</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="k">new</span> <span class="n">Color</span><span class="o">(</span><span class="mh">0xDCDCDC</span><span class="o">));</span>
    <span class="n">g</span><span class="o">.</span><span class="na">fillRect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">);</span>
    <span class="c1">// draw the border</span>
    <span class="n">g</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">black</span><span class="o">);</span>
    <span class="n">g</span><span class="o">.</span><span class="na">drawRect</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
    <span class="c1">// create a random instance to generate the codes</span>
    <span class="n">Random</span> <span class="n">rdm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
    <span class="c1">// make some confusion</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">width</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">height</span><span class="o">);</span>
        <span class="n">g</span><span class="o">.</span><span class="na">drawOval</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 生成随机验证码 保存到key为用户,商品id用于用户输入的验证</span>
    <span class="n">String</span> <span class="n">verifyCode</span> <span class="o">=</span> <span class="n">generateVerifyCode</span><span class="o">(</span><span class="n">rdm</span><span class="o">);</span>
    <span class="n">g</span><span class="o">.</span><span class="na">setColor</span><span class="o">(</span><span class="k">new</span> <span class="n">Color</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
    <span class="n">g</span><span class="o">.</span><span class="na">setFont</span><span class="o">(</span><span class="k">new</span> <span class="n">Font</span><span class="o">(</span><span class="s">&quot;Candara&quot;</span><span class="o">,</span> <span class="n">Font</span><span class="o">.</span><span class="na">BOLD</span><span class="o">,</span> <span class="mi">24</span><span class="o">));</span>
    <span class="n">g</span><span class="o">.</span><span class="na">drawString</span><span class="o">(</span><span class="n">verifyCode</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">24</span><span class="o">);</span>
    <span class="n">g</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
    <span class="c1">//把验证码存到redis中</span>
    <span class="kt">int</span> <span class="n">rnd</span> <span class="o">=</span> <span class="n">calc</span><span class="o">(</span><span class="n">verifyCode</span><span class="o">);</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">MiaoshaKey</span><span class="o">.</span><span class="na">getMiaoshaVerifyCode</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()+</span><span class="s">&quot;,&quot;</span><span class="o">+</span><span class="n">goodsId</span><span class="o">,</span> <span class="n">rnd</span><span class="o">);</span>
    <span class="c1">//输出图片  </span>
    <span class="k">return</span> <span class="n">image</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// 计算表达式的结果</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">calc</span><span class="o">(</span><span class="n">String</span> <span class="n">exp</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span><span class="o">{</span>
        <span class="n">ScriptEngineManager</span> <span class="n">manger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ScriptEngineManager</span><span class="o">();</span>
        <span class="n">ScriptEngine</span> <span class="n">engine</span> <span class="o">=</span> <span class="n">manger</span><span class="o">.</span><span class="na">getEngineByName</span><span class="o">(</span><span class="s">&quot;JavaScript&quot;</span><span class="o">);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span><span class="n">engine</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="n">exp</span><span class="o">);</span>
    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">char</span><span class="o">[]</span> <span class="n">ops</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[]</span> <span class="o">{</span><span class="sc">&#39;+&#39;</span><span class="o">,</span> <span class="sc">&#39;-&#39;</span><span class="o">,</span> <span class="sc">&#39;*&#39;</span><span class="o">};</span>
<span class="c1">// 加减乘的验证码</span>
<span class="kd">private</span> <span class="n">String</span> <span class="nf">generateVerifyCode</span><span class="o">(</span><span class="n">Random</span> <span class="n">rdm</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">num1</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">num2</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">num3</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="kt">char</span> <span class="n">op1</span> <span class="o">=</span> <span class="n">ops</span><span class="o">[</span><span class="n">rdm</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">3</span><span class="o">)];</span>
    <span class="kt">char</span> <span class="n">op2</span> <span class="o">=</span> <span class="n">ops</span><span class="o">[</span><span class="n">rdm</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">3</span><span class="o">)];</span>
    <span class="n">String</span> <span class="n">exp</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">+</span> <span class="n">num1</span> <span class="o">+</span> <span class="n">op1</span> <span class="o">+</span> <span class="n">num2</span> <span class="o">+</span> <span class="n">op2</span> <span class="o">+</span> <span class="n">num3</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">exp</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>已经可以显示了</p>
<p>添加点击事件重新渲染验证码, 注意浏览器图片缓存
<div class="codehilite"><pre><span class="p">&lt;</span><span class="nt">img</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;verifyCodeImg&quot;</span> <span class="na">width</span><span class="o">=</span><span class="s">&quot;80&quot;</span> <span class="na">height</span><span class="o">=</span><span class="s">&quot;32&quot;</span>  <span class="na">style</span><span class="o">=</span><span class="s">&quot;display:none&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;refreshVerifyCode()&quot;</span><span class="p">/&gt;</span>
</pre></div></p>
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">refreshVerifyCode</span><span class="p">(){</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#verifyCodeImg&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;/miaosha/verifyCode?goodsId=&quot;</span><span class="o">+</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;&amp;timestamp=&quot;</span><span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>

<p><img alt="miaoshaverficode.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/miaoshaverficode.jpg" /></p>
<p>点击秒杀 获取秒杀地址之前校验验证码
修改后台path接口，
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/path&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getMiaoShaPath</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                                     <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">,</span>
                                     <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;verifyCode&quot;</span><span class="o">)</span><span class="kt">int</span> <span class="n">verify</span><span class="o">){</span>
    <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="n">check</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">checkVerifyCode</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">,</span><span class="n">verify</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">check</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">REQUEST_ILLEGAL</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span>  <span class="n">miaoshaService</span><span class="o">.</span><span class="na">createMiaoshaPath</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>service：
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">checkVerifyCode</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span> <span class="kt">long</span> <span class="n">goodsId</span><span class="o">,</span> <span class="kt">int</span> <span class="n">verify</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">goodsId</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="o">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">Integer</span> <span class="n">codeOld</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">MiaoshaKey</span><span class="o">.</span><span class="na">getMiaoshaVerifyCode</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">goodsId</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">codeOld</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">codeOld</span> <span class="o">-</span> <span class="n">verify</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 从redis删除 否则还可以用</span>
    <span class="n">redisService</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="n">MiaoshaKey</span><span class="o">.</span><span class="na">getMiaoshaVerifyCode</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">goodsId</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></div></p>
<p>前端获取path的时候传入 输入的验证码
<div class="codehilite"><pre><span class="kd">function</span> <span class="nx">getMiaoshaPath</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">goodsId</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#goodsId&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="c1">// 加载中的动画</span>
    <span class="nx">g_showLoading</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/miaosha/path&quot;</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">goodsId</span><span class="o">:</span> <span class="nx">goodsId</span><span class="p">,</span>
            <span class="nx">verifyCode</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#verifyCode&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
        <span class="p">},</span>
        <span class="nx">success</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                <span class="nx">doMiaosha</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
            <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                <span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span><span class="nx">layer</span><span class="p">.</span><span class="nx">msg</span><span class="p">(</span><span class="s2">&quot;客户端请求有误&quot;</span><span class="p">);}</span>

        <span class="p">});</span>
<span class="p">}</span>
</pre></div></p>
<p>可以删除全部的Model了因为前后端分离了。</p>
<h4 id="_25">接口限流<a class="headerlink" href="#_25" title="Permanent link"></a></h4>
<p>防止有用户写前端写for循环xhr
用缓存的有效期,key是用户访问的地址+用户id
新建限流key
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccessKey</span> <span class="kd">extends</span> <span class="n">BasePrefix</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nf">AccessKey</span><span class="o">(</span> <span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">,</span> <span class="n">String</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span> <span class="n">prefix</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 比枚举好 因为可以new一个动态参数的</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">AccessKey</span> <span class="nf">withExpire</span><span class="o">(</span><span class="kt">int</span> <span class="n">expireSeconds</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">AccessKey</span><span class="o">(</span><span class="n">expireSeconds</span><span class="o">,</span> <span class="s">&quot;access&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
request里的
getURI<code>/miaosha/path</code>：the part of this request&rsquo;s URL from the protocol name up to the query string in the first line of the HTTP request.
getURL<code>http://localhost:8022/miaosha/path</code>：The returned URL contains a protocol, server name, port number, and server path, but it does not include query string parameters.</p>
<p>添加访问太频繁的错误
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">CodeMsg</span> <span class="n">ACCESS_LIMIT_REACHED</span><span class="o">=</span> <span class="k">new</span> <span class="n">CodeMsg</span><span class="o">(</span><span class="mi">500104</span><span class="o">,</span> <span class="s">&quot;访问太频繁！&quot;</span><span class="o">);</span>
</pre></div></p>
<div class="codehilite"><pre><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/path&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getMiaoShaPath</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
                                     <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">,</span>
                                     <span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;verifyCode&quot;</span><span class="o">,</span><span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="o">)</span><span class="kt">int</span> <span class="n">verify</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>
    <span class="c1">//限流</span>
    <span class="n">String</span> <span class="n">acKey</span> <span class="o">=</span> <span class="n">uri</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="n">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">AccessKey</span><span class="o">.</span><span class="na">withExpire</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">acKey</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">AccessKey</span><span class="o">.</span><span class="na">withExpire</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">acKey</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">){</span>
        <span class="n">redisService</span><span class="o">.</span><span class="na">incr</span><span class="o">(</span><span class="n">AccessKey</span><span class="o">.</span><span class="na">withExpire</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">acKey</span><span class="o">);</span>
    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">ACCESS_LIMIT_REACHED</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 验证码</span>
    <span class="kt">boolean</span> <span class="n">check</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">checkVerifyCode</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">,</span><span class="n">verify</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">check</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">REQUEST_ILLEGAL</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">String</span> <span class="n">path</span> <span class="o">=</span>  <span class="n">miaoshaService</span><span class="o">.</span><span class="na">createMiaoshaPath</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>

<h4 id="_26">使用拦截器（注解）抽取限流功能（因为不是业务代码）<a class="headerlink" href="#_26" title="Permanent link"></a></h4>
<p>实现效果:5秒最多访问5次 需要登陆
<code>@AccessLimit(seconds=5, maxCount=5, needLogin=true)</code></p>
<p>新建access包
新建注解
<div class="codehilite"><pre><span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="n">METHOD</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">AccessLimit</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="nf">seconds</span><span class="o">();</span>
    <span class="kt">int</span> <span class="nf">maxCount</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="nf">needLogin</span><span class="o">()</span> <span class="k">default</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
新建拦截器顺便解析用户保存到线程 并更新之前 ArgumentResolver参数解析器实现的登陆
拦截器比参数解析先执行，一个请求接收到之后是一个线程在执行。
拦截器实现
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccessIntercepter</span> <span class="kd">extends</span> <span class="n">HandlerInterceptorAdapter</span><span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">MiaoshaUserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">RedisService</span> <span class="n">redisService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">preHandle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">Object</span> <span class="n">handler</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
       <span class="k">if</span><span class="o">(</span><span class="n">handler</span> <span class="k">instanceof</span> <span class="n">HandlerMethod</span><span class="o">){</span>
           <span class="c1">// 1. 取用户</span>
           <span class="n">MiaoshaUser</span> <span class="n">user</span> <span class="o">=</span> <span class="n">getUser</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
           <span class="c1">// 2. 用户存到threadlocal</span>
           <span class="n">UserContext</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
           <span class="c1">// 3. 获取注解参数</span>
           <span class="n">HandlerMethod</span> <span class="n">hm</span> <span class="o">=</span> <span class="o">(</span><span class="n">HandlerMethod</span><span class="o">)</span><span class="n">handler</span><span class="o">;</span>
           <span class="n">AccessLimit</span> <span class="n">accessLimit</span> <span class="o">=</span> <span class="n">hm</span><span class="o">.</span><span class="na">getMethodAnnotation</span><span class="o">(</span><span class="n">AccessLimit</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
           <span class="k">if</span><span class="o">(</span><span class="n">accessLimit</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
               <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
           <span class="o">}</span>
           <span class="kt">int</span> <span class="n">second</span> <span class="o">=</span> <span class="n">accessLimit</span><span class="o">.</span><span class="na">seconds</span><span class="o">();</span>
           <span class="kt">int</span> <span class="n">maxcount</span> <span class="o">=</span> <span class="n">accessLimit</span><span class="o">.</span><span class="na">maxCount</span><span class="o">();</span>
           <span class="kt">boolean</span> <span class="n">needLogin</span> <span class="o">=</span> <span class="n">accessLimit</span><span class="o">.</span><span class="na">needLogin</span><span class="o">();</span>

           <span class="c1">// 限制访问的key</span>
           <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>

           <span class="c1">// 如果用户没登陆</span>
           <span class="k">if</span><span class="o">(</span><span class="n">needLogin</span><span class="o">){</span>
               <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                   <span class="n">render</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
                   <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
               <span class="o">}</span>
               <span class="c1">// 如果需要登陆 key + 用户id</span>
               <span class="n">key</span> <span class="o">+=</span> <span class="s">&quot;_&quot;</span><span class="o">+</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
           <span class="o">}</span>
           <span class="c1">// else key就只有path</span>
           <span class="n">AccessKey</span> <span class="n">ak</span> <span class="o">=</span> <span class="n">AccessKey</span><span class="o">.</span><span class="na">withExpire</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
           <span class="n">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">redisService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ak</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
           <span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
               <span class="n">redisService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">ak</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
           <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">maxcount</span><span class="o">){</span>
               <span class="n">redisService</span><span class="o">.</span><span class="na">incr</span><span class="o">(</span><span class="n">ak</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
           <span class="o">}</span><span class="k">else</span><span class="o">{</span>
               <span class="n">render</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">CodeMsg</span><span class="o">.</span><span class="na">ACCESS_LIMIT_REACHED</span><span class="o">);</span>
               <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
           <span class="o">}</span>
       <span class="o">}</span>
       <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">render</span><span class="o">(</span><span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">CodeMsg</span> <span class="n">cm</span><span class="o">)</span><span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&quot;application/json;charset=UTF-8&quot;</span><span class="o">);</span>
        <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">str</span>  <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">cm</span><span class="o">));</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">&quot;UTF-8&quot;</span><span class="o">));</span>
        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="n">MiaoshaUser</span> <span class="nf">getUser</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">paramToken</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">MiaoshaUserService</span><span class="o">.</span><span class="na">COOKI_NAME_TOKEN</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">cookieToken</span> <span class="o">=</span> <span class="n">getCookieValue</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">MiaoshaUserService</span><span class="o">.</span><span class="na">COOKI_NAME_TOKEN</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">cookieToken</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">paramToken</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">paramToken</span><span class="o">)?</span><span class="n">cookieToken</span><span class="o">:</span><span class="n">paramToken</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getByToken</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">token</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getCookieValue</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">String</span> <span class="n">cookiName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Cookie</span><span class="o">[]</span>  <span class="n">cookies</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getCookies</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">cookies</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">cookies</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">for</span><span class="o">(</span><span class="n">Cookie</span> <span class="n">cookie</span> <span class="o">:</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">cookiName</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">cookie</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>WebConfig中注册拦截器：
<div class="codehilite"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfig</span>  <span class="kd">extends</span> <span class="n">WebMvcConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">UserArgumentResolver</span> <span class="n">userArgumentResolver</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">AccessIntercepter</span> <span class="n">accessIntercepter</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addInterceptors</span><span class="o">(</span><span class="n">InterceptorRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="n">accessIntercepter</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addArgumentResolvers</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">HandlerMethodArgumentResolver</span><span class="o">&gt;</span> <span class="n">argumentResolvers</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">argumentResolvers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">userArgumentResolver</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>在拦截器里就解析用户并保存到线程：
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserContext</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">MiaoshaUser</span><span class="o">&gt;</span> <span class="n">userHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadLocal</span><span class="o">&lt;</span><span class="n">MiaoshaUser</span><span class="o">&gt;();</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setUser</span><span class="o">(</span><span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MiaoshaUser</span> <span class="nf">getUser</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>之前的参数解析器，直接从线程中获取
<div class="codehilite"><pre><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserArgumentResolver</span> <span class="kd">implements</span> <span class="n">HandlerMethodArgumentResolver</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="n">MiaoshaUserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supportsParameter</span><span class="o">(</span><span class="n">MethodParameter</span> <span class="n">parameter</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 获取参数类型 是User类型才会做resolveArgument</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">parameter</span><span class="o">.</span><span class="na">getParameterType</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">clazz</span><span class="o">==</span><span class="n">MiaoshaUser</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">resolveArgument</span><span class="o">(</span><span class="n">MethodParameter</span> <span class="n">parameter</span><span class="o">,</span> <span class="n">ModelAndViewContainer</span> <span class="n">mavContainer</span><span class="o">,</span>
                                  <span class="n">NativeWebRequest</span> <span class="n">webRequest</span><span class="o">,</span> <span class="n">WebDataBinderFactory</span> <span class="n">binderFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">UserContext</span><span class="o">.</span><span class="na">getUser</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<p>最后注解使用结果
<div class="codehilite"><pre><span class="nd">@AccessLimit</span><span class="o">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span><span class="n">maxCount</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span><span class="n">needLogin</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/path&quot;</span><span class="o">,</span><span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
    <span class="nd">@ResponseBody</span>
    <span class="kd">public</span> <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getMiaoShaPath</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
        <span class="n">MiaoshaUser</span> <span class="n">user</span><span class="o">,</span>
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;goodsId&quot;</span><span class="o">)</span><span class="kt">long</span> <span class="n">goodsId</span><span class="o">,</span> 
        <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">&quot;verifyCode&quot;</span><span class="o">)</span><span class="kt">int</span> <span class="n">verify</span><span class="o">){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">SESSION_ERROR</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestURI</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;uri&quot;</span><span class="o">+</span><span class="n">uri</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;url&quot;</span><span class="o">+</span><span class="n">request</span><span class="o">.</span><span class="na">getRequestURL</span><span class="o">());</span>
        <span class="c1">// 验证码</span>
        <span class="kt">boolean</span> <span class="n">check</span> <span class="o">=</span> <span class="n">miaoshaService</span><span class="o">.</span><span class="na">checkVerifyCode</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">,</span><span class="n">verify</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">check</span><span class="o">){</span>
            <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">CodeMsg</span><span class="o">.</span><span class="na">REQUEST_ILLEGAL</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">path</span> <span class="o">=</span>  <span class="n">miaoshaService</span><span class="o">.</span><span class="na">createMiaoshaPath</span><span class="o">(</span><span class="n">user</span><span class="o">,</span><span class="n">goodsId</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Result</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>
<img alt="jmeter-csvdata.jpg" src="https://iota-1254040271.cos.ap-shanghai.myqcloud.com/image/jmeter-csvdata.jpg" /></p></article></body></html>